<!DOCTYPE html>
<html lang="vi-vn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Analyzing CVE-2024-34750 Apache Tomcat DoS | devme4f&#39;s blog</title>
  <link rel = 'canonical' href = 'https://devme4f.github.io/posts/2024/analyzing-cve-2024-34750-tomcat-dos/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Analyzing CVE-2024-34750 Apache Tomcat DoS" />
<meta property="og:description" content="Preface Bài viết sẽ phân tích lại CVE-2024-34750, CVE mà mình tìm được gần đây. Về web server Tomcat chắc cũng không còn phải giới thiệu nhiều, trong các ứng dụng java web servlet hay spring framework thì tomcat luôn là server được lựa chọn để deploy phổ biến nhất cho đến nay.
Nói ngắn gọn, CVE-2024-34750 cho phép DoS sập HTTP/2 connector của tomcat bằng cách trigger lỗi StreamException làm giá trị activeRemoteStreamCount bị đếm sai dẫn đến connection timeout bị set vô thời hạn (connection không được đóng sau khi xử lý xong)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devme4f.github.io/posts/2024/analyzing-cve-2024-34750-tomcat-dos/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-16T20:01:01+07:00" />
<meta property="article:modified_time" content="2024-08-16T20:01:01+07:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Analyzing CVE-2024-34750 Apache Tomcat DoS"/>
<meta name="twitter:description" content="Preface Bài viết sẽ phân tích lại CVE-2024-34750, CVE mà mình tìm được gần đây. Về web server Tomcat chắc cũng không còn phải giới thiệu nhiều, trong các ứng dụng java web servlet hay spring framework thì tomcat luôn là server được lựa chọn để deploy phổ biến nhất cho đến nay.
Nói ngắn gọn, CVE-2024-34750 cho phép DoS sập HTTP/2 connector của tomcat bằng cách trigger lỗi StreamException làm giá trị activeRemoteStreamCount bị đếm sai dẫn đến connection timeout bị set vô thời hạn (connection không được đóng sau khi xử lý xong)."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://devme4f.github.io/css/styles.a7dd5af4c7ef9f93fb31b1147bb343d14667fd6cdafa7ae17de8d923a2f6a282b9db99fd91500efb76d5de5a5603d29fb153733d9bfac95b534e595d0ab745a7.css" integrity="sha512-p91a9Mfvn5P7MbEUe7ND0UZn/Wza&#43;nrhfejZI6L2ooK525n9kVAO&#43;3bV3lpWA9KfsVNzPZv6yVtTTlldCrdFpw=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://devme4f.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/notes">Notes</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://devme4f.github.io/about/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://devme4f.github.io/posts/2024/spring-boot-fat-jar-file-writing-rce/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&text=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&title=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&is_video=false&description=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&title=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&title=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&name=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS&description=Preface%20B%c3%a0i%20vi%e1%ba%bft%20s%e1%ba%bd%20ph%c3%a2n%20t%c3%adch%20l%e1%ba%a1i%20CVE-2024-34750%2c%20CVE%20m%c3%a0%20m%c3%acnh%20t%c3%acm%20%c4%91%c6%b0%e1%bb%a3c%20g%e1%ba%a7n%20%c4%91%c3%a2y.%20V%e1%bb%81%20web%20server%20Tomcat%20ch%e1%ba%afc%20c%c5%a9ng%20kh%c3%b4ng%20c%c3%b2n%20ph%e1%ba%a3i%20gi%e1%bb%9bi%20thi%e1%bb%87u%20nhi%e1%bb%81u%2c%20trong%20c%c3%a1c%20%e1%bb%a9ng%20d%e1%bb%a5ng%20java%20web%20servlet%20hay%20spring%20framework%20th%c3%ac%20tomcat%20lu%c3%b4n%20l%c3%a0%20server%20%c4%91%c6%b0%e1%bb%a3c%20l%e1%bb%b1a%20ch%e1%bb%8dn%20%c4%91%e1%bb%83%20deploy%20ph%e1%bb%95%20bi%e1%ba%bfn%20nh%e1%ba%a5t%20cho%20%c4%91%e1%ba%bfn%20nay.%0aN%c3%b3i%20ng%e1%ba%afn%20g%e1%bb%8dn%2c%20CVE-2024-34750%20cho%20ph%c3%a9p%20DoS%20s%e1%ba%adp%20HTTP%2f2%20connector%20c%e1%bb%a7a%20tomcat%20b%e1%ba%b1ng%20c%c3%a1ch%20trigger%20l%e1%bb%97i%20StreamException%20l%c3%a0m%20gi%c3%a1%20tr%e1%bb%8b%20activeRemoteStreamCount%20b%e1%bb%8b%20%c4%91%e1%ba%bfm%20sai%20d%e1%ba%abn%20%c4%91%e1%ba%bfn%20connection%20timeout%20b%e1%bb%8b%20set%20v%c3%b4%20th%e1%bb%9di%20h%e1%ba%a1n%20%28connection%20kh%c3%b4ng%20%c4%91%c6%b0%e1%bb%a3c%20%c4%91%c3%b3ng%20sau%20khi%20x%e1%bb%ad%20l%c3%bd%20xong%29." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&t=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#setup">Setup</a></li>
    <li><a href="#analysis">Analysis</a>
      <ul>
        <li><a href="#http2upgradehandlerupgradedispatch">Http2UpgradeHandler#upgradeDispatch()</a></li>
        <li><a href="#headers-frame">Headers Frame</a></li>
      </ul>
    </li>
    <li><a href="#break-the-logic">Break the logic</a></li>
    <li><a href="#poc">PoC</a></li>
    <li><a href="#fix">Fix</a></li>
    <li><a href="#thoughts">Thoughts</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Analyzing CVE-2024-34750 Apache Tomcat DoS
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2024-08-16 20:01:01 &#43;0700 &#43;07" itemprop="datePublished">2024-08-16</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/research" rel="tag">research</a>
            
             ,  
            <a class="tag-link" href="/tags/cve" rel="tag">cve</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p><img src="/images/2024/Analyzing-CVE-2024-34750-Tomcat-DoS/images.png" alt="images"></p>
<h2 id="preface">Preface</h2>
<p>Bài viết sẽ phân tích lại CVE-2024-34750, CVE mà mình tìm được gần đây. Về web server Tomcat chắc cũng không còn phải giới thiệu nhiều, trong các ứng dụng java web servlet hay spring framework thì tomcat luôn là server được lựa chọn để deploy phổ biến nhất cho đến nay.</p>
<p>Nói ngắn gọn, CVE-2024-34750 cho phép DoS sập HTTP/2 connector của tomcat bằng cách trigger lỗi <code>StreamException</code> làm giá trị <code>activeRemoteStreamCount</code> bị đếm sai dẫn đến connection timeout bị set vô thời hạn (connection không được đóng sau khi xử lý xong). Khi số lượng connection được mở đạt đến giới hạn, tomcat connector không thể handle thêm request dẫn đến DoS.</p>
<p>Bài viết yêu cầu người đọc có hiểu biết basic về giao thức HTTP/2, có thể tham khảo chuẩn RFC: <a href="https://datatracker.ietf.org/doc/html/rfc9113">https://datatracker.ietf.org/doc/html/rfc9113</a></p>
<p><strong>Versions affect</strong>:</p>
<pre tabindex="0"><code>Apache Tomcat 11.0.0-M1 to 11.0.0-M20
Apache Tomcat 10.1.0-M1 to 10.1.24
Apache Tomcat 9.0.0-M1 to 9.0.89
....và các versions cũ hơn mà apache không còn support
</code></pre><p><strong>Conditions</strong>: Sử dụng giao thức HTTP/2 của tomcat (connector)
<strong>Advisory</strong>: <a href="https://lists.apache.org/thread/4kqf0bc9gxymjc2x7v3p7dvplnl77y8l">https://lists.apache.org/thread/4kqf0bc9gxymjc2x7v3p7dvplnl77y8l</a></p>
<p><strong>Http2 Notes</strong>:</p>
<ul>
<li>Connection: Http2 connection hay đúng hơn là TCP connection</li>
<li>Stream: Stream là một khối data chứa một hoặc nhiều các frames được gửi đi trong connection</li>
<li>Frame: Là một frame data theo chuẩn RFC ứng với các thành phần trong http / events như HEADERS, CONTINUATION, DATA, SETTINGS frames</li>
</ul>
<h2 id="setup">Setup</h2>
<p>Tại <code>&lt;tomcat-home&gt;/conf/server.xml</code> uncomment block sau để enable HTTP/2 connector:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Connector</span> <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#34;8443&#34;</span> <span style="color:#a6e22e">protocol=</span><span style="color:#e6db74">&#34;org.apache.coyote.http11.Http11NioProtocol&#34;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">maxThreads=</span><span style="color:#e6db74">&#34;150&#34;</span> <span style="color:#a6e22e">SSLEnabled=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;UpgradeProtocol</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.coyote.http2.Http2Protocol&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;SSLHostConfig&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;Certificate</span> <span style="color:#a6e22e">certificateKeystoreFile=</span><span style="color:#e6db74">&#34;conf/localhost-rsa.jks&#34;</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;RSA&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/SSLHostConfig&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Connector&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>conf/localhost-rsa.jks</code> có thể lấy từ <a href="https://github.com/apache/tomcat/raw/main/test/org/apache/tomcat/util/net/localhost-rsa.jks">đây</a></p>
<h2 id="analysis">Analysis</h2>
<h3 id="http2upgradehandlerupgradedispatch">Http2UpgradeHandler#upgradeDispatch()</h3>
<p>Đầu tiên đến với <code>Http2UpgradeHandler#upgradeDispatch()</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> SocketState <span style="color:#a6e22e">upgradeDispatch</span><span style="color:#f92672">(</span>SocketEvent status<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>log<span style="color:#f92672">.</span><span style="color:#a6e22e">isTraceEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span><span style="color:#a6e22e">trace</span><span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;upgradeHandler.upgradeDispatch.entry&#34;</span><span style="color:#f92672">,</span> connectionId<span style="color:#f92672">,</span> status<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// WebConnection is not used so passing null here is fine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Might not be necessary. init() will handle that.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    init<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SocketState result <span style="color:#f92672">=</span> SocketState<span style="color:#f92672">.</span><span style="color:#a6e22e">CLOSED</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>status<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> OPEN_READ<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                socketWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>socketWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">canWrite</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// Only send a ping if there is no other data waiting to be sent.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#75715e">// Ping manager will ensure they aren&#39;t sent too frequently.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        pingManager<span style="color:#f92672">.</span><span style="color:#a6e22e">sendPing</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    socketWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">getLock</span><span style="color:#f92672">().</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Disable the connection timeout while frames are processed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    setConnectionTimeout<span style="color:#f92672">(-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>parser<span style="color:#f92672">.</span><span style="color:#a6e22e">readFrame</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>StreamException se<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#75715e">// Log the Stream error but not necessarily all of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                            <span style="color:#75715e">// them
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                            UserDataHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">Mode</span> logMode <span style="color:#f92672">=</span> userDataHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">getNextMode</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logMode <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                String message <span style="color:#f92672">=</span> sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;upgradeHandler.stream.error&#34;</span><span style="color:#f92672">,</span> connectionId<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                        Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span>se<span style="color:#f92672">.</span><span style="color:#a6e22e">getStreamId</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>logMode<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">case</span> INFO_THEN_DEBUG<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                        message <span style="color:#f92672">+=</span> sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;upgradeHandler.fallToDebug&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#75715e">//$FALL-THROUGH$
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                    <span style="color:#66d9ef">case</span> INFO<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                        log<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span>message<span style="color:#f92672">,</span> se<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">case</span> DEBUG<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>                                        log<span style="color:#f92672">.</span><span style="color:#a6e22e">debug</span><span style="color:#f92672">(</span>message<span style="color:#f92672">,</span> se<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#75715e">// Stream errors are not fatal to the connection so
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                            <span style="color:#75715e">// continue reading frames
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                            Stream stream <span style="color:#f92672">=</span> getStream<span style="color:#f92672">(</span>se<span style="color:#f92672">.</span><span style="color:#a6e22e">getStreamId</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stream <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                sendStreamReset<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> se<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                stream<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">(</span>se<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isOverheadLimitExceeded<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConnectionException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                                        sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;upgradeHandler.tooMuchOverhead&#34;</span><span style="color:#f92672">,</span> connectionId<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>                                        Http2Error<span style="color:#f92672">.</span><span style="color:#a6e22e">ENHANCE_YOUR_CALM</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Need to know the correct timeout before starting the read
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#75715e">// but that may not be known at this time if one or more
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#75715e">// requests are currently being processed so don&#39;t set a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    <span style="color:#75715e">// timeout for the socket...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    socketWrapper<span style="color:#f92672">.</span><span style="color:#a6e22e">setReadTimeout</span><span style="color:#f92672">(-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// ...set a timeout on the connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    setConnectionTimeoutForStreamCount<span style="color:#f92672">(</span>activeRemoteStreamCount<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// .....truncated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tất cả các http2 frame của client đều đi qua method này để phân loại và xử lý. Connection sẽ được set timeout vô thời hạn trong quá trình xử lý các frame này (line 27, giá trị <code>-1</code> ứng với vô thời hạn). Các frame có thể đến từ nhiều streams khác nhau, sau khi đọc hết tất cả các frame, tại line 75 gọi <code>setConnectionTimeoutForStreamCount()</code>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setConnectionTimeoutForStreamCount</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> streamCount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>streamCount <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// No streams currently active. Use the keep-alive
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// timeout for the connection.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> keepAliveTimeout <span style="color:#f92672">=</span> protocol<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeepAliveTimeout</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>keepAliveTimeout <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            setConnectionTimeout<span style="color:#f92672">(-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            setConnectionTimeout<span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> keepAliveTimeout<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Streams currently active. Individual streams have
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// timeouts so keep the connection open.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        setConnectionTimeout<span style="color:#f92672">(-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Để kiểm tra còn active stream nào tồn tại cần xử lý tiếp không, nếu không (ứng với line 2-10) sẽ thực hiện set timeout cho connection (default: <code>protocol.getKeepAliveTimeout()</code> ~ <code>20000ms</code>). Nếu vẫn còn (line 11-15) tiếp tục set timeout vô hạn để tiếp tục xử lý.</p>
<h3 id="headers-frame">Headers Frame</h3>
<p>Một Frame chính trong http2 request mà không thể thiếu đó chính là Headers Frame, khi tomcat parse frame này tại <code>Http2Parser#readHeadersFrame()</code> có 2 nơi cần chú ý:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readHeadersFrame</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> streamId<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> flags<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> payloadSize<span style="color:#f92672">,</span> ByteBuffer buffer<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throws</span> Http2Exception<span style="color:#f92672">,</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    headersEndStream <span style="color:#f92672">=</span> Flags<span style="color:#f92672">.</span><span style="color:#a6e22e">isEndOfStream</span><span style="color:#f92672">(</span>flags<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hpackDecoder <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        hpackDecoder <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span><span style="color:#a6e22e">getHpackDecoder</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        hpackDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeaderEmitter</span><span style="color:#f92672">(</span>output<span style="color:#f92672">.</span><span style="color:#a6e22e">headersStart</span><span style="color:#f92672">(</span>streamId<span style="color:#f92672">,</span> headersEndStream<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>StreamException se<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        swallowPayload<span style="color:#f92672">(</span>streamId<span style="color:#f92672">,</span> FrameType<span style="color:#f92672">.</span><span style="color:#a6e22e">HEADERS</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">(),</span> payloadSize<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">,</span> buffer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> se<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// .. truncated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    readHeaderPayload<span style="color:#f92672">(</span>streamId<span style="color:#f92672">,</span> payloadSize<span style="color:#f92672">,</span> buffer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    swallowPayload<span style="color:#f92672">(</span>streamId<span style="color:#f92672">,</span> FrameType<span style="color:#f92672">.</span><span style="color:#a6e22e">HEADERS</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">(),</span> padLength<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> buffer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Validate the headers so far
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    hpackDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeaderEmitter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">validateHeaders</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>Flags<span style="color:#f92672">.</span><span style="color:#a6e22e">isEndOfHeaders</span><span style="color:#f92672">(</span>flags<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        onHeadersComplete<span style="color:#f92672">(</span>streamId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        headersCurrentStream <span style="color:#f92672">=</span> streamId<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tại line 10 sẽ khởi tạo stream mới thông qua <code>Http2UpgradeHandler#headersStart()</code> để lưu / xử lý headers, cũng như sau khi đọc hết header data (line 18), sẽ gọi lần lượt <code>onHeadersComplete()</code> (line 26)&ndash;&gt; <code>Http2UpgradeHandler#headersEnd()</code>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">headersEnd</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> streamId<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> endOfStream<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Http2Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    AbstractNonZeroStream abstractNonZeroStream <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            getAbstractNonZeroStream<span style="color:#f92672">(</span>streamId<span style="color:#f92672">,</span> connectionState<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isNewStreamAllowed</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>abstractNonZeroStream <span style="color:#66d9ef">instanceof</span> Stream<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> processStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        setMaxProcessedStream<span style="color:#f92672">(</span>streamId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Stream stream <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Stream<span style="color:#f92672">)</span> abstractNonZeroStream<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stream<span style="color:#f92672">.</span><span style="color:#a6e22e">isActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stream<span style="color:#f92672">.</span><span style="color:#a6e22e">receivedEndOfHeaders</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>localSettings<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxConcurrentStreams</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> activeRemoteStreamCount<span style="color:#f92672">.</span><span style="color:#a6e22e">incrementAndGet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    decrementActiveRemoteStreamCount<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// Ignoring maxConcurrentStreams increases the overhead count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    increaseOverheadCount<span style="color:#f92672">(</span>FrameType<span style="color:#f92672">.</span><span style="color:#a6e22e">HEADERS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> StreamException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                            sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;upgradeHandler.tooManyRemoteStreams&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                                    Long<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">(</span>localSettings<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxConcurrentStreams</span><span style="color:#f92672">())),</span>
</span></span><span style="display:flex;"><span>                            Http2Error<span style="color:#f92672">.</span><span style="color:#a6e22e">REFUSED_STREAM</span><span style="color:#f92672">,</span> streamId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// Valid new stream reduces the overhead count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                reduceOverheadCount<span style="color:#f92672">(</span>FrameType<span style="color:#f92672">.</span><span style="color:#a6e22e">HEADERS</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                processStream <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tại line 11 ở câu điều kiện if sẽ gọi <code>activeRemoteStreamCount.incrementAndGet()</code> để tăng giá trị <code>activeRemoteStreamCount</code> lên += <code>1</code> đồng thời lấy số lượng stream đang active để so sánh</p>
<p>Sau khi đọc / xử lý xong Headers Frame này để trả về response sẽ gọi lại <code>Http2UpgradeHandler#sentEndOfStream()</code>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sentEndOfStream</span><span style="color:#f92672">(</span>Stream stream<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    stream<span style="color:#f92672">.</span><span style="color:#a6e22e">sentEndOfStream</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>stream<span style="color:#f92672">.</span><span style="color:#a6e22e">isActive</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        decrementActiveRemoteStreamCount<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Do stream không còn active (đã hoàn thành), gọi <code>decrementActiveRemoteStreamCount()</code>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">decrementActiveRemoteStreamCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    setConnectionTimeoutForStreamCount<span style="color:#f92672">(</span>activeRemoteStreamCount<span style="color:#f92672">.</span><span style="color:#a6e22e">decrementAndGet</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Từ đó sẽ <code>activeRemoteStreamCount</code> giảm -= <code>1</code></p>
<p>==&gt; Stream đã xử lý xong, loại stream khỏi active stream. <code>activeRemoteStreamCount</code> lúc này sẽ bằng <code>0</code>, connection được set timeout trừ khi client request nhiều Headers Frame khác từ đó sẽ còn stream để tiếp tục xử lý.
Ngoài <code>Http2UpgradeHandler#sentEndOfStream()</code> gọi đến <code>decrementActiveRemoteStreamCount()</code> thì các method sau cũng gọi đến để check và set timeout sau mỗi lần xử lý stream:</p>
<pre tabindex="0"><code>Http2AsyncUpgradeHandler:
    sendStreamReset
Http2UpgradeHandler:
    sendStreamReset
    sentEndOfStream
    receivedEndOfStream
    reset
    headersEnd
</code></pre><p>Có thể thấy các method này được gọi chủ yếu khi stream gặp lỗi / kết thúc stream</p>
<h2 id="break-the-logic">Break the logic</h2>
<p>Như đã đề cập, <code>activeRemoteStreamCount</code> được += <code>1</code> khi đọc xong header data và thực hiện <code>Http2UpgradeHandler#headersEnd()</code>, cùng xem lại method <a href="#headers-frame">readHeadersFrame</a></p>
<p>Vậy nếu ta có thể tìm cách trigger lỗi gì đó để khi tomcat đọc header mà không reach đến được <code>Http2UpgradeHandler#headersEnd()</code> -&gt; <code>activeRemoteStreamCount</code> vẫn bằng <code>0</code>. Tuy nhiên do lỗi mà tomcat phải end/reset stream mà gọi đến <code>decrementActiveRemoteStreamCount()</code> ==&gt; <code>activeRemoteStreamCount</code> là <code>-1</code> &ndash;&gt; <code>setConnectionTimeoutForStreamCount()</code> set timeout vô thời hạn.</p>
<p>Trong lúc test mình tình cờ phát hiện method <code>Http2Parser#readHeaderPayload()</code> (line 18) (tức ngay trước khi <code>headersEnd()</code> kết thúc frame):</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readHeaderPayload</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> streamId<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> payloadSize<span style="color:#f92672">,</span> ByteBuffer buffer<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throws</span> Http2Exception<span style="color:#f92672">,</span> IOException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... truncated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hpackDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">isHeaderSizeExceeded</span><span style="color:#f92672">(</span>headerReadBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            StreamException headerException <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StreamException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http2Parser.headerLimitSize&#34;</span><span style="color:#f92672">,</span> connectionId<span style="color:#f92672">,</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>streamId<span style="color:#f92672">)),</span>
</span></span><span style="display:flex;"><span>                    Http2Error<span style="color:#f92672">.</span><span style="color:#a6e22e">ENHANCE_YOUR_CALM</span><span style="color:#f92672">,</span> streamId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            hpackDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">getHeaderEmitter</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setHeaderException</span><span style="color:#f92672">(</span>headerException<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hpackDecoder<span style="color:#f92672">.</span><span style="color:#a6e22e">isHeaderSwallowSizeExceeded</span><span style="color:#f92672">(</span>headerReadBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">position</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ConnectionException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                    sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;http2Parser.headerLimitSize&#34;</span><span style="color:#f92672">,</span> connectionId<span style="color:#f92672">,</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>streamId<span style="color:#f92672">)),</span>
</span></span><span style="display:flex;"><span>                    Http2Error<span style="color:#f92672">.</span><span style="color:#a6e22e">ENHANCE_YOUR_CALM</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Nếu <code>isHeaderSizeExceeded()</code>  &ndash;&gt; set <code>StreamException</code> / Tuy nhiên không vào <code>isHeaderSwallowSizeExceeded()</code> để tránh <code>ConnectionException</code> - luồng chương trình sau method này sẽ rơi về catch block <code>StreamException</code> của <a href="#http2upgradehandlerupgradedispatch">Http2UpgradeHandler#upgradeDispatch()</a> (line 33-59) đầu bài</p>
<p>Đặc biệt tại line 57 sẽ gọi <code>stream.close(se)</code> để close stream, code:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">(</span>Http2Exception http2Exception<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>http2Exception <span style="color:#66d9ef">instanceof</span> StreamException<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            StreamException se <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>StreamException<span style="color:#f92672">)</span> http2Exception<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>log<span style="color:#f92672">.</span><span style="color:#a6e22e">isTraceEnabled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                log<span style="color:#f92672">.</span><span style="color:#a6e22e">trace</span><span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;stream.reset.send&#34;</span><span style="color:#f92672">,</span> getConnectionId<span style="color:#f92672">(),</span> getIdAsString<span style="color:#f92672">(),</span> se<span style="color:#f92672">.</span><span style="color:#a6e22e">getError</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            handler<span style="color:#f92672">.</span><span style="color:#a6e22e">sendStreamReset</span><span style="color:#f92672">(</span>state<span style="color:#f92672">,</span> se<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            cancelAllocationRequests<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>inputBuffer <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                inputBuffer<span style="color:#f92672">.</span><span style="color:#a6e22e">swallowUnread</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException ioe<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            ConnectionException ce <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">new</span> ConnectionException<span style="color:#f92672">(</span>sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;stream.reset.fail&#34;</span><span style="color:#f92672">,</span> getConnectionId<span style="color:#f92672">(),</span> getIdAsString<span style="color:#f92672">()),</span>
</span></span><span style="display:flex;"><span>                            Http2Error<span style="color:#f92672">.</span><span style="color:#a6e22e">PROTOCOL_ERROR</span><span style="color:#f92672">,</span> ioe<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            handler<span style="color:#f92672">.</span><span style="color:#a6e22e">closeConnection</span><span style="color:#f92672">(</span>ce<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        handler<span style="color:#f92672">.</span><span style="color:#a6e22e">closeConnection</span><span style="color:#f92672">(</span>http2Exception<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    recycle<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Tại method này lại thấy có gọi đến <code>sendStreamReset()</code>, một method mà mình đã đề cập ở trên sẽ gọi đến được <code>decrementActiveRemoteStreamCount()</code> ==&gt; Lúc này <code>activeRemoteStreamCount</code> sẽ giảm đi một và giá trị sẽ là <code>-1</code>. Ở đây cần né các exception gọi <code>closeConnection()</code> do nó sẽ không trigger được <code>decrementActiveRemoteStreamCount()</code>.</p>
<p>Luồng chương trình lúc này sẽ đi qua vài lần method <code>setConnectionTimeoutForStreamCount()</code> nữa nhưng với <code>activeRemoteStreamCount</code> là số âm (khác <code>0</code>) ==&gt; luôn set timeout vô hạn ==&gt; connection ở server không bị đóng và treo dù client đã send hết stream và drop connection.</p>
<h2 id="poc">PoC</h2>
<p>Để trigger <code>StreamExcetion</code> qua <code>isHeaderSizeExceeded()</code>, <code>headerSize</code> cần nằm trong khoảng <code>x</code> và <code>y</code>. Nếu <code>headerSize</code> quá <code>y</code> sẽ gây lỗi <code>ConnectionException</code> -&gt; fail. Phần còn lại người đọc có thể review code để ra số chính xác.</p>
<p>Default <code>maxConnections</code> được cấu hình trong <code>AbstractEndpoint</code> là <code>8*1024</code> ~ <code>8192</code>:
<img src="/images/2024/Analyzing-CVE-2024-34750-Tomcat-DoS/AbstractEndpoint_maxConnections.png" alt="AbstractEndpoint_maxConnections"></p>
<p>Do đó có thể DoS tomcat khi gửi đủ <code>8192</code> connections trigger <code>StreamExcetion</code>, mọi requests sau <code>8192</code> đều sẽ bị connection refused cho đến khi tomcat được restart lại. Ngoài ra nếu server cấu hình memory có giới hạn cũng sẽ gây lỗi <code>java.lang.OutOfMemoryError</code> và cũng gây ra DoS.</p>
<p><img src="/images/2024/Analyzing-CVE-2024-34750-Tomcat-DoS/poc_.png" alt="poc_"></p>
<h2 id="fix">Fix</h2>
<p>Bản fix sẽ tăng <code>activeRemoteStreamCount</code> khi <code>headersStart</code> thay vì <code>headersEnd</code>:
<img src="/images/2024/Analyzing-CVE-2024-34750-Tomcat-DoS/fix_increment.png" alt="fix_increment"></p>
<p>Thêm method <code>Stream#decrementAndGetActiveRemoteStreamCount()</code> để đảm bảo khi giảm <code>activeRemoteStreamCount</code>, mỗi stream chỉ giảm đúng 1 lần:
<img src="/images/2024/Analyzing-CVE-2024-34750-Tomcat-DoS/new_decrementAndGetActiveRemoteStreamCount.png" alt="new_decrementAndGetActiveRemoteStreamCount"></p>
<p>Chi tiết commit: <a href="https://github.com/apache/tomcat/commit/2344a4c0d03e307ba6b8ab6dc8b894cc8bac63f2">https://github.com/apache/tomcat/commit/2344a4c0d03e307ba6b8ab6dc8b894cc8bac63f2</a></p>
<h2 id="thoughts">Thoughts</h2>
<p>CVE này mình tìm ra khi đang reproduce lại <a href="https://hackerone.com/reports/2334401">CVE-2024-24549</a>, thanks for disclosure!
Lúc mới làm tomcat mình khá mới với codebase cho nên khi PoC được bug này mình cũng chưa thể hiểu hết được logic xử lý, sau khi xem lại commit fix của tomcat kết hợp dynamic debug thì mình mới hiểu sâu hơn về lỗ hổng này.</p>
<p>Cảm ơn vì đã đọc đến đây :)</p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Archives</a></li>
         
          <li><a href="/notes">Notes</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#setup">Setup</a></li>
    <li><a href="#analysis">Analysis</a>
      <ul>
        <li><a href="#http2upgradehandlerupgradedispatch">Http2UpgradeHandler#upgradeDispatch()</a></li>
        <li><a href="#headers-frame">Headers Frame</a></li>
      </ul>
    </li>
    <li><a href="#break-the-logic">Break the logic</a></li>
    <li><a href="#poc">PoC</a></li>
    <li><a href="#fix">Fix</a></li>
    <li><a href="#thoughts">Thoughts</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&text=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&title=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&is_video=false&description=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&title=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&title=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&name=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS&description=Preface%20B%c3%a0i%20vi%e1%ba%bft%20s%e1%ba%bd%20ph%c3%a2n%20t%c3%adch%20l%e1%ba%a1i%20CVE-2024-34750%2c%20CVE%20m%c3%a0%20m%c3%acnh%20t%c3%acm%20%c4%91%c6%b0%e1%bb%a3c%20g%e1%ba%a7n%20%c4%91%c3%a2y.%20V%e1%bb%81%20web%20server%20Tomcat%20ch%e1%ba%afc%20c%c5%a9ng%20kh%c3%b4ng%20c%c3%b2n%20ph%e1%ba%a3i%20gi%e1%bb%9bi%20thi%e1%bb%87u%20nhi%e1%bb%81u%2c%20trong%20c%c3%a1c%20%e1%bb%a9ng%20d%e1%bb%a5ng%20java%20web%20servlet%20hay%20spring%20framework%20th%c3%ac%20tomcat%20lu%c3%b4n%20l%c3%a0%20server%20%c4%91%c6%b0%e1%bb%a3c%20l%e1%bb%b1a%20ch%e1%bb%8dn%20%c4%91%e1%bb%83%20deploy%20ph%e1%bb%95%20bi%e1%ba%bfn%20nh%e1%ba%a5t%20cho%20%c4%91%e1%ba%bfn%20nay.%0aN%c3%b3i%20ng%e1%ba%afn%20g%e1%bb%8dn%2c%20CVE-2024-34750%20cho%20ph%c3%a9p%20DoS%20s%e1%ba%adp%20HTTP%2f2%20connector%20c%e1%bb%a7a%20tomcat%20b%e1%ba%b1ng%20c%c3%a1ch%20trigger%20l%e1%bb%97i%20StreamException%20l%c3%a0m%20gi%c3%a1%20tr%e1%bb%8b%20activeRemoteStreamCount%20b%e1%bb%8b%20%c4%91%e1%ba%bfm%20sai%20d%e1%ba%abn%20%c4%91%e1%ba%bfn%20connection%20timeout%20b%e1%bb%8b%20set%20v%c3%b4%20th%e1%bb%9di%20h%e1%ba%a1n%20%28connection%20kh%c3%b4ng%20%c4%91%c6%b0%e1%bb%a3c%20%c4%91%c3%b3ng%20sau%20khi%20x%e1%bb%ad%20l%c3%bd%20xong%29." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2024%2fanalyzing-cve-2024-34750-tomcat-dos%2f&t=Analyzing%20CVE-2024-34750%20Apache%20Tomcat%20DoS" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2025  devme4f&#39;s blog 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/notes">Notes</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
